<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizador Excel Pro v2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 font-sans h-screen flex flex-col">

    <header class="bg-white shadow-sm p-4 flex justify-between items-center z-10">
        <h1 class="text-xl font-bold text-gray-800"><i class="fas fa-chart-line text-blue-600 mr-2"></i>Data Analytics</h1>
        <div class="text-sm text-gray-500" id="fileStatus">Esperando archivo...</div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <aside class="w-80 bg-white border-r p-5 overflow-y-auto flex flex-col gap-6">
            
            <div class="p-4 border-2 border-dashed border-blue-200 rounded-lg bg-blue-50 text-center hover:bg-blue-100 transition cursor-pointer relative">
                <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"/>
                <i class="fas fa-cloud-upload-alt text-3xl text-blue-500 mb-2"></i>
                <p class="text-sm font-medium text-blue-700">Arrastra o Click para subir Excel</p>
            </div>

            <div id="controls" class="hidden flex-col gap-4">
                <div class="border-t pt-4">
                    <h3 class="font-bold text-gray-700 mb-3">Configurar Gráfico</h3>
                    
                    <div class="space-y-3">
                        <div>
                            <label class="text-xs font-semibold text-gray-500 uppercase">Eje X (Categoría/Fecha)</label>
                            <select id="xAxisSelect" class="w-full p-2 border rounded bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none"></select>
                        </div>

                        <div>
                            <label class="text-xs font-semibold text-gray-500 uppercase">Eje Y (Valor Numérico)</label>
                            <select id="yAxisSelect" class="w-full p-2 border rounded bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none"></select>
                        </div>

                        <div>
                            <label class="text-xs font-semibold text-gray-500 uppercase">Tipo de Visualización</label>
                            <div class="grid grid-cols-2 gap-2 mt-1">
                                <button onclick="selectType('bar')" class="type-btn active p-2 border rounded hover:bg-gray-100 text-center text-sm" data-type="bar"><i class="fas fa-chart-bar"></i> Barras</button>
                                <button onclick="selectType('line')" class="type-btn p-2 border rounded hover:bg-gray-100 text-center text-sm" data-type="line"><i class="fas fa-chart-area"></i> Línea</button>
                                <button onclick="selectType('pie')" class="type-btn p-2 border rounded hover:bg-gray-100 text-center text-sm" data-type="pie"><i class="fas fa-chart-pie"></i> Pastel</button>
                                <button onclick="selectType('doughnut')" class="type-btn p-2 border rounded hover:bg-gray-100 text-center text-sm" data-type="doughnut"><i class="fas fa-circle-notch"></i> Dona</button>
                            </div>
                            <input type="hidden" id="chartType" value="bar">
                        </div>
                    </div>
                </div>

                <div class="bg-yellow-50 p-3 rounded border border-yellow-200">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="groupDataCheck" checked class="w-4 h-4 text-blue-600 rounded">
                        <span class="text-sm font-medium text-gray-700">Agrupar datos repetidos</span>
                    </label>
                    <p class="text-xs text-gray-500 mt-1 ml-6">Si hay múltiples filas con la misma fecha/categoría, se sumarán sus valores.</p>
                </div>

                <button onclick="addDashboardWidget()" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded shadow-lg transition transform active:scale-95">
                    <i class="fas fa-plus-circle mr-2"></i> Crear Dashboard
                </button>
            </div>
        </aside>

        <main class="flex-1 bg-gray-100 p-8 overflow-y-auto">
            <div id="kpi-bar" class="hidden grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                </div>

            <div id="dashboardGrid" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div id="emptyState" class="col-span-full flex flex-col items-center justify-center h-64 text-gray-400 border-2 border-dashed border-gray-300 rounded-lg">
                    <i class="fas fa-chart-simple text-4xl mb-3"></i>
                    <p>Sube un archivo y configura tus parámetros para empezar</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        let rawData = [];
        let currentChartType = 'bar';

        // --- Manejo de Archivos ---
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('fileStatus').innerHTML = `<span class="text-blue-600 animate-pulse">Procesando ${file.name}...</span>`;
            
            const data = await file.arrayBuffer();
            const workbook = XLSX.read(data);
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            rawData = XLSX.utils.sheet_to_json(sheet);

            if (rawData.length > 0) {
                initApp(file.name);
            }
        });

        function initApp(filename) {
            document.getElementById('controls').classList.remove('hidden');
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('fileStatus').innerText = `Archivo: ${filename} (${rawData.length} filas)`;
            
            // Llenar Selectores
            const columns = Object.keys(rawData[0]);
            const xSelect = document.getElementById('xAxisSelect');
            const ySelect = document.getElementById('yAxisSelect');
            
            xSelect.innerHTML = ySelect.innerHTML = '';
            
            columns.forEach(col => {
                xSelect.innerHTML += `<option value="${col}">${col}</option>`;
                // Intentar detectar columnas numéricas para el eje Y por defecto
                const isNumber = typeof rawData[0][col] === 'number';
                ySelect.innerHTML += `<option value="${col}" ${isNumber ? 'selected' : ''}>${col}</option>`;
            });

            generateGlobalKPIs();
        }

        // --- Lógica de Agrupación (Pivot) ---
        function processData(xKey, yKey, shouldGroup) {
            if (!shouldGroup) {
                return {
                    labels: rawData.map(d => d[xKey]),
                    values: rawData.map(d => parseFloat(d[yKey]) || 0)
                };
            }

            // Agrupación (Pivot): Sumar valores si la llave X se repite
            const grouped = {};
            rawData.forEach(row => {
                const key = row[xKey];
                const val = parseFloat(row[yKey]) || 0;
                
                if (grouped[key]) {
                    grouped[key] += val;
                } else {
                    grouped[key] = val;
                }
            });

            return {
                labels: Object.keys(grouped),
                values: Object.values(grouped)
            };
        }

        // --- Generación de Gráficos ---
        function addDashboardWidget() {
            const xKey = document.getElementById('xAxisSelect').value;
            const yKey = document.getElementById('yAxisSelect').value;
            const shouldGroup = document.getElementById('groupDataCheck').checked;
            
            const data = processData(xKey, yKey, shouldGroup);
            
            // Crear elemento DOM
            const container = document.createElement('div');
            container.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 h-80 relative group hover:shadow-md transition";
            
            // Botón eliminar
            const btnDelete = document.createElement('button');
            btnDelete.innerHTML = '<i class="fas fa-times"></i>';
            btnDelete.className = "absolute top-2 right-2 text-gray-300 hover:text-red-500 p-1 opacity-0 group-hover:opacity-100 transition";
            btnDelete.onclick = () => container.remove();

            // Título
            const title = document.createElement('h4');
            title.className = "text-sm font-bold text-gray-600 mb-2";
            title.innerText = `${yKey} vs ${xKey} (${shouldGroup ? 'Agrupado' : 'Detallado'})`;

            const canvas = document.createElement('canvas');

            container.append(btnDelete, title, canvas);
            document.getElementById('dashboardGrid').prepend(container);

            // Generar Chart.js
            new Chart(canvas, {
                type: currentChartType,
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: yKey,
                        data: data.values,
                        backgroundColor: getColors(data.values.length),
                        borderColor: '#fff',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 12, font: {size: 10} } }
                    }
                }
            });
        }

        // --- Métricas Globales (KPIs) ---
        function generateGlobalKPIs() {
            // Ejemplo simple: conteo y búsqueda de la primera col numérica para sumar
            const kpiBar = document.getElementById('kpi-bar');
            kpiBar.classList.remove('hidden');
            kpiBar.innerHTML = '';

            // Card 1: Total Registros
            kpiBar.innerHTML += createKpiCard('Total Registros', rawData.length, 'blue');

            // Intentar buscar una columna de 'Ventas', 'Total', 'Precio' o genérica numérica
            const numKey = Object.keys(rawData[0]).find(k => typeof rawData[0][k] === 'number');
            if (numKey) {
                const total = rawData.reduce((sum, row) => sum + (parseFloat(row[numKey])||0), 0);
                const avg = total / rawData.length;
                
                kpiBar.innerHTML += createKpiCard(`Total ${numKey}`, total.toLocaleString(), 'green');
                kpiBar.innerHTML += createKpiCard(`Promedio ${numKey}`, avg.toFixed(2), 'purple');
            }
        }

        function createKpiCard(label, value, color) {
            const colors = {
                blue: 'border-blue-500 text-blue-600',
                green: 'border-green-500 text-green-600',
                purple: 'border-purple-500 text-purple-600'
            };
            return `
                <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 ${colors[color] || colors.blue}">
                    <p class="text-xs text-gray-500 uppercase font-semibold">${label}</p>
                    <p class="text-2xl font-bold text-gray-800">${value}</p>
                </div>
            `;
        }

        // --- Utilidades ---
        function selectType(type) {
            currentChartType = type;
            document.querySelectorAll('.type-btn').forEach(b => {
                b.classList.remove('bg-blue-50', 'text-blue-600', 'border-blue-200');
                if(b.dataset.type === type) b.classList.add('bg-blue-50', 'text-blue-600', 'border-blue-200');
            });
        }

        function getColors(count) {
            const palette = [
                'rgba(59, 130, 246, 0.7)', 'rgba(16, 185, 129, 0.7)', 'rgba(245, 158, 11, 0.7)', 
                'rgba(239, 68, 68, 0.7)', 'rgba(139, 92, 246, 0.7)', 'rgba(236, 72, 153, 0.7)'
            ];
            // Repetir paleta si hay muchos datos
            return Array(count).fill().map((_, i) => palette[i % palette.length]);
        }
    </script>
</body>
</html>
