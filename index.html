<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Workspace v16 - Comparador & Unificador</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS para Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Chart.js para Gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Iconos -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .tab-active { border-bottom: 3px solid #3b82f6; color: #1d4ed8; font-weight: bold; background-color: white;}
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        /* Efecto de carta giratoria */
        .flip-container { perspective: 1000px; }
        .flipper { transition: 0.6s; transform-style: preserve-3d; position: relative; height: 100%; width: 100%; }
        .front, .back { backface-visibility: hidden; position: absolute; top: 0; left: 0; right: 0; bottom: 0; }
        .front { z-index: 2; transform: rotateY(0deg); }
        .back { transform: rotateY(180deg); background: white; overflow: auto; }
        .flipped .flipper { transform: rotateY(180deg); }
    </style>
</head>
<body class="bg-slate-100 font-sans h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-gray-900 text-white p-4 shadow-lg flex justify-between items-center z-20">
        <h1 class="text-xl font-bold tracking-wider"><i class="fas fa-project-diagram text-blue-400 mr-2"></i> DATA<span class="font-light">MASTER</span></h1>
        <div class="flex gap-2 text-sm">
            <button id="tab1" class="px-4 py-2 rounded-t-lg tab-active transition" onclick="switchView(1)">1. Subir</button>
            <button id="tab2" class="px-4 py-2 rounded-t-lg text-slate-400 hover:text-white transition" onclick="switchView(2)" disabled>2. Fuentes</button>
            <button id="tab3" class="px-4 py-2 rounded-t-lg text-slate-400 hover:text-white transition" onclick="switchView(3)" disabled>3. Individual</button>
            <button id="tab4" class="px-4 py-2 rounded-t-lg text-emerald-400 hover:text-emerald-300 transition" onclick="switchView(4)" disabled><i class="fas fa-balance-scale mr-1"></i> 4. Comparar/Unir</button>
        </div>
    </header>

    <main class="flex-1 relative overflow-hidden">

        <!-- PASO 1: CARGA DE ARCHIVOS -->
        <div id="view-upload" class="absolute inset-0 flex flex-col items-center p-10 bg-slate-50 overflow-y-auto">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full max-w-5xl">
                <div class="bg-white p-10 rounded-2xl shadow border border-slate-200 text-center flex flex-col justify-center">
                    <i class="fas fa-file-excel text-6xl text-blue-500 mb-6"></i>
                    <h2 class="text-2xl font-bold text-slate-800 mb-2">Importar Datos</h2>
                    <p class="text-xs text-slate-500 mb-4">Sube uno o múltiples archivos Excel (.xlsx, .csv).</p>
                    <label class="cursor-pointer bg-blue-50 border-2 border-dashed border-blue-300 rounded-xl p-8 block hover:bg-blue-100 transition">
                        <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" multiple class="hidden"/>
                        <span class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold shadow-md hover:bg-blue-700 transition"><i class="fas fa-upload mr-2"></i> Explorar Archivos</span>
                    </label>
                    <div id="uploadStatus" class="mt-4 text-sm font-bold text-blue-600"></div>
                    <button id="btnNext1" onclick="switchView(2)" class="hidden mt-6 bg-slate-800 text-white px-6 py-3 rounded-full font-bold shadow-lg hover:bg-slate-700 transition mx-auto">
                        Siguiente Paso <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
                <div class="bg-white p-8 rounded-2xl shadow border border-slate-200 flex flex-col">
                    <h2 class="text-xl font-bold text-slate-800 mb-2"><i class="fas fa-cloud-download-alt text-blue-500 mr-2"></i> Base de Datos (Firebase)</h2>
                    <div id="cloudProjectsList" class="flex-1 overflow-y-auto space-y-3 bg-slate-50 p-4 rounded border mt-2 custom-scroll">
                        <div class="text-center text-slate-400 mt-10"><i class="fas fa-spinner fa-spin text-2xl mb-2"></i><br>Cargando...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PASO 2: DEFINIR FUENTES -->
        <div id="view-range" class="absolute inset-0 hidden flex bg-slate-50 overflow-hidden">
            <div class="w-80 bg-white border-r border-slate-200 flex flex-col p-4 z-10 shadow-lg">
                <h3 class="font-bold text-slate-800 mb-4"><i class="fas fa-database text-blue-500 mr-2"></i> Configurar Fuentes</h3>
                <label class="text-[11px] font-bold text-slate-500 uppercase mb-1">1. Archivo</label>
                <select id="fileSelector" class="w-full p-2 border rounded bg-slate-50 mb-4 text-xs font-bold outline-none" onchange="changeActiveFile()"></select>
                <label class="text-[11px] font-bold text-slate-500 uppercase mb-1">2. Hoja de Trabajo</label>
                <select id="sheetSelector" class="w-full p-2 border rounded bg-slate-50 mb-4 text-xs font-bold outline-none" onchange="renderRawPreview()"></select>
                <label class="text-[11px] font-bold text-slate-500 uppercase mb-1">3. Fila de Títulos</label>
                <input type="number" id="headerRow" value="1" min="1" class="w-full p-2 border rounded text-center font-bold outline-none mb-4">
                <button onclick="saveAsDataSource()" class="w-full bg-blue-600 text-white px-4 py-3 rounded font-bold shadow hover:bg-blue-700 flex justify-center items-center text-sm">
                    <i class="fas fa-save mr-2"></i> Guardar Fuente
                </button>
                <div class="mt-4 border-t pt-2 flex-1 overflow-y-auto">
                    <h4 class="text-[10px] font-bold text-slate-500 uppercase mb-2">Fuentes Listas:</h4>
                    <div id="processedSourcesList" class="space-y-1 text-sm custom-scroll"></div>
                </div>
                <div class="flex flex-col gap-2 mt-4">
                    <button onclick="switchView(3)" id="btnGoPlayground" disabled class="w-full bg-slate-800 text-white px-4 py-2 rounded font-bold opacity-50 text-sm disabled:cursor-not-allowed">Dashboard Individual</button>
                    <button onclick="switchView(4)" id="btnGoAudit" disabled class="w-full bg-emerald-600 text-white px-4 py-2 rounded font-bold opacity-50 text-sm disabled:cursor-not-allowed">Comparar y Unir</button>
                </div>
            </div>
            <div class="flex-1 p-6 flex flex-col bg-slate-100 relative">
                <h2 class="text-lg font-bold text-slate-800 mb-2">Vista Previa de Datos</h2>
                <div class="flex-1 overflow-auto border rounded relative bg-white shadow">
                    <table class="min-w-full text-xs text-left" id="rawTablePreview"></table>
                </div>
            </div>
        </div>

        <!-- PASO 3: DASHBOARD INDIVIDUAL (SIMPLE) -->
        <div id="view-playground" class="absolute inset-0 hidden flex bg-slate-200">
            <aside class="w-[400px] bg-white shadow-xl z-10 flex flex-col border-r border-slate-300">
                <div class="p-4 bg-slate-800 text-white flex justify-between items-center"><h3 class="font-bold"><i class="fas fa-chart-pie mr-2"></i> Métrica Individual</h3></div>
                <div class="p-4 overflow-y-auto flex-1 flex flex-col gap-4 custom-scroll">
                    <!-- Selector de Fuente -->
                    <div class="bg-indigo-50 border border-indigo-200 p-2 rounded-lg">
                        <label class="block text-[10px] font-bold text-indigo-900 uppercase">Fuente de Datos</label>
                        <select id="dsSelector" class="w-full p-1.5 border rounded outline-none text-xs font-bold bg-white" onchange="onDataSourceChange()"></select>
                    </div>
                    <!-- Configuración -->
                    <div class="bg-blue-50 p-3 rounded-lg border border-blue-200 flex flex-col gap-2">
                        <div><label class="block text-[10px] font-bold text-blue-900 uppercase">Título</label><input type="text" id="widgetTitle" class="w-full p-1.5 border rounded text-xs"></div>
                        <div><label class="block text-[10px] font-bold text-blue-900 uppercase">Agrupar Por (Eje X)</label><select id="axisX" class="w-full p-1.5 border rounded text-xs column-selector"></select></div>
                        <div class="grid grid-cols-2 gap-2">
                            <div><label class="block text-[10px] font-bold text-blue-900 uppercase">Cálculo</label><select id="aggType" class="w-full p-1.5 border rounded text-xs" onchange="togglePercentUI()"><option value="count">Contar</option><option value="sum">Sumar</option><option value="avg">Promedio</option><option value="percent">Porcentaje %</option></select></div>
                            <div><label class="block text-[10px] font-bold text-blue-900 uppercase">Columna Valor</label><select id="axisY" class="w-full p-1.5 border rounded text-xs column-selector" onchange="updatePercentTargets()"></select></div>
                        </div>
                        <div id="percentTargetUI" class="hidden bg-yellow-50 border p-2 rounded"><label class="block text-[10px] font-bold text-yellow-800 uppercase">Valor Éxito (Ej: SI, OK)</label><select id="percentTargetValue" class="w-full p-1.5 border rounded text-xs"></select></div>
                    </div>
                    <!-- Filtros -->
                    <div class="border rounded bg-white p-2">
                        <div class="flex justify-between items-center mb-1"><h4 class="text-[10px] font-bold text-slate-700">Filtros</h4><button onclick="addGlobalFilter()" class="text-[9px] bg-blue-100 text-blue-700 px-2 py-1 rounded">+ Añadir</button></div>
                        <div id="globalFiltersArea" class="flex flex-col gap-1 max-h-32 overflow-y-auto custom-scroll"></div>
                    </div>
                    <!-- Tipo Chart -->
                    <select id="selectedChartType" class="w-full p-2 border rounded text-xs"><option value="bar">Barras</option><option value="line">Líneas</option><option value="doughnut">Dona</option></select>
                    
                    <button onclick="buildWidget()" class="w-full bg-blue-600 text-white py-2 rounded font-bold shadow hover:bg-blue-700 text-sm">Generar Gráfico</button>
                </div>
            </aside>
            <main class="flex-1 p-6 overflow-y-auto bg-slate-200 relative">
                <button onclick="switchView(4)" class="absolute top-4 right-4 bg-emerald-600 text-white px-4 py-2 rounded-full font-bold shadow hover:bg-emerald-700 z-50 text-sm">Ir a Comparar <i class="fas fa-arrow-right ml-1"></i></button>
                <div id="widgetsGrid" class="grid grid-cols-1 xl:grid-cols-2 gap-6 mt-8 relative z-10"></div>
            </main>
        </div>

        <!-- PASO 4: COMPARADOR / UNIFICADOR (NUEVO DISEÑO) -->
        <div id="view-compare" class="absolute inset-0 hidden flex bg-slate-200">
            <aside class="w-[450px] bg-white shadow-xl z-10 flex flex-col border-r border-slate-300">
                <div class="p-4 bg-emerald-800 text-white flex justify-between items-center">
                    <h3 class="font-bold"><i class="fas fa-layer-group mr-2"></i> Estudio de Datos</h3>
                </div>
                
                <!-- 1. Configuración Global -->
                <div class="p-3 bg-emerald-50 border-b border-emerald-200 flex flex-col gap-3">
                    <!-- MODO DE OPERACIÓN -->
                    <div class="bg-white p-1 rounded border border-emerald-300 flex text-[11px] font-bold text-center">
                        <label class="flex-1 cursor-pointer">
                            <input type="radio" name="auditMode" value="merge" class="hidden peer" checked onchange="toggleAuditMode()">
                            <span class="block p-1.5 rounded peer-checked:bg-emerald-600 peer-checked:text-white text-emerald-800 hover:bg-emerald-50 transition"><i class="fas fa-link mr-1"></i> Unificar (Sumar Todo)</span>
                        </label>
                        <label class="flex-1 cursor-pointer">
                            <input type="radio" name="auditMode" value="compare" class="hidden peer" onchange="toggleAuditMode()">
                            <span class="block p-1.5 rounded peer-checked:bg-blue-600 peer-checked:text-white text-blue-800 hover:bg-blue-50 transition"><i class="fas fa-columns mr-1"></i> Comparar (Lado a Lado)</span>
                        </label>
                    </div>

                    <div>
                        <input type="text" id="auditTitle" placeholder="Título del Gráfico..." class="w-full p-1.5 border rounded text-xs font-bold outline-none">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-[9px] font-bold text-emerald-900 uppercase">Métrica</label>
                            <select id="auditAggType" class="w-full p-1.5 border rounded text-[10px] font-bold outline-none" onchange="buildAuditSidebar()">
                                <option value="percent">Porcentaje (%)</option>
                                <option value="sum">Sumatoria</option>
                                <option value="count">Contar Filas</option>
                                <option value="avg">Promedio</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-[9px] font-bold text-emerald-900 uppercase">Gráfico</label>
                            <select id="auditChartType" class="w-full p-1.5 border rounded text-[10px] font-bold outline-none">
                                <option value="bar">Barras</option>
                                <option value="doughnut">Dona</option>
                                <option value="line">Línea</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 2. Mapeo por Fuente (Dinámico) -->
                <div class="p-3 overflow-y-auto flex-1 flex flex-col gap-3 custom-scroll" id="auditMappingContainer"></div>
                
                <div class="p-3 bg-white border-t border-slate-200">
                    <button onclick="generateMergedAudit()" class="w-full bg-emerald-600 text-white py-3 rounded-lg font-bold shadow-lg hover:bg-emerald-500 transition text-sm flex justify-center items-center">
                        <i class="fas fa-bolt mr-2"></i> GENERAR RESULTADO
                    </button>
                </div>

                <!-- Guardado -->
                <div class="p-3 bg-slate-900 border-t border-slate-900">
                    <input type="text" id="projectName" placeholder="Nombre Proyecto..." class="w-full p-2 text-xs border-none rounded mb-2 bg-slate-700 text-white outline-none">
                    <button onclick="saveToFirebase()" id="btnSave" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-2 rounded font-bold text-xs">
                        Guardar en Nube
                    </button>
                </div>
            </aside>

            <!-- LIENZO DE RESULTADOS -->
            <main class="flex-1 p-6 overflow-y-auto relative bg-slate-100 flex flex-col">
                <div id="emptyAudit" class="absolute inset-0 flex flex-col items-center justify-center text-slate-400">
                    <i class="fas fa-cogs text-6xl mb-3 opacity-30"></i><p class="font-bold text-sm">Configura la comparación a la izquierda.</p>
                </div>
                <div id="auditWidgetsGrid" class="grid grid-cols-1 gap-6 relative z-10"></div>
            </main>
        </div>
    </main>

    <!-- LÓGICA COMPLETA -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, orderBy, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        // CONFIGURACIÓN FIREBASE
        const firebaseConfig = { apiKey: "AIzaSyCZXwXN15MYVpFP0-QbgR-H4bHqMH4_EFA", authDomain: "reporte-d37d1.firebaseapp.com", projectId: "reporte-d37d1", storageBucket: "reporte-d37d1.firebasestorage.app", messagingSenderId: "995600823465", appId: "1:995600823465:web:3ae9ede621cf0631ad65b8" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Variables Globales
        let rawWorkbooks = {}; 
        let processedDataSources = {}; 
        let currentFileId = null;
        let savedWidgetsConfig = []; 
        let savedAuditWidgetsConfig = [];

        // NAVEGACIÓN
        window.switchView = function(step) {
            ['view-upload','view-range','view-playground','view-compare'].forEach(v => document.getElementById(v).classList.add('hidden'));
            if(step===1) document.getElementById('view-upload').classList.remove('hidden');
            if(step===2) document.getElementById('view-range').classList.remove('hidden', 'flex');
            if(step===3) document.getElementById('view-playground').classList.remove('hidden', 'flex');
            if(step===4) {
                document.getElementById('view-compare').classList.remove('hidden', 'flex');
                if(Object.keys(processedDataSources).length > 0) buildAuditSidebar();
            }
            [1,2,3,4].forEach(n => {
                const btn = document.getElementById('tab'+n);
                if(n === step) { btn.classList.add('tab-active', 'text-slate-900'); btn.classList.remove('text-slate-400', 'text-emerald-400'); } 
                else { btn.classList.remove('tab-active', 'text-slate-900'); if(n === 4 && !btn.disabled) btn.classList.add('text-emerald-400'); else btn.classList.add('text-slate-400'); }
            });
        }

        // --- PASO 1 & 2: CARGA Y FUENTES ---
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const files = Array.from(e.target.files); if(files.length===0) return;
            document.getElementById('uploadStatus').innerHTML = 'Leyendo...';
            rawWorkbooks = {}; processedDataSources = {};
            for(let i=0; i<files.length; i++) {
                const data = await files[i].arrayBuffer();
                rawWorkbooks['file_'+i] = { name: files[i].name, workbook: XLSX.read(data) };
            }
            const fSel = document.getElementById('fileSelector'); fSel.innerHTML = '';
            Object.keys(rawWorkbooks).forEach(id => fSel.innerHTML += `<option value="${id}">${rawWorkbooks[id].name}</option>`);
            document.getElementById('btnNext1').classList.remove('hidden'); window.changeActiveFile(); document.getElementById('tab2').disabled = false;
        });

        window.changeActiveFile = function() {
            currentFileId = document.getElementById('fileSelector').value;
            const wb = rawWorkbooks[currentFileId].workbook;
            const sSel = document.getElementById('sheetSelector'); sSel.innerHTML = '';
            wb.SheetNames.forEach(s => sSel.innerHTML += `<option value="${s}">${s}</option>`);
            window.renderRawPreview();
        }

        window.renderRawPreview = function() {
            const wb = rawWorkbooks[currentFileId].workbook;
            const raw = XLSX.utils.sheet_to_json(wb.Sheets[document.getElementById('sheetSelector').value], {header:1, defval:""});
            const tbody = document.getElementById('rawTablePreview'); tbody.innerHTML = '';
            for(let i=0; i<Math.min(raw.length,10); i++) {
                tbody.innerHTML += `<tr><td class="p-1 border-r text-center bg-gray-100 text-xs">${i+1}</td>${raw[i].map(c=>`<td class="p-1 border-r truncate max-w-[100px] text-xs">${c}</td>`).join('')}</tr>`;
            }
        }

        window.saveAsDataSource = function() {
            const wb = rawWorkbooks[currentFileId].workbook; const sName = document.getElementById('sheetSelector').value;
            const hRow = parseInt(document.getElementById('headerRow').value)-1;
            const sheet = wb.Sheets[sName]; let range = XLSX.utils.decode_range(sheet['!ref']); range.s.r = Math.max(0, hRow);
            let data = XLSX.utils.sheet_to_json(sheet, {range: XLSX.utils.encode_range(range), defval:null});
            let clean = data.map(r => { let c={}; for(let k in r) if(!k.includes("__EMPTY")) c[k.trim()]=r[k]; return c; }).filter(r=>Object.keys(r).length>0);
            
            if(clean.length===0) return alert("Sin datos.");
            let id = 'ds_'+Date.now();
            processedDataSources[id] = { id: id, name: `${rawWorkbooks[currentFileId].name} (${sName})`, columns: Object.keys(clean[0]), data: clean };
            
            document.getElementById('processedSourcesList').innerHTML = Object.values(processedDataSources).map(d=>`<div class="p-1 bg-blue-50 border rounded text-[10px] text-blue-800 mb-1">${d.name}</div>`).join('');
            document.getElementById('btnGoPlayground').disabled=false; document.getElementById('btnGoPlayground').classList.remove('opacity-50');
            document.getElementById('btnGoAudit').disabled=false; document.getElementById('btnGoAudit').classList.remove('opacity-50');
            document.getElementById('tab3').disabled=false; document.getElementById('tab4').disabled=false;
            
            const dsSel = document.getElementById('dsSelector'); dsSel.innerHTML = '';
            Object.values(processedDataSources).forEach(d => dsSel.innerHTML += `<option value="${d.id}">${d.name}</option>`);
            window.onDataSourceChange();
        }

        // --- PASO 3: INDIVIDUAL (Lógica Básica) ---
        window.onDataSourceChange = function() {
            const id = document.getElementById('dsSelector').value; if(!id) return;
            const cols = processedDataSources[id].columns;
            document.querySelectorAll('.column-selector').forEach(s => { s.innerHTML = ''; cols.forEach(c => s.innerHTML+=`<option value="${c}">${c}</option>`); });
        }
        window.togglePercentUI = function() {
            const show = document.getElementById('aggType').value === 'percent';
            document.getElementById('percentTargetUI').classList.toggle('hidden', !show);
            if(show) window.updatePercentTargets();
        }
        window.updatePercentTargets = function() {
            const col = document.getElementById('axisY').value; const id = document.getElementById('dsSelector').value;
            let vals = new Set(); processedDataSources[id].data.forEach(r => { if(r[col]) vals.add(r[col].toString().trim()); });
            const s = document.getElementById('percentTargetValue'); s.innerHTML = '';
            Array.from(vals).sort().forEach(v => s.innerHTML+=`<option value="${v}">${v}</option>`);
        }
        window.addGlobalFilter = function() {
            const id = document.getElementById('dsSelector').value;
            const fId = 'gf_'+Date.now();
            const div = document.createElement('div'); div.className = "bg-white border p-1 text-xs relative mt-1";
            div.innerHTML = `<button onclick="this.parentElement.remove()" class="absolute top-0 right-0 text-red-500 font-bold px-1">x</button><select id="c_${fId}" class="w-full border mb-1 text-[10px]" onchange="renderCheckboxes('${fId}','${id}')"><option>Columna...</option>${processedDataSources[id].columns.map(c=>`<option value="${c}">${c}</option>`).join('')}</select><div id="k_${fId}" class="max-h-20 overflow-y-auto"></div>`;
            document.getElementById('globalFiltersArea').appendChild(div);
        }
        window.renderCheckboxes = function(fId, dsId) {
            const col = document.getElementById(`c_${fId}`).value; const box = document.getElementById(`k_${fId}`); box.innerHTML = '';
            let vals = new Set(); processedDataSources[dsId].data.forEach(r => { if(r[col]) vals.add(r[col].toString().trim()); });
            Array.from(vals).sort().forEach(v => box.innerHTML += `<label class="flex items-center gap-1 text-[10px]"><input type="checkbox" checked class="ck_${fId}" value="${v}">${v}</label>`);
        }
        window.buildWidget = function(cfg=null) {
            let config = cfg;
            if(!config) {
                let filters = [];
                document.querySelectorAll('[id^="c_gf_"]').forEach(s => {
                    if(s.value) {
                        let fid = s.id.split('_')[2];
                        let allowed = Array.from(document.querySelectorAll(`.ck_gf_${fid}:checked`)).map(c=>c.value);
                        filters.push({col: s.value, allowed: allowed});
                    }
                });
                config = {
                    title: document.getElementById('widgetTitle').value || 'Gráfico',
                    dsId: document.getElementById('dsSelector').value,
                    x: document.getElementById('axisX').value, y: document.getElementById('axisY').value,
                    agg: document.getElementById('aggType').value, target: document.getElementById('percentTargetValue').value,
                    type: document.getElementById('selectedChartType').value, filters: filters
                };
                savedWidgetsConfig.push(config);
            }
            const wid = 'w_'+Date.now()+Math.random();
            const grid = document.getElementById('widgetsGrid');
            grid.innerHTML += `<div class="bg-white p-4 rounded shadow h-80 relative"><button onclick="this.parentElement.remove()" class="absolute top-2 right-2 text-red-500">x</button><h3 class="text-xs font-bold mb-2">${config.title}</h3><div class="h-64"><canvas id="${wid}"></canvas></div></div>`;
            setTimeout(() => renderChart(config, wid, processedDataSources[config.dsId].data), 100);
        }
        function renderChart(cfg, id, data) {
            let fdata = data;
            if(cfg.filters) cfg.filters.forEach(f => fdata = fdata.filter(r => f.allowed.includes(r[f.col]?.toString().trim())));
            
            let groups = {};
            fdata.forEach(r => {
                let k = r[cfg.x] || '(Vacío)'; let v = parseFloat(r[cfg.y])||0; let raw = r[cfg.y]?.toString().trim().toLowerCase();
                if(!groups[k]) groups[k] = {sum:0, count:0, hits:0, valid:0};
                groups[k].count++;
                if(cfg.agg === 'percent') { if(raw === cfg.target?.toLowerCase()) groups[k].hits++; }
                else if(cfg.agg === 'count') { if(r[cfg.y]) groups[k].valid++; }
                else groups[k].sum += v;
            });

            let labels = Object.keys(groups);
            let vals = labels.map(l => {
                if(cfg.agg==='percent') return (groups[l].hits/groups[l].count)*100;
                if(cfg.agg==='count') return groups[l].valid;
                if(cfg.agg==='avg') return groups[l].sum/groups[l].count;
                return groups[l].sum;
            });

            new Chart(document.getElementById(id), {
                type: cfg.type,
                data: { labels: labels, datasets: [{ label: 'Valor', data: vals, backgroundColor: '#3b82f6', maxBarThickness: 50 }] },
                options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: cfg.agg==='percent'?100:undefined } } }
            });
        }

        // --- PASO 4: UNIFICACIÓN Y COMPARACIÓN (Lógica Avanzada) ---
        window.toggleAuditMode = function() { window.buildAuditSidebar(); } // Reconstruir al cambiar modo

        window.buildAuditSidebar = function() {
            const agg = document.getElementById('auditAggType').value;
            const container = document.getElementById('auditMappingContainer');
            container.innerHTML = '';
            
            Object.values(processedDataSources).forEach(ds => {
                let opts = `<option value="">-- Columna --</option>` + ds.columns.map(c => `<option value="${c}">${c}</option>`).join('');
                const div = document.createElement('div');
                div.className = "bg-white border rounded p-2 text-xs relative mb-2 shadow-sm";
                
                let html = `<div class="flex justify-between font-bold mb-1 text-emerald-800"><span>${ds.name}</span><input type="checkbox" id="inc_${ds.id}" checked></div>`;
                
                // Mapeo X (Agrupación común)
                html += `<div class="mb-1"><label class="text-[9px] text-slate-500 uppercase font-bold">Agrupar Por (Eje X)</label><select id="ax_${ds.id}" class="w-full border rounded p-1">${opts}</select></div>`;
                
                // Mapeo Y (Valor)
                if(agg === 'percent') {
                    html += `<div><label class="text-[9px] text-slate-500 uppercase font-bold">Evaluar Columna</label><select id="ay_${ds.id}" class="w-full border rounded p-1" onchange="fillVal('${ds.id}')">${opts}</select></div>`;
                    html += `<div class="mt-1"><label class="text-[9px] text-yellow-600 uppercase font-bold">Valor Éxito</label><select id="av_${ds.id}" class="w-full border rounded p-1" disabled></select></div>`;
                } else {
                    html += `<div><label class="text-[9px] text-slate-500 uppercase font-bold">Columna Valor</label><select id="ay_${ds.id}" class="w-full border rounded p-1">${opts}</select></div>`;
                }

                // Filtros Locales
                html += `<div class="mt-2 pt-1 border-t"><div class="flex justify-between"><span class="text-[9px] font-bold">Filtros Locales</span><button onclick="addAuditFilter('${ds.id}')" class="bg-slate-100 px-1 rounded">+</button></div><div id="af_${ds.id}" class="mt-1"></div></div>`;

                div.innerHTML = html;
                container.appendChild(div);
            });
        }

        window.fillVal = function(id) {
            const col = document.getElementById(`ay_${id}`).value;
            const sel = document.getElementById(`av_${id}`);
            if(!col) { sel.disabled=true; return; }
            let vals = new Set(); processedDataSources[id].data.forEach(r => { if(r[col]) vals.add(r[col].toString().trim()); });
            sel.innerHTML = ''; Array.from(vals).sort().forEach(v => sel.innerHTML+=`<option value="${v}">${v}</option>`);
            sel.disabled = false;
        }

        window.addAuditFilter = function(dsId) {
            const fid = 'af_'+Date.now()+Math.random();
            const div = document.createElement('div'); div.className = "flex gap-1 mt-1";
            div.innerHTML = `<select id="ac_${fid}" class="w-1/2 border text-[9px]" onchange="fillAC('${fid}','${dsId}')"><option>Col...</option>${processedDataSources[dsId].columns.map(c=>`<option>${c}</option>`)}</select><div id="ak_${fid}" class="w-1/2 max-h-12 overflow-y-auto border bg-slate-50 text-[9px]"></div><button onclick="this.parentElement.remove()" class="text-red-500">x</button>`;
            document.getElementById(`af_${dsId}`).appendChild(div);
        }
        window.fillAC = function(fid, dsId) {
            const col = document.getElementById(`ac_${fid}`).value; const box = document.getElementById(`ak_${fid}`); box.innerHTML = '';
            let vals = new Set(); processedDataSources[dsId].data.forEach(r => { if(r[col]) vals.add(r[col].toString().trim()); });
            Array.from(vals).forEach(v => box.innerHTML+=`<label class="block"><input type="checkbox" class="ack_${fid}" value="${v}" checked> ${v}</label>`);
        }

        window.generateMergedAudit = function(cfg=null) {
            document.getElementById('emptyAudit').classList.add('hidden');
            let config = cfg;
            
            if(!config) {
                const mode = document.querySelector('input[name="auditMode"]:checked').value;
                const agg = document.getElementById('auditAggType').value;
                const chartType = document.getElementById('auditChartType').value;
                let mappings = [];

                Object.values(processedDataSources).forEach(ds => {
                    if(document.getElementById(`inc_${ds.id}`).checked) {
                        // Recolectar filtros
                        let filters = [];
                        const fDiv = document.getElementById(`af_${ds.id}`);
                        if(fDiv) {
                            fDiv.querySelectorAll('[id^="ac_af_"]').forEach(s => {
                                if(s.value && s.value !== 'Col...') {
                                    let fid = s.id.split('_')[2];
                                    let allowed = Array.from(document.querySelectorAll(`.ack_af_${fid}:checked`)).map(c=>c.value);
                                    filters.push({col: s.value, allowed: allowed});
                                }
                            });
                        }

                        mappings.push({
                            dsId: ds.id, name: ds.name,
                            x: document.getElementById(`ax_${ds.id}`).value,
                            y: document.getElementById(`ay_${ds.id}`).value,
                            target: agg==='percent' ? document.getElementById(`av_${ds.id}`).value : null,
                            filters: filters
                        });
                    }
                });

                if(mappings.length === 0) return alert("Selecciona al menos una fuente.");

                config = {
                    title: document.getElementById('auditTitle').value || 'Gráfico Unificado',
                    mode: mode, agg: agg, type: chartType, mappings: mappings
                };
                savedAuditWidgetsConfig.push(config);
            }

            const wid = 'aw_'+Date.now()+Math.random();
            const grid = document.getElementById('auditWidgetsGrid');
            const card = document.createElement('div');
            card.className = "flip-container h-[400px] w-full bg-transparent perspective-1000";
            card.innerHTML = `<div class="flipper rounded-2xl shadow-lg border bg-white" id="f_${wid}"><div class="front p-4 flex flex-col bg-white rounded-2xl"><div class="flex justify-between items-start mb-2 border-b pb-2"><h3 class="font-bold text-sm text-emerald-900">${config.title} <span class="text-xs text-gray-400">(${config.mode==='merge'?'Unificado':'Comparado'})</span></h3><div class="flex gap-1"><button onclick="document.getElementById('f_${wid}').parentNode.classList.toggle('flipped')" class="text-slate-400 p-1"><i class="fas fa-table"></i></button><button onclick="this.closest('.flip-container').remove()" class="text-red-400 p-1"><i class="fas fa-trash"></i></button></div></div><div class="flex-1 relative"><canvas id="${wid}"></canvas></div></div><div class="back p-4 flex flex-col bg-slate-50 rounded-2xl border-2 border-emerald-400 overflow-auto"><div class="flex justify-between mb-2"><h3 class="font-bold text-xs">Datos</h3><button onclick="document.getElementById('f_${wid}').parentNode.classList.toggle('flipped')" class="text-xs font-bold">Volver</button></div><div id="tb_${wid}"></div></div></div>`;
            grid.appendChild(card);
            
            setTimeout(() => renderUnifiedChart(config, wid), 100);
        }

        function renderUnifiedChart(cfg, id) {
            let globalLabels = new Set();
            let datasets = [];
            let tableData = {}; // { Label: { SourceA: Val, SourceB: Val, Total: Val } }

            // Procesar cada fuente
            cfg.mappings.forEach((map, index) => {
                let data = processedDataSources[map.dsId].data;
                // Filtrar
                if(map.filters) map.filters.forEach(f => data = data.filter(r => f.allowed.includes(r[f.col]?.toString().trim())));

                // Agrupar Localmente
                let localGroups = {};
                data.forEach(r => {
                    let k = r[map.x] ? r[map.x].toString().trim() : map.name; // Si no hay eje X, usa nombre archivo
                    globalLabels.add(k);
                    
                    if(!localGroups[k]) localGroups[k] = {sum:0, count:0, hits:0, valid:0};
                    localGroups[k].count++;
                    
                    let val = parseFloat(r[map.y]) || 0;
                    let raw = r[map.y]?.toString().trim().toLowerCase();

                    if(cfg.agg === 'percent') {
                        if(raw === map.target?.toLowerCase()) localGroups[k].hits++;
                    } else if(cfg.agg === 'count') {
                        if(r[map.y]) localGroups[k].valid++;
                    } else {
                        localGroups[k].sum += val;
                    }
                });

                // Calcular Valor Final Local
                Object.keys(localGroups).forEach(k => {
                    let res = 0;
                    if(cfg.agg === 'percent') res = (localGroups[k].hits / localGroups[k].count) * 100;
                    else if(cfg.agg === 'count') res = localGroups[k].valid;
                    else if(cfg.agg === 'avg') res = localGroups[k].sum / localGroups[k].count;
                    else res = localGroups[k].sum; // sum

                    // Guardar para tabla y gráfico
                    if(!tableData[k]) tableData[k] = {};
                    tableData[k][map.name] = res;
                });
            });

            let labels = Array.from(globalLabels).sort();
            
            if(cfg.mode === 'compare') {
                // MODO COMPARAR: Un dataset por archivo
                cfg.mappings.forEach((map, i) => {
                    let dsData = labels.map(l => tableData[l][map.name] || 0);
                    let color = ['#3b82f6','#10b981','#f59e0b','#ef4444'][i%4];
                    datasets.push({ label: map.name, data: dsData, backgroundColor: color, maxBarThickness: 40 });
                });
            } else {
                // MODO UNIFICAR: Un dataset sumando/promediando todo
                // Nota: Para porcentajes globales reales, necesitaríamos sumar numeradores y denominadores globales.
                // Aquí haremos un promedio ponderado simplificado o suma directa según métrica.
                // Para simplificar UX visual, sumamos los resultados procesados (útil para counts/sums).
                // Para porcentajes, lo ideal es recalcular desde cero, pero aquí promediaremos los resultados locales por ahora.
                let dsData = labels.map(l => {
                    let total = 0; let count = 0;
                    Object.values(tableData[l] || {}).forEach(v => { total += v; count++; });
                    if(cfg.agg === 'percent' || cfg.agg === 'avg') return count > 0 ? total/count : 0;
                    return total;
                });
                datasets.push({ label: 'Total Unificado', data: dsData, backgroundColor: '#10b981', maxBarThickness: 50 });
            }

            // Construir Tabla HTML
            let th = `<table class="w-full text-xs text-left"><thead class="bg-gray-100"><tr><th class="p-1">Categoría</th>${cfg.mappings.map(m=>`<th class="p-1">${m.name}</th>`).join('')}</tr></thead><tbody>`;
            labels.forEach(l => {
                th += `<tr><td class="p-1 border-b font-bold">${l}</td>${cfg.mappings.map(m=>`<td class="p-1 border-b">${(tableData[l][m.name]||0).toFixed(1)}</td>`).join('')}</tr>`;
            });
            th += '</tbody></table>';
            document.getElementById(`tb_${id}`).innerHTML = th;

            // Renderizar Gráfico
            new Chart(document.getElementById(id), {
                type: cfg.type,
                data: { labels: labels, datasets: datasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, max: cfg.agg==='percent'?100:undefined } }
                }
            });
        }

        // GUARDAR TODO
        window.saveToFirebase = async function() {
            const btn = document.getElementById('btnSave'); btn.innerText = 'Guardando...'; btn.disabled = true;
            try {
                await addDoc(collection(db, "reportes_v16"), {
                    nombre: document.getElementById('projectName').value || 'Reporte V16',
                    date: serverTimestamp(),
                    sources: JSON.stringify(processedDataSources),
                    widgetsLocal: savedWidgetsConfig,
                    widgetsGlobal: savedAuditWidgetsConfig
                });
                alert("Guardado Correctamente");
            } catch(e) { console.error(e); alert("Error al guardar"); }
            btn.innerText = 'Guardar en Nube'; btn.disabled = false;
        }

        // CARGAR (Simplificado)
        async function loadProjs() {
            const q = query(collection(db, "reportes_v16"), orderBy("date", "desc"));
            const snaps = await getDocs(q);
            const list = document.getElementById('cloudProjectsList'); list.innerHTML = '';
            snaps.forEach(doc => {
                const d = doc.data();
                const b = document.createElement('button'); b.className = "w-full text-left p-2 border rounded mb-1 text-xs hover:bg-gray-50";
                b.innerText = d.nombre;
                b.onclick = () => {
                    processedDataSources = JSON.parse(d.sources);
                    savedWidgetsConfig = d.widgetsLocal || [];
                    savedAuditWidgetsConfig = d.widgetsGlobal || [];
                    document.getElementById('processedSourcesList').innerHTML = Object.values(processedDataSources).map(x=>`<div class="p-1 border rounded mb-1 text-[10px]">${x.name}</div>`).join('');
                    
                    // Restaurar Selectores
                    const dsSel = document.getElementById('dsSelector'); dsSel.innerHTML = '';
                    Object.values(processedDataSources).forEach(dx => dsSel.innerHTML += `<option value="${dx.id}">${dx.name}</option>`);
                    
                    // Restaurar Widgets
                    document.getElementById('widgetsGrid').innerHTML = '';
                    savedWidgetsConfig.forEach(c => window.buildWidget(c));
                    
                    document.getElementById('auditWidgetsGrid').innerHTML = '';
                    savedAuditWidgetsConfig.forEach(c => window.generateMergedAudit(c));
                    
                    document.getElementById('btnGoPlayground').disabled=false; document.getElementById('btnGoPlayground').classList.remove('opacity-50');
                    document.getElementById('btnGoAudit').disabled=false; document.getElementById('btnGoAudit').classList.remove('opacity-50');
                    document.getElementById('tab3').disabled=false; document.getElementById('tab4').disabled=false;
                    window.switchView(4);
                };
                list.appendChild(b);
            });
        }
        loadProjs();

    </script>
</body>
</html>
