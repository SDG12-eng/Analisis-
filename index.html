<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Data Workspace v14 - Ultimate Unification</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .tab-active { border-bottom: 3px solid #3b82f6; color: #1d4ed8; font-weight: bold; background-color: white;}
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .flip-container { perspective: 1000px; }
        .flipper { transition: 0.6s; transform-style: preserve-3d; position: relative; height: 100%; width: 100%; }
        .front, .back { backface-visibility: hidden; position: absolute; top: 0; left: 0; right: 0; bottom: 0; }
        .front { z-index: 2; transform: rotateY(0deg); }
        .back { transform: rotateY(180deg); background: white; overflow: auto; }
        .flipped .flipper { transform: rotateY(180deg); }
    </style>
</head>
<body class="bg-slate-100 font-sans h-screen flex flex-col overflow-hidden">

    <header class="bg-gray-900 text-white p-4 shadow-lg flex justify-between items-center z-20">
        <h1 class="text-xl font-bold tracking-wider"><i class="fas fa-layer-group text-blue-400 mr-2"></i> MULTI<span class="font-light">WORKSPACE</span></h1>
        <div class="flex gap-2 text-sm">
            <button id="tab1" class="px-4 py-2 rounded-t-lg tab-active transition" onclick="switchView(1)">1. Subir</button>
            <button id="tab2" class="px-4 py-2 rounded-t-lg text-slate-400 hover:text-white transition" onclick="switchView(2)" disabled>2. Fuentes</button>
            <button id="tab3" class="px-4 py-2 rounded-t-lg text-slate-400 hover:text-white transition" onclick="switchView(3)" disabled>3. Dashboard Local</button>
            <button id="tab4" class="px-4 py-2 rounded-t-lg text-emerald-400 hover:text-emerald-300 transition" onclick="switchView(4)" disabled><i class="fas fa-link mr-1"></i> 4. Unir Datos</button>
        </div>
    </header>

    <main class="flex-1 relative overflow-hidden">

        <div id="view-upload" class="absolute inset-0 flex flex-col items-center p-10 bg-slate-50 overflow-y-auto">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full max-w-5xl">
                <div class="bg-white p-10 rounded-2xl shadow border border-slate-200 text-center flex flex-col justify-center">
                    <i class="fas fa-file-excel text-6xl text-blue-500 mb-6"></i>
                    <h2 class="text-2xl font-bold text-slate-800 mb-2">Subir Excels</h2>
                    <label class="cursor-pointer bg-blue-50 border-2 border-dashed border-blue-300 rounded-xl p-8 block hover:bg-blue-100 transition mt-4">
                        <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" multiple class="hidden"/>
                        <span class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold shadow-md hover:bg-blue-700 transition"><i class="fas fa-upload mr-2"></i> Seleccionar Archivos</span>
                    </label>
                    <div id="uploadStatus" class="mt-4 text-sm font-bold text-blue-600"></div>
                    <button id="btnNext1" onclick="switchView(2)" class="hidden mt-6 bg-slate-800 text-white px-6 py-3 rounded-full font-bold shadow-lg hover:bg-slate-700 transition mx-auto">
                        Continuar a Fuentes <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
                <div class="bg-white p-8 rounded-2xl shadow border border-slate-200 flex flex-col">
                    <h2 class="text-xl font-bold text-slate-800 mb-2"><i class="fas fa-cloud-download-alt text-blue-500 mr-2"></i> Proyectos en Nube</h2>
                    <div id="cloudProjectsList" class="flex-1 overflow-y-auto space-y-3 bg-slate-50 p-4 rounded border mt-2 custom-scroll">
                        <div class="text-center text-slate-400 mt-10"><i class="fas fa-spinner fa-spin text-2xl mb-2"></i><br>Cargando Firebase...</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-range" class="absolute inset-0 hidden flex bg-slate-50 overflow-hidden">
            <div class="w-80 bg-white border-r border-slate-200 flex flex-col p-4 z-10 shadow-lg">
                <h3 class="font-bold text-slate-800 mb-4"><i class="fas fa-database text-blue-500 mr-2"></i> Crear Fuentes</h3>
                <label class="text-[11px] font-bold text-slate-500 uppercase mb-1">1. Archivo Subido</label>
                <select id="fileSelector" class="w-full p-2 border rounded bg-slate-50 mb-4 text-sm" onchange="changeActiveFile()"></select>
                <label class="text-[11px] font-bold text-slate-500 uppercase mb-1">2. Hoja</label>
                <select id="sheetSelector" class="w-full p-2 border rounded bg-slate-50 mb-4 text-sm" onchange="renderRawPreview()"></select>
                <label class="text-[11px] font-bold text-slate-500 uppercase mb-1">3. Fila de Encabezados</label>
                <input type="number" id="headerRow" value="1" min="1" class="w-full p-2 border rounded text-center mb-4">
                <button onclick="saveAsDataSource()" class="w-full bg-blue-600 text-white px-4 py-3 rounded font-bold shadow hover:bg-blue-700 flex justify-center items-center">
                    <i class="fas fa-plus mr-2"></i> Guardar como Fuente
                </button>
                <div class="mt-4 border-t pt-2 flex-1 overflow-y-auto">
                    <h4 class="text-[10px] font-bold text-slate-500 uppercase mb-2">Fuentes Listas:</h4>
                    <div id="processedSourcesList" class="space-y-1 text-sm custom-scroll"></div>
                </div>
                <div class="flex flex-col gap-2 mt-4">
                    <button onclick="switchView(3)" id="btnGoPlayground" disabled class="w-full bg-slate-800 text-white px-4 py-2 rounded font-bold opacity-50 text-sm">Dashboard Local <i class="fas fa-chart-pie ml-1"></i></button>
                    <button onclick="switchView(4)" id="btnGoAudit" disabled class="w-full bg-emerald-600 text-white px-4 py-2 rounded font-bold opacity-50 text-sm">Unir Datos <i class="fas fa-link ml-1"></i></button>
                </div>
            </div>
            <div class="flex-1 p-6 flex flex-col bg-slate-100 relative">
                <h2 class="text-lg font-bold text-slate-800 mb-2">Previsualizaci√≥n Cruda</h2>
                <div class="flex-1 overflow-auto border rounded relative bg-white shadow">
                    <table class="min-w-full text-xs text-left" id="rawTablePreview"></table>
                </div>
            </div>
        </div>

        <div id="view-playground" class="absolute inset-0 hidden flex bg-slate-200">
            <aside class="w-[420px] bg-white shadow-xl z-10 flex flex-col border-r border-slate-300">
                <div class="p-4 bg-slate-800 text-white flex justify-between items-center"><h3 class="font-bold"><i class="fas fa-chart-pie mr-2"></i> M√©tricas Locales</h3></div>
                <div class="p-4 overflow-y-auto flex-1 flex flex-col gap-4 custom-scroll">
                    <div class="bg-indigo-50 border border-indigo-200 p-2 rounded-lg"><label class="block text-[11px] font-bold text-indigo-900 uppercase">1. Fuente de Datos</label><select id="dsSelector" class="w-full p-1.5 border rounded outline-none text-sm font-bold bg-white" onchange="onDataSourceChange()"></select></div>
                    <div class="bg-blue-50 p-3 rounded-lg border border-blue-200 flex flex-col gap-2 shadow-inner">
                        <div><label class="block text-[10px] font-bold text-blue-900 uppercase">Nombre del Gr√°fico</label><input type="text" id="widgetTitle" class="w-full p-1.5 border rounded"></div>
                        <div><label class="block text-[10px] font-bold text-blue-900 uppercase">Agrupar Por (Eje X)</label><select id="axisX" class="w-full p-1.5 border rounded column-selector"></select></div>
                        <div class="grid grid-cols-2 gap-2 border-t pt-2">
                            <div><label class="block text-[10px] font-bold text-blue-900 uppercase">C√°lculo</label><select id="aggType" class="w-full p-1.5 border rounded" onchange="togglePercentUI()"><option value="count">Contar</option><option value="sum">Sumar</option><option value="avg">Promedio</option><option value="percent">Porcentaje (%)</option></select></div>
                            <div><label class="block text-[10px] font-bold text-blue-900 uppercase">Eje Y</label><select id="axisY" class="w-full p-1.5 border rounded column-selector" onchange="updatePercentTargets()"></select></div>
                        </div>
                        <div id="percentTargetUI" class="hidden bg-yellow-50 border p-2 rounded"><label class="block text-[10px] font-bold text-yellow-800 uppercase">¬øQu√© es el √âxito?</label><select id="percentTargetValue" class="w-full p-1.5 border rounded"></select></div>
                    </div>
                    <div class="border border-slate-300 rounded-lg bg-white shadow-sm">
                        <div class="bg-slate-100 p-2 border-b rounded-t-lg flex justify-between items-center"><h4 class="text-[11px] font-bold text-slate-700 uppercase"><i class="fas fa-filter mr-1"></i> Filtros (Acumulables)</h4><button onclick="addGlobalFilter()" class="text-[10px] bg-blue-100 text-blue-700 px-2 py-1 rounded font-bold hover:bg-blue-200">+ A√±adir Filtro</button></div>
                        <div id="globalFiltersArea" class="p-2 flex flex-col gap-2 max-h-40 overflow-y-auto custom-scroll"></div>
                    </div>
                    <div>
                        <div class="grid grid-cols-4 gap-1 text-center text-[10px] font-bold">
                            <button onclick="selectChartType('column')" class="chart-btn p-2 border rounded bg-blue-100" data-type="column"><i class="fas fa-chart-bar text-lg text-blue-600 block"></i>Columna</button>
                            <button onclick="selectChartType('bar')" class="chart-btn p-2 border rounded hover:bg-slate-100" data-type="bar"><i class="fas fa-align-left text-lg text-blue-600 block"></i>Barra</button>
                            <button onclick="selectChartType('line')" class="chart-btn p-2 border rounded hover:bg-slate-100" data-type="line"><i class="fas fa-chart-line text-lg text-green-600 block"></i>L√≠nea</button>
                            <button onclick="selectChartType('doughnut')" class="chart-btn p-2 border rounded hover:bg-slate-100" data-type="doughnut"><i class="fas fa-circle-notch text-lg text-orange-500 block"></i>Dona</button>
                        </div><input type="hidden" id="selectedChartType" value="column">
                    </div>
                    <button onclick="buildWidget()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold shadow-lg hover:bg-blue-700 mt-2"><i class="fas fa-play mr-2"></i> Generar M√©trica Local</button>
                </div>
            </aside>
            <main class="flex-1 p-8 overflow-y-auto bg-slate-200 relative">
                <button onclick="switchView(4)" class="absolute top-4 right-8 bg-emerald-600 text-white px-6 py-2 rounded-full font-bold shadow-lg hover:bg-emerald-700 transition z-50">Ir a Unir Datos <i class="fas fa-arrow-right ml-2"></i></button>
                <div id="widgetsGrid" class="grid grid-cols-1 xl:grid-cols-2 gap-8 relative z-10 mt-10"></div>
            </main>
        </div>

        <div id="view-compare" class="absolute inset-0 hidden flex bg-slate-200">
            <aside class="w-[450px] bg-white shadow-xl z-10 flex flex-col border-r border-slate-300">
                <div class="p-4 bg-emerald-800 text-white flex justify-between items-center">
                    <h3 class="font-bold"><i class="fas fa-link mr-2"></i> Unificaci√≥n de Datos</h3>
                </div>
                
                <div class="p-3 bg-emerald-50 border-b border-emerald-200 flex flex-col gap-2">
                    <div>
                        <label class="block text-[10px] font-bold text-emerald-900 uppercase">Nombre M√©trica Unificada</label>
                        <input type="text" id="auditTitle" placeholder="Ej: Avance General, Total Ventas..." class="w-full p-1.5 border rounded text-xs outline-none">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-[10px] font-bold text-emerald-900 uppercase">Tipo de C√°lculo</label>
                            <select id="auditAggType" class="w-full p-1.5 border rounded text-[11px] font-bold outline-none text-emerald-800" onchange="buildAuditSidebar()">
                                <option value="percent">Porcentaje (%)</option>
                                <option value="sum">Sumatoria</option>
                                <option value="count">Contar Filas</option>
                                <option value="avg">Promedio</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-emerald-900 uppercase">Visualizaci√≥n</label>
                            <select id="auditChartType" class="w-full p-1.5 border rounded text-[11px] font-bold outline-none">
                                <option value="bar">Gr√°fico de Barras</option>
                                <option value="doughnut">Gr√°fico de Dona</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="p-4 overflow-y-auto flex-1 flex flex-col gap-3 custom-scroll" id="auditMappingContainer">
                    </div>
                
                <div class="p-3 bg-white border-t border-slate-200">
                    <button onclick="generateMergedAudit()" class="w-full bg-emerald-600 text-white py-3 rounded-xl font-black shadow-lg hover:bg-emerald-500 transition border-b-4 border-emerald-900 text-sm">
                        <i class="fas fa-object-group mr-2"></i> GENERAR M√âTRICA UNIFICADA
                    </button>
                </div>

                <div class="p-4 bg-slate-900 border-t border-slate-900">
                    <input type="text" id="projectName" placeholder="Nombre Final del Proyecto Nube..." class="w-full p-2 text-sm border-none rounded mb-2 bg-slate-700 text-white outline-none">
                    <button onclick="saveToFirebase()" id="btnSave" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-2 rounded font-bold transition flex justify-center items-center">
                        <i class="fas fa-cloud-upload-alt mr-2"></i> Guardar Todo en Nube
                    </button>
                </div>
            </aside>

            <main class="flex-1 p-8 overflow-y-auto relative bg-slate-100 flex flex-col">
                <div id="emptyAudit" class="absolute inset-0 flex flex-col items-center justify-center text-slate-400">
                    <i class="fas fa-link text-6xl mb-3 opacity-50"></i><p class="font-bold">Crea m√∫ltiples m√©tricas consolidadas en el panel izquierdo.</p>
                </div>
                <div id="auditWidgetsGrid" class="grid grid-cols-1 xl:grid-cols-2 gap-8 relative z-10"></div>
            </main>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, orderBy, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCZXwXN15MYVpFP0-QbgR-H4bHqMH4_EFA", authDomain: "reporte-d37d1.firebaseapp.com", projectId: "reporte-d37d1", storageBucket: "reporte-d37d1.firebasestorage.app", messagingSenderId: "995600823465", appId: "1:995600823465:web:3ae9ede621cf0631ad65b8" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let rawWorkbooks = {}; let processedDataSources = {}; let currentFileId = null;
        let savedWidgetsConfig = []; // Paso 3
        let savedAuditWidgetsConfig = []; // Paso 4

        window.switchView = function(step) {
            document.getElementById('view-upload').classList.add('hidden');
            document.getElementById('view-range').classList.add('hidden');
            document.getElementById('view-playground').classList.add('hidden');
            document.getElementById('view-compare').classList.add('hidden');
            
            if(step === 1) document.getElementById('view-upload').classList.remove('hidden');
            if(step === 2) document.getElementById('view-range').classList.remove('hidden', 'flex');
            if(step === 3) document.getElementById('view-playground').classList.remove('hidden');
            if(step === 4) {
                document.getElementById('view-compare').classList.remove('hidden', 'flex');
                if(Object.keys(processedDataSources).length > 0) buildAuditSidebar(); 
            }
            
            [1,2,3,4].forEach(n => {
                const btn = document.getElementById('tab'+n);
                if(n === step) { btn.classList.add('tab-active', 'text-slate-900'); btn.classList.remove('text-slate-400', 'text-emerald-400'); } 
                else { btn.classList.remove('tab-active', 'text-slate-900'); if(n === 4 && !btn.disabled) btn.classList.add('text-emerald-400'); else btn.classList.add('text-slate-400'); }
            });
        }

        // --- PASO 1 Y 2: SUBIR Y FUENTES ---
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;
            document.getElementById('uploadStatus').innerHTML = `<i class="fas fa-spinner fa-spin"></i> Leyendo...`;
            rawWorkbooks = {}; processedDataSources = {};
            for(let i=0; i<files.length; i++) {
                const data = await files[i].arrayBuffer();
                rawWorkbooks['file_'+i] = { name: files[i].name, workbook: XLSX.read(data) };
            }
            const fileSel = document.getElementById('fileSelector'); fileSel.innerHTML = '';
            Object.keys(rawWorkbooks).forEach(id => fileSel.innerHTML += `<option value="${id}">${rawWorkbooks[id].name}</option>`);
            
            document.getElementById('btnNext1').classList.remove('hidden');
            window.changeActiveFile();
            document.getElementById('tab2').disabled = false;
        });

        window.changeActiveFile = function() {
            currentFileId = document.getElementById('fileSelector').value;
            const wb = rawWorkbooks[currentFileId].workbook;
            const sheetSel = document.getElementById('sheetSelector'); sheetSel.innerHTML = '';
            wb.SheetNames.forEach(s => sheetSel.innerHTML += `<option value="${s}">${s}</option>`);
            window.renderRawPreview();
        }

        window.renderRawPreview = function() {
            const wb = rawWorkbooks[currentFileId].workbook;
            const rawArray = XLSX.utils.sheet_to_json(wb.Sheets[document.getElementById('sheetSelector').value], { header: 1, defval: "" });
            const tbody = document.getElementById('rawTablePreview'); tbody.innerHTML = '';
            for(let i = 0; i < Math.min(rawArray.length, 20); i++) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="p-1 bg-slate-200 text-slate-500 border-r w-8 text-center">${i + 1}</td>`;
                rawArray[i].forEach(cell => tr.innerHTML += `<td class="p-1 border-r truncate max-w-[150px]">${cell}</td>`);
                tbody.appendChild(tr);
            }
        }

        window.saveAsDataSource = function() {
            const wb = rawWorkbooks[currentFileId].workbook;
            const sheetName = document.getElementById('sheetSelector').value;
            const headerRowNum = parseInt(document.getElementById('headerRow').value) - 1;
            const sheet = wb.Sheets[sheetName];
            let range = XLSX.utils.decode_range(sheet['!ref']); range.s.r = Math.max(0, headerRowNum);
            
            let rawData = XLSX.utils.sheet_to_json(sheet, { range: XLSX.utils.encode_range(range), defval: null });
            let cleanData = rawData.map(r => { let c = {}; for(let k in r) if(!k.includes("__EMPTY")) c[k.trim()] = r[k]; return c; }).filter(r => Object.keys(r).length > 0);
            
            if(cleanData.length === 0) return alert("Sin datos.");

            let dsId = 'ds_' + Date.now();
            processedDataSources[dsId] = { id: dsId, name: `${rawWorkbooks[currentFileId].name} (${sheetName})`, columns: Object.keys(cleanData[0]), data: cleanData };

            document.getElementById('processedSourcesList').innerHTML = Object.values(processedDataSources).map(ds => `<div class="p-1 bg-blue-50 border border-blue-200 rounded text-blue-800 text-[10px] mb-1"><i class="fas fa-check-circle text-green-500 mr-1"></i>${ds.name}</div>`).join('');
            
            document.getElementById('btnGoPlayground').disabled = false; document.getElementById('btnGoPlayground').classList.remove('opacity-50');
            document.getElementById('btnGoAudit').disabled = false; document.getElementById('btnGoAudit').classList.remove('opacity-50');
            document.getElementById('tab3').disabled = false; document.getElementById('tab4').disabled = false;
            
            const dsSel = document.getElementById('dsSelector'); dsSel.innerHTML = '';
            Object.values(processedDataSources).forEach(ds => dsSel.innerHTML += `<option value="${ds.id}">${ds.name}</option>`);
            window.onDataSourceChange();
        }

        // --- PASO 3: DASHBOARD LOCAL (Mantenido) ---
        window.onDataSourceChange = function() {
            const dsId = document.getElementById('dsSelector').value; if(!dsId) return;
            const cols = processedDataSources[dsId].columns;
            document.querySelectorAll('.column-selector').forEach(sel => { sel.innerHTML = ''; cols.forEach(col => sel.innerHTML += `<option value="${col}">${col}</option>`); });
            document.getElementById('globalFiltersArea').innerHTML = '';
        }
        window.selectChartType = function(type) { document.getElementById('selectedChartType').value = type; document.querySelectorAll('.chart-btn').forEach(b => { b.classList.remove('bg-blue-100'); if(b.dataset.type === type) b.classList.add('bg-blue-100'); });}
        window.togglePercentUI = function() { if(document.getElementById('aggType').value === 'percent') { document.getElementById('percentTargetUI').classList.remove('hidden'); window.updatePercentTargets(); } else document.getElementById('percentTargetUI').classList.add('hidden'); }
        window.updatePercentTargets = function() {
            const yCol = document.getElementById('axisY').value; const dsId = document.getElementById('dsSelector').value;
            let uniqueVals = new Set(); processedDataSources[dsId].data.forEach(r => { if(r[yCol]) uniqueVals.add(r[yCol].toString().trim()); });
            const sel = document.getElementById('percentTargetValue'); sel.innerHTML = '';
            Array.from(uniqueVals).sort().forEach(v => sel.innerHTML += `<option value="${v}">${v}</option>`);
        }
        window.addGlobalFilter = function() {
            const dsId = document.getElementById('dsSelector').value; const cols = processedDataSources[dsId].columns;
            const fId = 'gf_' + Date.now(); const box = document.createElement('div');
            box.className = "bg-white border p-1 text-xs relative";
            box.innerHTML = `<button onclick="this.parentElement.remove()" class="absolute top-1 right-1 text-red-400"><i class="fas fa-times"></i></button><select id="col_${fId}" class="w-full p-1 border rounded mb-1 font-bold text-[10px]" onchange="renderCheckboxes('${fId}', '${dsId}')"><option value="">Elegir Columna...</option>${cols.map(c => `<option value="${c}">${c}</option>`).join('')}</select><div id="chk_${fId}" class="max-h-20 overflow-y-auto space-y-0.5"></div>`;
            document.getElementById('globalFiltersArea').prepend(box);
        }
        window.renderCheckboxes = function(fId, dsId) {
            const col = document.getElementById(`col_${fId}`).value; const chk = document.getElementById(`chk_${fId}`); chk.innerHTML = ''; if(!col) return;
            let uSet = new Set(); processedDataSources[dsId].data.forEach(r => { if(r[col]) uSet.add(r[col].toString().trim()); });
            Array.from(uSet).sort().forEach(val => { chk.innerHTML += `<label class="flex items-center gap-1 hover:bg-slate-100 p-0.5 rounded cursor-pointer"><input type="checkbox" value="${val}" checked class="w-3 h-3 text-blue-600 chk-input-${fId}"><span class="truncate text-[10px]">${val}</span></label>`; });
        }
        window.buildWidget = function(existingConfig = null) {
            let config = existingConfig;
            if (!config) {
                let activeFilters = []; document.querySelectorAll('[id^="col_gf_"]').forEach(sel => { if(sel.value) { let fId = sel.id.split('_')[1]; let checked = Array.from(document.querySelectorAll(`.chk-input-${fId}:checked`)).map(cb => cb.value); activeFilters.push({ column: sel.value, allowed: checked }); } });
                let dsId = document.getElementById('dsSelector').value;
                config = { title: document.getElementById('widgetTitle').value || `M√©trica Local`, type: document.getElementById('selectedChartType').value, datasetId: dsId, datasetName: processedDataSources[dsId].name, axisX: document.getElementById('axisX').value, axisY: document.getElementById('axisY').value, agg: document.getElementById('aggType').value, percentTarget: document.getElementById('percentTargetValue').value, filters: activeFilters };
                savedWidgetsConfig.push(config);
            }
            const wId = 'w_' + Date.now() + Math.floor(Math.random()*1000); const grid = document.getElementById('widgetsGrid'); const card = document.createElement('div'); card.className = "flip-container h-[350px] w-full bg-transparent perspective-1000";
            card.innerHTML = `<div class="flipper rounded-2xl shadow border bg-white" id="flipper_${wId}"><div class="front p-4 flex flex-col bg-white rounded-2xl"><div class="flex justify-between items-start mb-2 border-b pb-1"><div class="flex-1"><h3 class="font-bold text-sm truncate">${config.title}</h3><p class="text-[9px] text-slate-400">Local: ${config.datasetName}</p></div><div class="flex gap-1"><button onclick="document.getElementById('flipper_${wId}').parentNode.classList.toggle('flipped')" class="text-slate-400 hover:text-blue-600 p-1"><i class="fas fa-table"></i></button><button onclick="this.closest('.flip-container').remove()" class="text-slate-400 hover:text-red-500 p-1"><i class="fas fa-trash"></i></button></div></div><div class="flex-1 relative"><canvas id="${wId}"></canvas></div></div><div class="back p-4 flex flex-col bg-slate-50 rounded-2xl border-2 border-blue-400"><div class="flex justify-between mb-2"><h3 class="font-bold text-blue-800 text-xs"><i class="fas fa-table"></i> Datos</h3><button onclick="document.getElementById('flipper_${wId}').parentNode.classList.toggle('flipped')" class="text-blue-600 text-xs font-bold"><i class="fas fa-undo"></i></button></div><div class="flex-1 overflow-auto bg-white border"><table class="min-w-full text-[10px] text-left"><thead class="bg-blue-50"><tr><th class="p-1 border-b">${config.axisX}</th><th class="p-1 border-b text-right">Valor</th></tr></thead><tbody id="tbody_${wId}"></tbody></table></div></div></div>`;
            grid.appendChild(card); setTimeout(() => renderChartCore(config, wId, processedDataSources[config.datasetId].data), 50);
        }

        // Motor gr√°fico base compartido
        function renderChartCore(config, canvasId, sourceDataArray) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            let filteredData = sourceDataArray;
            if (config.filters) config.filters.forEach(f => { filteredData = filteredData.filter(row => { let val = row[f.column] ? row[f.column].toString().trim() : ""; return f.allowed.includes(val); }); });
            let grouped = {};
            filteredData.forEach(row => {
                let key = row[config.axisX] || '(Vac√≠o)'; let yVal = parseFloat(row[config.axisY]) || 0; let rawY = row[config.axisY];
                if (!grouped[key]) grouped[key] = { sum: 0, count: 0, valid: 0, hits: 0 };
                grouped[key].count += 1; 
                if (config.agg === 'percent') { if (rawY && rawY.toString().trim() === config.percentTarget) grouped[key].hits += 1; } 
                else if (config.agg === 'count') { if (rawY !== null && rawY !== undefined && rawY !== '') grouped[key].valid += 1; } 
                else { grouped[key].sum += yVal; }
            });
            let fLabels = [], fValues = [], tbody = '';
            let sKeys = Object.keys(grouped).sort((a, b) => {
                let vA = config.agg==='count'?grouped[a].valid : (config.agg==='percent'?(grouped[a].hits/grouped[a].count):grouped[a].sum);
                let vB = config.agg==='count'?grouped[b].valid : (config.agg==='percent'?(grouped[b].hits/grouped[b].count):grouped[b].sum); return vB - vA; 
            });
            sKeys.forEach(k => {
                let val = 0; let disp = "";
                if(config.agg === 'percent') { val = (grouped[k].hits / grouped[k].count) * 100; if(val>100)val=100; disp = val.toFixed(1) + "%"; }
                else if(config.agg === 'count') { val = grouped[k].valid; disp = val.toLocaleString(); }
                else { val = config.agg==='sum'?grouped[k].sum : grouped[k].sum/grouped[k].count; disp = val.toLocaleString(); }
                fLabels.push(k); fValues.push(val); tbody += `<tr><td class="p-1 border-b">${k}</td><td class="p-1 border-b text-right font-bold">${disp}</td></tr>`;
            });
            document.getElementById(`tbody_${canvasId}`).innerHTML = tbody;
            let cType = 'bar'; let cOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } };
            if(config.agg==='percent' && config.type!=='doughnut' && config.type!=='pie') cOptions.scales = {y:{min:0,max:100}};
            let cDataset = { label: 'M√©trica', data: fValues, backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'] };
            if(config.type==='bar'){ cOptions.indexAxis='y'; if(config.agg==='percent')cOptions.scales={x:{min:0,max:100}}; }
            else if(config.type==='line'){ cType='line'; cDataset.borderColor='#4f46e5'; cDataset.fill=false;}
            else if(config.type==='doughnut'){ cType='doughnut'; cOptions.plugins.legend.display=true; }
            new Chart(ctx, { type: cType, data: { labels: fLabels, datasets: [cDataset] }, options: cOptions });
        }


        // ==============================================================
        // üî• PASO 4: NUEVO ESTUDIO DE UNIFICACI√ìN DEFINITIVA üî•
        // ==============================================================

        window.buildAuditSidebar = function() {
            const agg = document.getElementById('auditAggType').value;
            const container = document.getElementById('auditMappingContainer');
            container.innerHTML = '';
            
            Object.values(processedDataSources).forEach(ds => {
                let opts = `<option value="">-- Columna --</option>` + ds.columns.map(c => `<option value="${c}">${c}</option>`).join('');
                const card = document.createElement('div');
                card.className = "bg-emerald-50 border border-emerald-200 rounded p-2 relative";
                
                let mappingHtml = `
                    <div class="flex justify-between items-center mb-1">
                        <h4 class="font-bold text-emerald-900 text-[10px] truncate w-3/4"><i class="fas fa-file-excel mr-1"></i> ${ds.name}</h4>
                        <label class="text-[9px] text-emerald-700 font-bold flex items-center gap-1 cursor-pointer"><input type="checkbox" checked id="inc_${ds.id}" class="w-3 h-3"> Incluir</label>
                    </div>
                `;

                // Seg√∫n el tipo, mostramos qu√© mapear
                if(agg === 'percent') {
                    mappingHtml += `
                        <label class="block text-[9px] font-bold text-emerald-800 uppercase mt-1">Evaluar Estado</label>
                        <select id="auditCol_${ds.id}" class="w-full p-1 border rounded text-[10px] mb-1" onchange="populateAuditSuccess('${ds.id}')">${opts}</select>
                        <label class="block text-[9px] font-bold text-emerald-600 uppercase">Valor "√âxito"</label>
                        <select id="auditDigVal_${ds.id}" class="w-full p-1 border rounded text-[10px] mb-1" disabled></select>
                    `;
                } else if(agg === 'count') {
                    mappingHtml += `
                        <label class="block text-[9px] font-bold text-emerald-800 uppercase mt-1">Columna a Contar</label>
                        <select id="auditCol_${ds.id}" class="w-full p-1 border rounded text-[10px] mb-1">${opts}</select>
                    `;
                } else { // sum o avg
                    mappingHtml += `
                        <label class="block text-[9px] font-bold text-emerald-800 uppercase mt-1">Valores Num√©ricos (Eje Y)</label>
                        <select id="auditCol_${ds.id}" class="w-full p-1 border rounded text-[10px] mb-1">${opts}</select>
                    `;
                }

                // √Årea de Filtros Locales de esta fuente
                mappingHtml += `
                    <div class="mt-2 border-t border-emerald-200 pt-1">
                        <div class="flex justify-between items-center">
                            <span class="text-[9px] font-bold text-emerald-700"><i class="fas fa-filter"></i> Filtros Locales</span>
                            <button onclick="addAuditFilter('${ds.id}')" class="text-[9px] text-emerald-600 bg-emerald-100 px-1 rounded hover:bg-emerald-200 transition">+ Filtro</button>
                        </div>
                        <div id="auditFilters_${ds.id}" class="mt-1 flex flex-col gap-1"></div>
                    </div>
                `;

                card.innerHTML = mappingHtml;
                container.appendChild(card);
            });
        }

        window.populateAuditSuccess = function(dsId) {
            const col = document.getElementById(`auditCol_${dsId}`).value;
            const dig = document.getElementById(`auditDigVal_${dsId}`);
            if(!col) { dig.disabled = true; return; }
            let uVals = new Set(); processedDataSources[dsId].data.forEach(r => { if(r[col]) uVals.add(r[col].toString().trim()); });
            dig.innerHTML = `<option value="">-- Valor --</option>` + Array.from(uVals).sort().map(v => `<option value="${v}">${v}</option>`).join('');
            dig.disabled = false;
        }

        window.addAuditFilter = function(dsId) {
            const cols = processedDataSources[dsId].columns;
            const fId = 'af_' + Date.now() + Math.floor(Math.random()*100);
            const box = document.createElement('div');
            box.className = "bg-white border border-emerald-200 rounded p-1 text-[9px] relative mt-1";
            box.innerHTML = `<button onclick="this.parentElement.remove()" class="absolute top-1 right-1 text-red-400"><i class="fas fa-times"></i></button><select id="acol_${fId}" class="w-full p-1 border rounded mb-1 font-bold" onchange="renderAuditCheckboxes('${fId}', '${dsId}')"><option value="">Filtrar Col...</option>${cols.map(c => `<option value="${c}">${c}</option>`).join('')}</select><div id="achk_${fId}" class="max-h-16 overflow-y-auto space-y-0.5 custom-scroll"></div>`;
            document.getElementById(`auditFilters_${dsId}`).appendChild(box);
        }

        window.renderAuditCheckboxes = function(fId, dsId) {
            const col = document.getElementById(`acol_${fId}`).value; const chk = document.getElementById(`achk_${fId}`); chk.innerHTML = ''; if(!col) return;
            let uSet = new Set(); processedDataSources[dsId].data.forEach(r => { if(r[col]) uSet.add(r[col].toString().trim()); });
            Array.from(uSet).sort().forEach(val => { chk.innerHTML += `<label class="flex items-center gap-1 hover:bg-slate-100 p-0.5 rounded cursor-pointer"><input type="checkbox" value="${val}" checked class="w-3 h-3 text-emerald-600 achk-input-${fId}"><span class="truncate" title="${val}">${val}</span></label>`; });
        }

        // GENERAR M√öLTIPLES WIDGETS UNIFICADOS
        window.generateMergedAudit = function(existingConfig = null) {
            document.getElementById('emptyAudit').style.display = 'none';

            let config = existingConfig;

            if(!config) {
                const agg = document.getElementById('auditAggType').value;
                const type = document.getElementById('auditChartType').value;
                const title = document.getElementById('auditTitle').value || `Consolidado (${agg.toUpperCase()})`;
                
                let sourceMappings = [];

                Object.values(processedDataSources).forEach(ds => {
                    if(document.getElementById(`inc_${ds.id}`).checked) {
                        const col = document.getElementById(`auditCol_${ds.id}`).value;
                        if(col) {
                            // Cosechar filtros locales
                            let localFilters = [];
                            const filtersContainer = document.getElementById(`auditFilters_${ds.id}`);
                            if(filtersContainer) {
                                filtersContainer.querySelectorAll('[id^="acol_af_"]').forEach(sel => {
                                    if(sel.value) {
                                        let fId = sel.id.split('_')[1] + '_' + sel.id.split('_')[2];
                                        let checked = Array.from(document.querySelectorAll(`.achk-input-${fId}:checked`)).map(cb => cb.value);
                                        localFilters.push({ column: sel.value, allowed: checked });
                                    }
                                });
                            }

                            sourceMappings.push({
                                dsId: ds.id,
                                dsName: ds.name,
                                column: col,
                                digVal: agg === 'percent' ? document.getElementById(`auditDigVal_${ds.id}`).value : null,
                                filters: localFilters
                            });
                        }
                    }
                });

                if(sourceMappings.length === 0) return alert("Selecciona al menos un archivo y mapea sus columnas.");

                config = { title: title, type: type, agg: agg, mappings: sourceMappings };
                savedAuditWidgetsConfig.push(config);
            }

            // CREAR UI DEL WIDGET UNIFICADO
            const wId = 'aw_' + Date.now() + Math.floor(Math.random()*1000);
            const grid = document.getElementById('auditWidgetsGrid');
            const card = document.createElement('div');
            card.className = "flip-container h-[400px] w-full bg-transparent perspective-1000";
            
            // Front (Gr√°fico) / Back (Tabla)
            card.innerHTML = `
                <div class="flipper rounded-2xl shadow-lg border bg-white" id="flipper_${wId}">
                    <div class="front p-4 flex flex-col bg-white rounded-2xl">
                        <div class="flex justify-between items-start mb-2 border-b pb-2">
                            <div class="flex-1"><h3 class="font-bold text-lg text-emerald-900 truncate"><i class="fas fa-globe"></i> ${config.title}</h3><p class="text-[10px] text-slate-400">Archivos fusionados: ${config.mappings.length}</p></div>
                            <div class="flex gap-1">
                                <button onclick="document.getElementById('flipper_${wId}').parentNode.classList.toggle('flipped')" class="text-slate-400 hover:text-emerald-600 p-1 bg-slate-50 rounded"><i class="fas fa-table"></i></button>
                                <button onclick="this.closest('.flip-container').remove()" class="text-slate-400 hover:text-red-500 p-1 bg-slate-50 rounded"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        <div class="flex-1 relative"><canvas id="${wId}"></canvas></div>
                    </div>
                    <div class="back p-4 flex flex-col bg-slate-50 rounded-2xl border-2 border-emerald-400">
                        <div class="flex justify-between mb-2"><h3 class="font-bold text-emerald-800 text-sm"><i class="fas fa-table"></i> Desglose por Fuente</h3><button onclick="document.getElementById('flipper_${wId}').parentNode.classList.toggle('flipped')" class="text-emerald-600 text-xs font-bold"><i class="fas fa-undo"></i> Volver</button></div>
                        <div class="flex-1 overflow-auto bg-white border custom-scroll"><table class="min-w-full text-xs text-left"><thead class="bg-emerald-50 text-emerald-900"><tr><th class="p-2 border-b">Fuente</th><th class="p-2 border-b text-right">Resultado</th></tr></thead><tbody id="tbody_${wId}"></tbody></table></div>
                    </div>
                </div>
            `;
            grid.appendChild(card);
            setTimeout(() => renderUnifiedChart(config, wId), 50);

            document.getElementById('auditTitle').value = '';
        }

        // C√ÅLCULO DE DATOS UNIFICADOS
        function renderUnifiedChart(config, canvasId) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            let chartLabels = [];
            let chartData = [];
            let tbodyHtml = '';

            let grandTotalSum = 0; let grandTotalCount = 0; let grandTotalHits = 0;

            config.mappings.forEach(map => {
                let rawData = processedDataSources[map.dsId].data;
                
                // Aplicar filtros locales de este archivo
                if(map.filters && map.filters.length > 0) {
                    map.filters.forEach(f => {
                        rawData = rawData.filter(r => { let val = r[f.column]?r[f.column].toString().trim():""; return f.allowed.includes(val); });
                    });
                }

                let sum = 0; let count = 0; let hits = 0; let valid = 0;
                
                rawData.forEach(r => {
                    let v = r[map.column];
                    let num = parseFloat(v) || 0;
                    
                    count++;
                    if(config.agg === 'percent') { if(v && v.toString().trim() === map.digVal) hits++; }
                    else if(config.agg === 'count') { if(v !== null && v !== undefined && v !== '') valid++; }
                    else { sum += num; }
                });

                // Acumuladores Globales
                grandTotalCount += count; grandTotalHits += hits; grandTotalSum += (config.agg==='count'?valid:sum);

                // Resultado Local
                let res = 0; let disp = "";
                if(config.agg === 'percent') { res = count>0?(hits/count)*100:0; disp = res.toFixed(1) + "%"; }
                else if(config.agg === 'count') { res = valid; disp = res.toLocaleString(); }
                else if(config.agg === 'sum') { res = sum; disp = res.toLocaleString(); }
                else if(config.agg === 'avg') { res = count>0?(sum/count):0; disp = res.toFixed(2); }

                chartLabels.push(map.dsName.split(' ')[0]); // Nombre corto
                chartData.push(Math.round(res*100)/100);
                tbodyHtml += `<tr><td class="p-2 border-b border-r text-slate-700 font-medium">${map.dsName}</td><td class="p-2 border-b text-right font-bold">${disp}</td></tr>`;
            });

            // Fila de Total Global Consolidado
            let tDisp = "";
            if(config.agg === 'percent') tDisp = (grandTotalCount>0?(grandTotalHits/grandTotalCount)*100:0).toFixed(1) + "%";
            else tDisp = grandTotalSum.toLocaleString();

            tbodyHtml += `<tr class="bg-emerald-100 font-black text-emerald-900 border-t-2 border-emerald-400"><td class="p-2 border-r text-right">TOTAL GLOBAL:</td><td class="p-2 text-right">${tDisp}</td></tr>`;
            document.getElementById(`tbody_${canvasId}`).innerHTML = tbodyHtml;

            let cType = config.type === 'doughnut' ? 'doughnut' : 'bar';
            let cOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: cType==='doughnut' } } };
            if(config.agg==='percent' && cType==='bar') cOptions.scales = {y:{min:0,max:100}};
            let cDataset = { label: 'Rendimiento', data: chartData, backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'] };

            new Chart(ctx, { type: cType, data: { labels: chartLabels, datasets: [cDataset] }, options: cOptions });
        }

        // FIREBASE GUARDAR TODO
        window.saveToFirebase = async function() {
            const btn = document.getElementById('btnSave'); btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Guardando...'; btn.disabled = true;
            try {
                await addDoc(collection(db, "reportes"), {
                    nombre: document.getElementById('projectName').value || "Proyecto Consolidado Final",
                    fecha: serverTimestamp(),
                    datasetsJSON: JSON.stringify(processedDataSources),
                    configuracionGraficos: savedWidgetsConfig,     // Paso 3
                    configuracionUnificada: savedAuditWidgetsConfig // Paso 4
                });
                alert("¬°Guardado en Nube!");
                loadCloudProjects();
            } catch (error) { alert("Error."); } finally { btn.innerHTML = '<i class="fas fa-cloud-upload-alt mr-2"></i> Guardar Todo en Nube'; btn.disabled = false; }
        }

        async function loadCloudProjects() {
            const listDiv = document.getElementById('cloudProjectsList');
            try {
                const q = query(collection(db, "reportes"), orderBy("fecha", "desc"));
                const querySnapshot = await getDocs(q);
                listDiv.innerHTML = '';
                if(querySnapshot.empty) { listDiv.innerHTML = '<p class="text-slate-500 text-center text-sm">No hay reportes.</p>'; return; }
                querySnapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const btn = document.createElement('button');
                    btn.className = "w-full text-left p-3 bg-white border rounded hover:border-blue-500 hover:shadow transition group text-sm";
                    btn.innerHTML = `<p class="font-bold text-slate-700 group-hover:text-blue-600">${data.nombre}</p><p class="text-[10px] text-slate-400 mt-1"><i class="fas fa-database"></i> Proyecto Nube</p>`;
                    btn.onclick = () => openCloudProject(data);
                    listDiv.appendChild(btn);
                });
            } catch (error) {}
        }

        window.openCloudProject = function(firebaseData) {
            processedDataSources = JSON.parse(firebaseData.datasetsJSON || "{}");
            savedWidgetsConfig = firebaseData.configuracionGraficos || [];
            savedAuditWidgetsConfig = firebaseData.configuracionUnificada || [];
            
            document.getElementById('projectName').value = firebaseData.nombre;
            
            // Reconstruir Paso 3
            const dsSel = document.getElementById('dsSelector'); dsSel.innerHTML = '';
            Object.values(processedDataSources).forEach(ds => dsSel.innerHTML += `<option value="${ds.id}">${ds.name}</option>`);
            if(Object.keys(processedDataSources).length > 0) window.onDataSourceChange();
            
            document.getElementById('widgetsGrid').innerHTML = ''; 
            savedWidgetsConfig.forEach(cfg => window.buildWidget(cfg));

            // Reconstruir Paso 4
            document.getElementById('auditWidgetsGrid').innerHTML = ''; 
            document.getElementById('emptyAudit').style.display = 'none';
            savedAuditWidgetsConfig.forEach(cfg => window.generateMergedAudit(cfg));

            document.getElementById('btnGoPlayground').disabled = false; document.getElementById('btnGoPlayground').classList.remove('opacity-50');
            document.getElementById('btnGoAudit').disabled = false; document.getElementById('btnGoAudit').classList.remove('opacity-50');
            document.getElementById('tab3').disabled = false; document.getElementById('tab4').disabled = false;

            window.switchView(4); // Llevamos al usuario al final del flujo
        }

        loadCloudProjects();
    </script>
</body>
</html>
