<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DataMaster v26 - UX Pro</title>
    
    <!-- Librerías -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        
        /* Scrollbars finos y elegantes */
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Tarjetas 3D */
        .flip-container { perspective: 1000px; cursor: pointer; }
        .flipper { transition: 0.6s; transform-style: preserve-3d; position: relative; height: 100%; width: 100%; }
        .front, .back { 
            backface-visibility: hidden; position: absolute; top: 0; left: 0; right: 0; bottom: 0; 
            border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); background: white;
        }
        .front { z-index: 2; transform: rotateY(0deg); }
        .back { transform: rotateY(180deg); overflow: hidden; border: 1px solid #e2e8f0; }
        .flipped .flipper { transform: rotateY(180deg); }

        /* Estilos de Tabla Excel */
        .excel-table { border-collapse: separate; border-spacing: 0; width: 100%; font-size: 0.75rem; }
        .excel-table th { 
            background-color: #f8fafc; color: #475569; font-weight: 600; 
            padding: 8px 12px; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0;
            position: sticky; top: 0; z-index: 10; text-transform: uppercase; letter-spacing: 0.05em;
        }
        .excel-table td { 
            padding: 6px 12px; border-bottom: 1px solid #f1f5f9; border-right: 1px solid #f1f5f9; 
            color: #334155; white-space: nowrap; max-width: 200px; overflow: hidden; text-overflow: ellipsis;
        }
        .excel-table tr:hover td { background-color: #f1f5f9; }
        .excel-table tr:last-child td { border-bottom: none; }

        /* Navegación Pasos */
        .step-btn { @apply px-4 py-2 rounded-lg text-xs font-bold transition-all border border-transparent; }
        .step-active { @apply bg-slate-800 text-white shadow-md border-slate-700; }
        .step-inactive { @apply text-slate-500 hover:bg-white hover:text-slate-700; }
        .step-disabled { @apply opacity-40 cursor-not-allowed; }

        /* Paneles */
        .panel-sidebar { @apply w-96 bg-white border-r border-slate-200 flex flex-col z-20 shadow-[4px_0_24px_rgba(0,0,0,0.02)]; }
        .panel-content { @apply flex-1 bg-slate-50 relative flex flex-col min-w-0; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-800">

    <!-- HEADER -->
    <header class="bg-white border-b border-slate-200 h-14 flex items-center justify-between px-6 z-30 shadow-sm flex-none">
        <div class="flex items-center gap-3">
            <div class="bg-gradient-to-br from-indigo-600 to-blue-500 text-white p-1.5 rounded-lg shadow-sm">
                <i class="fas fa-chart-simple text-lg"></i>
            </div>
            <h1 class="text-sm font-black tracking-wide text-slate-800">DATA<span class="text-indigo-600">MASTER</span></h1>
        </div>
        
        <nav class="flex bg-slate-100/80 p-1 rounded-xl gap-1">
            <button id="step1" onclick="switchView(1)" class="step-btn step-active">1. Carga</button>
            <button id="step2" onclick="switchView(2)" disabled class="step-btn step-inactive step-disabled">2. Fuentes</button>
            <button id="step3" onclick="switchView(3)" disabled class="step-btn step-inactive step-disabled">3. Dashboard</button>
            <button id="step4" onclick="switchView(4)" disabled class="step-btn step-inactive step-disabled">4. Unificar</button>
        </nav>

        <div class="w-24"></div> <!-- Spacer for balance -->
    </header>

    <!-- MAIN CONTAINER -->
    <main class="flex-1 relative overflow-hidden flex">

        <!-- VISTA 1: CARGA (Centrada) -->
        <div id="view-1" class="absolute inset-0 z-30 bg-slate-50 flex flex-col items-center justify-center p-6 fade-in">
            <div class="bg-white p-10 rounded-2xl shadow-xl border border-slate-200 text-center max-w-lg w-full">
                <div class="w-16 h-16 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-inner">
                    <i class="fas fa-folder-open text-3xl"></i>
                </div>
                <h2 class="text-xl font-bold text-slate-800 mb-2">Comienza tu Análisis</h2>
                <p class="text-slate-500 text-sm mb-8">Sube tus archivos Excel (.xlsx, .csv) para procesar datos.</p>
                
                <label class="block mb-4 group cursor-pointer">
                    <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" multiple class="hidden"/>
                    <div class="bg-slate-900 text-white px-6 py-4 rounded-xl font-bold shadow-lg shadow-indigo-500/20 group-hover:bg-slate-800 group-active:scale-95 transition flex items-center justify-center gap-3">
                        <i class="fas fa-cloud-upload-alt text-lg"></i>
                        <span>Seleccionar Archivos</span>
                    </div>
                </label>
                <div id="uploadStatus" class="h-5 text-xs font-bold text-indigo-600"></div>

                <button id="btnNext1" onclick="switchView(2)" class="hidden w-full mt-6 bg-white border-2 border-indigo-600 text-indigo-600 py-3 rounded-xl font-bold hover:bg-indigo-50 transition">
                    Siguiente Paso <i class="fas fa-arrow-right ml-1"></i>
                </button>
            </div>
            
            <div class="mt-8">
                <button onclick="loadProjs()" class="text-xs text-slate-400 hover:text-indigo-600 font-medium flex items-center gap-2">
                    <i class="fas fa-sync-alt"></i> Cargar proyectos guardados
                </button>
                <div id="cloudProjectsList" class="mt-2 hidden"></div> <!-- Hidden container for logic -->
            </div>
        </div>

        <!-- VISTA 2: FUENTES (Split View) -->
        <div id="view-2" class="hidden absolute inset-0 w-full h-full flex flex-row bg-white">
            <!-- Sidebar Config -->
            <div class="panel-sidebar">
                <div class="p-5 border-b border-slate-100">
                    <h3 class="font-bold text-slate-800">Configuración de Fuente</h3>
                    <p class="text-xs text-slate-400 mt-1">Define qué hoja usarás como base.</p>
                </div>
                <div class="p-5 flex-1 overflow-y-auto custom-scroll space-y-5">
                    <div>
                        <label class="text-[11px] font-bold text-slate-500 uppercase tracking-wider mb-1 block">Archivo</label>
                        <select id="fileSelector" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm font-semibold outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition" onchange="changeActiveFile()"></select>
                    </div>
                    <div>
                        <label class="text-[11px] font-bold text-slate-500 uppercase tracking-wider mb-1 block">Hoja</label>
                        <select id="sheetSelector" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm font-semibold outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition" onchange="renderRawPreview()"></select>
                    </div>
                    <div>
                        <label class="text-[11px] font-bold text-slate-500 uppercase tracking-wider mb-1 block">Fila Encabezados</label>
                        <input type="number" id="headerRow" value="1" min="1" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg text-center font-bold outline-none focus:border-indigo-500">
                    </div>
                    
                    <button onclick="saveAsDataSource()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold shadow-md hover:bg-indigo-700 active:scale-95 transition flex justify-center items-center gap-2">
                        <i class="fas fa-check-circle"></i> Guardar Fuente
                    </button>

                    <div class="pt-4 border-t border-slate-100">
                        <h4 class="text-[10px] font-bold text-slate-400 uppercase mb-2">Fuentes Activas</h4>
                        <div id="processedSourcesList" class="space-y-2">
                            <p class="text-xs text-slate-300 italic text-center py-2">Ninguna fuente guardada</p>
                        </div>
                    </div>
                </div>
                
                <div class="p-4 bg-slate-50 border-t border-slate-200">
                    <button onclick="switchView(3)" id="btnGoPlayground" disabled class="w-full bg-slate-800 text-white py-3 rounded-lg font-bold text-sm shadow-lg disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-700 transition">
                        Ir al Dashboard <i class="fas fa-chevron-right ml-1"></i>
                    </button>
                </div>
            </div>

            <!-- Content Area (Preview) -->
            <div class="panel-content">
                <div class="h-10 bg-white border-b border-slate-200 flex items-center px-4 justify-between">
                    <span class="text-xs font-bold text-slate-500 uppercase"><i class="fas fa-table mr-2"></i> Previsualización de Datos</span>
                    <span class="text-[10px] bg-green-100 text-green-700 px-2 py-0.5 rounded-full font-bold">Live Data</span>
                </div>
                <div class="flex-1 overflow-auto custom-scroll relative bg-white">
                    <table class="excel-table" id="rawTablePreview"></table>
                </div>
            </div>
        </div>

        <!-- VISTA 3: DASHBOARD INDIVIDUAL (Split View) -->
        <div id="view-3" class="hidden absolute inset-0 w-full h-full flex flex-row bg-slate-50">
            <!-- Sidebar Controles -->
            <div class="panel-sidebar">
                <div class="p-4 border-b border-slate-100 flex justify-between items-center">
                    <h3 class="font-bold text-slate-800">Constructor</h3>
                    <button onclick="switchView(4)" class="text-xs bg-emerald-50 text-emerald-600 px-2 py-1 rounded hover:bg-emerald-100 transition font-bold">Unificar <i class="fas fa-arrow-right"></i></button>
                </div>
                <div class="p-5 flex-1 overflow-y-auto custom-scroll space-y-5">
                    
                    <!-- 1. Fuente -->
                    <div class="bg-white border border-slate-200 rounded-xl p-3 shadow-sm">
                        <label class="text-[10px] text-slate-400 font-bold uppercase mb-1 block">Fuente de Datos</label>
                        <select id="dsSelector" class="w-full p-2 text-xs font-bold border border-slate-200 rounded-lg outline-none focus:border-indigo-500 bg-slate-50" onchange="onDataSourceChange()"></select>
                    </div>

                    <!-- 2. Config -->
                    <div class="space-y-3">
                        <input type="text" id="widgetTitle" placeholder="Título del Gráfico..." class="w-full p-2 border-b border-slate-200 text-sm font-semibold outline-none bg-transparent focus:border-indigo-500 placeholder-slate-400">
                        
                        <div>
                            <label class="text-[10px] text-slate-400 font-bold uppercase mb-1 block">Agrupar por (Eje X)</label>
                            <select id="axisX" class="w-full p-2 text-xs border border-slate-200 rounded-lg outline-none column-selector"></select>
                        </div>

                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="text-[10px] text-slate-400 font-bold uppercase mb-1 block">Operación</label>
                                <select id="aggType" class="w-full p-2 text-xs border border-slate-200 rounded-lg outline-none font-medium" onchange="togglePercentUI()">
                                    <option value="count">Contar</option>
                                    <option value="sum">Sumar</option>
                                    <option value="percent">Porcentaje %</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-[10px] text-slate-400 font-bold uppercase mb-1 block">Columna Valor</label>
                                <select id="axisY" class="w-full p-2 text-xs border border-slate-200 rounded-lg outline-none column-selector" onchange="updatePercentTargets()"></select>
                            </div>
                        </div>

                        <div id="percentTargetUI" class="hidden bg-yellow-50 p-3 rounded-lg border border-yellow-100">
                            <label class="text-[10px] text-yellow-700 font-bold uppercase mb-1 block">Valor "Éxito" (Multi)</label>
                            <div id="percentTargetValue" class="max-h-24 overflow-y-auto custom-scroll bg-white border border-yellow-200 rounded p-1 space-y-1"></div>
                        </div>
                    </div>

                    <!-- 3. Filtros -->
                    <div class="border-t border-slate-100 pt-3">
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-[10px] text-slate-400 font-bold uppercase">Filtros</label>
                            <button onclick="addGlobalFilter()" class="text-[10px] bg-slate-100 px-2 py-0.5 rounded hover:bg-slate-200 transition">+ Añadir</button>
                        </div>
                        <div id="globalFiltersArea" class="space-y-2"></div>
                    </div>

                    <!-- 4. Tipo -->
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="selectChartType('bar')" class="chart-btn active p-2 border rounded hover:bg-slate-50 flex justify-center text-slate-600 bg-slate-800 text-white" data-type="bar"><i class="fas fa-chart-bar"></i></button>
                        <button onclick="selectChartType('line')" class="chart-btn p-2 border rounded hover:bg-slate-50 flex justify-center text-slate-600" data-type="line"><i class="fas fa-chart-line"></i></button>
                        <button onclick="selectChartType('doughnut')" class="chart-btn p-2 border rounded hover:bg-slate-50 flex justify-center text-slate-600" data-type="doughnut"><i class="fas fa-chart-pie"></i></button>
                        <input type="hidden" id="selectedChartType" value="bar">
                    </div>

                    <button onclick="buildWidget()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold shadow-lg hover:bg-indigo-700 active:scale-95 transition mt-2">
                        Generar Gráfico
                    </button>
                </div>
                
                <div class="p-3 bg-slate-900 border-t border-slate-800">
                    <div class="flex gap-2">
                        <input type="text" id="projectName3" placeholder="Nombre Proyecto..." class="flex-1 bg-slate-800 border-none rounded text-xs text-white p-2 outline-none">
                        <button onclick="saveToFirebase()" class="text-xs bg-indigo-500 text-white px-3 rounded font-bold hover:bg-indigo-400">Guardar</button>
                    </div>
                </div>
            </div>

            <!-- Content Area (Canvas) -->
            <div class="panel-content p-6 overflow-y-auto custom-scroll scroll-smooth" id="canvasArea3">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-slate-800">Tablero de Resultados</h2>
                    <span class="text-xs text-slate-400"><i class="fas fa-info-circle"></i> Toca un gráfico para ver los datos</span>
                </div>
                
                <div id="widgetsGrid" class="grid grid-cols-1 xl:grid-cols-2 gap-6 pb-20">
                    <!-- Placeholder -->
                    <div id="emptyLocal" class="col-span-full h-64 border-2 border-dashed border-slate-300 rounded-2xl flex flex-col items-center justify-center text-slate-400 bg-slate-50/50">
                        <i class="fas fa-chart-column text-4xl mb-3 opacity-50"></i>
                        <p class="text-sm font-medium">Configura los parámetros a la izquierda y presiona "Generar"</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- VISTA 4: UNIFICAR (Split View) -->
        <div id="view-4" class="hidden absolute inset-0 w-full h-full flex flex-row bg-slate-50">
            <div class="panel-sidebar">
                <div class="p-4 border-b border-slate-100 bg-emerald-50/50">
                    <h3 class="font-bold text-emerald-900">Unificar Fuentes</h3>
                </div>
                <div class="p-5 flex-1 overflow-y-auto custom-scroll space-y-4">
                    <!-- Modo -->
                    <div class="flex bg-slate-100 p-1 rounded-lg">
                        <label class="flex-1 text-center cursor-pointer">
                            <input type="radio" name="auditMode" value="merge" class="hidden peer" checked onchange="toggleAuditMode()">
                            <span class="block py-1.5 text-[10px] font-bold text-slate-500 rounded peer-checked:bg-white peer-checked:text-emerald-600 peer-checked:shadow-sm transition">Suma Total</span>
                        </label>
                        <label class="flex-1 text-center cursor-pointer">
                            <input type="radio" name="auditMode" value="compare" class="hidden peer" onchange="toggleAuditMode()">
                            <span class="block py-1.5 text-[10px] font-bold text-slate-500 rounded peer-checked:bg-white peer-checked:text-blue-600 peer-checked:shadow-sm transition">Comparar</span>
                        </label>
                    </div>

                    <input type="text" id="auditTitle" placeholder="Título Unificado..." class="w-full p-2.5 border border-slate-200 rounded-lg text-sm font-semibold outline-none">

                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Métrica</label>
                            <select id="auditAggType" class="w-full p-2 border border-slate-200 rounded-lg text-xs font-bold outline-none" onchange="buildAuditSidebar()">
                                <option value="percent">Porcentaje (%)</option>
                                <option value="sum">Sumatoria</option>
                                <option value="count">Contar</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Visual</label>
                            <select id="auditChartType" class="w-full p-2 border border-slate-200 rounded-lg text-xs font-bold outline-none">
                                <option value="bar">Barras</option>
                                <option value="doughnut">Dona</option>
                                <option value="line">Línea</option>
                            </select>
                        </div>
                    </div>

                    <div id="auditMappingContainer" class="space-y-3"></div>

                    <button onclick="generateMergedAudit()" class="w-full bg-emerald-600 text-white py-3 rounded-lg font-bold shadow-lg hover:bg-emerald-700 active:scale-95 transition mt-2">
                        GENERAR REPORTE
                    </button>
                </div>
                
                <div class="p-3 bg-slate-900 border-t border-slate-800">
                    <div class="flex gap-2">
                        <input type="text" id="projectName4" placeholder="Nombre Proyecto..." class="flex-1 bg-slate-800 border-none rounded text-xs text-white p-2 outline-none">
                        <button onclick="saveToFirebase()" class="text-xs bg-indigo-500 text-white px-3 rounded font-bold hover:bg-indigo-400">Guardar</button>
                    </div>
                </div>
            </div>

            <div class="panel-content p-6 overflow-y-auto custom-scroll scroll-smooth" id="canvasArea4">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-slate-800">Reportes Unificados</h2>
                </div>
                <div id="auditWidgetsGrid" class="grid grid-cols-1 xl:grid-cols-2 gap-8 pb-20">
                     <div id="emptyAudit" class="col-span-full h-64 border-2 border-dashed border-slate-300 rounded-2xl flex flex-col items-center justify-center text-slate-400 bg-slate-50/50">
                        <i class="fas fa-network-wired text-4xl mb-3 opacity-50"></i>
                        <p class="text-sm font-medium">Configura el cruce de datos a la izquierda</p>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- JAVASCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, orderBy, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCZXwXN15MYVpFP0-QbgR-H4bHqMH4_EFA", authDomain: "reporte-d37d1.firebaseapp.com", projectId: "reporte-d37d1", storageBucket: "reporte-d37d1.firebasestorage.app", messagingSenderId: "995600823465", appId: "1:995600823465:web:3ae9ede621cf0631ad65b8" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Auto-login silencioso
        signInAnonymously(auth).then(() => loadProjs()).catch((e) => console.log("Modo local."));

        let rawWorkbooks = {}; 
        let processedDataSources = {}; 
        let currentFileId = null;
        let savedWidgetsConfig = []; 
        let savedAuditWidgetsConfig = [];

        window.switchView = function(step) {
            ['view-upload','view-range','view-playground','view-compare'].forEach(v => document.getElementById(v.replace('view-','view-')).classList.add('hidden'));
            if(step===1) document.getElementById('view-upload').classList.remove('hidden');
            if(step===2) document.getElementById('view-range').classList.remove('hidden', 'flex');
            if(step===3) document.getElementById('view-playground').classList.remove('hidden', 'flex');
            if(step===4) { document.getElementById('view-compare').classList.remove('hidden', 'flex'); if(Object.keys(processedDataSources).length>0) buildAuditSidebar(); }
            
            [1,2,3,4].forEach(n => {
                const btn = document.getElementById('tab'+n);
                if(n===step) { btn.classList.add('tab-active'); btn.classList.remove('tab-inactive', 'tab-disabled'); }
                else { 
                    btn.classList.remove('tab-active'); 
                    if(document.getElementById('tab'+n).disabled) btn.classList.add('tab-disabled');
                    else btn.classList.add('tab-inactive');
                }
            });
        }

        // 1. CARGA
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const files = Array.from(e.target.files); if(files.length===0) return;
            document.getElementById('uploadStatus').innerText = `Leyendo ${files.length} archivos...`;
            for(let i=0; i<files.length; i++) {
                const data = await files[i].arrayBuffer();
                rawWorkbooks['file_'+i] = { name: files[i].name, workbook: XLSX.read(data) };
            }
            const fSel = document.getElementById('fileSelector'); fSel.innerHTML = '';
            Object.keys(rawWorkbooks).forEach(id => fSel.innerHTML += `<option value="${id}">${rawWorkbooks[id].name}</option>`);
            document.getElementById('btnNext1').classList.remove('hidden');
            window.changeActiveFile();
            document.getElementById('tab2').disabled = false;
            document.getElementById('tab2').classList.remove('tab-disabled');
        });

        // 2. FUENTES
        window.changeActiveFile = function() {
            currentFileId = document.getElementById('fileSelector').value;
            const wb = rawWorkbooks[currentFileId].workbook;
            const sSel = document.getElementById('sheetSelector'); sSel.innerHTML = '';
            wb.SheetNames.forEach(s => sSel.innerHTML += `<option value="${s}">${s}</option>`);
            window.renderRawPreview();
        }

        window.renderRawPreview = function() {
            const wb = rawWorkbooks[currentFileId].workbook;
            const raw = XLSX.utils.sheet_to_json(wb.Sheets[document.getElementById('sheetSelector').value], {header:1, defval:""});
            const tbody = document.getElementById('rawTablePreview'); 
            let theadHtml = '<thead><tr><th>#</th>';
            if(raw.length > 0) raw[0].forEach(h => theadHtml += `<th>${h}</th>`);
            theadHtml += '</tr></thead><tbody>';
            for(let i=1; i<Math.min(raw.length,25); i++) {
                theadHtml += `<tr><td class="font-bold text-slate-400 bg-slate-50 text-center border-r">${i}</td>${raw[i].map(c=>`<td>${c}</td>`).join('')}</tr>`;
            }
            tbody.innerHTML = theadHtml + '</tbody>';
        }

        window.saveAsDataSource = function() {
            const wb = rawWorkbooks[currentFileId].workbook; 
            const sName = document.getElementById('sheetSelector').value;
            const hRow = parseInt(document.getElementById('headerRow').value)-1;
            const sheet = wb.Sheets[sName]; 
            let range = XLSX.utils.decode_range(sheet['!ref']); range.s.r = Math.max(0, hRow);
            let data = XLSX.utils.sheet_to_json(sheet, {range: XLSX.utils.encode_range(range), defval:null});
            let clean = data.map(r => { let c={}; for(let k in r) if(!k.includes("__EMPTY")) c[k.trim()]=r[k]; return c; }).filter(r=>Object.keys(r).length>0);

            if(clean.length===0) return alert("Hoja vacía.");
            let id = 'ds_'+Date.now();
            processedDataSources[id] = { id: id, name: `${rawWorkbooks[currentFileId].name} (${sName})`, columns: Object.keys(clean[0]), data: clean };
            
            const list = document.getElementById('processedSourcesList');
            if(list.children[0]?.tagName === 'P') list.innerHTML = '';
            list.innerHTML += `<div class="p-3 bg-white border border-indigo-100 rounded-lg text-xs text-slate-600 shadow-sm flex items-center gap-2 animate-pulse"><div class="w-2 h-2 rounded-full bg-green-500"></div> ${processedDataSources[id].name}</div>`;
            
            ['tab3','tab4','btnGoPlayground','btnGoAudit'].forEach(id => {
                const el = document.getElementById(id);
                if(el) { el.disabled=false; el.classList.remove('tab-disabled', 'opacity-50', 'cursor-not-allowed'); }
            });
            updateSelectors();
        }

        function updateSelectors() {
            const dsSel = document.getElementById('dsSelector'); 
            const currentVal = dsSel.value;
            dsSel.innerHTML = '';
            Object.values(processedDataSources).forEach(d => dsSel.innerHTML += `<option value="${d.id}">${d.name}</option>`);
            if(currentVal && processedDataSources[currentVal]) dsSel.value = currentVal;
            window.onDataSourceChange();
        }

        // 3. DASHBOARD
        window.onDataSourceChange = function() {
            const id = document.getElementById('dsSelector').value; if(!id) return;
            const cols = processedDataSources[id].columns;
            document.querySelectorAll('.column-selector').forEach(s => { s.innerHTML = ''; cols.forEach(c => s.innerHTML+=`<option value="${c}">${c}</option>`); });
        }
        window.selectChartType = function(type) {
            document.getElementById('selectedChartType').value = type;
            document.querySelectorAll('.chart-btn').forEach(b => {
                b.classList.remove('bg-slate-800', 'text-white', 'border-slate-800');
                if(b.dataset.type === type) b.classList.add('bg-slate-800', 'text-white', 'border-slate-800');
            });
        }
        window.togglePercentUI = function() { 
            const show = document.getElementById('aggType').value === 'percent' || document.getElementById('aggType').value === 'count'; 
            document.getElementById('percentTargetUI').classList.toggle('hidden', !show); 
            if(show) window.updatePercentTargets(); 
        }
        window.updatePercentTargets = function() {
            const col = document.getElementById('axisY').value; const id = document.getElementById('dsSelector').value;
            if(!col || !id) return;
            let vals = new Set(); processedDataSources[id].data.forEach(r => { if(r[col]) vals.add(String(r[col]).trim()); });
            const container = document.getElementById('percentTargetValue'); container.innerHTML = '';
            Array.from(vals).sort().forEach(v => { container.innerHTML += `<label class="flex items-center gap-2 p-1.5 hover:bg-slate-50 cursor-pointer border-b border-slate-50"><input type="checkbox" class="target-val-chk rounded text-indigo-600 focus:ring-0" value="${v}"><span class="truncate text-xs">${v}</span></label>`; });
        }
        window.addGlobalFilter = function() {
            const id = document.getElementById('dsSelector').value; const fId = 'gf_'+Date.now();
            const div = document.createElement('div'); div.className = "bg-white border p-2 rounded-lg text-xs relative mt-2 shadow-sm";
            div.innerHTML = `<button onclick="this.parentElement.remove()" class="absolute -top-2 -right-2 bg-white text-red-500 rounded-full w-5 h-5 flex items-center justify-center shadow border hover:bg-red-50">×</button><select id="c_${fId}" class="w-full border rounded mb-2 text-[11px] p-1 font-bold outline-none" onchange="renderCheckboxes('${fId}','${id}')"><option>Seleccionar Columna...</option>${processedDataSources[id].columns.map(c=>`<option value="${c}">${c}</option>`).join('')}</select><div id="k_${fId}" class="max-h-24 overflow-y-auto custom-scroll space-y-1"></div>`;
            document.getElementById('globalFiltersArea').appendChild(div);
        }
        window.renderCheckboxes = function(fId, dsId) {
            const col = document.getElementById(`c_${fId}`).value; const box = document.getElementById(`k_${fId}`); box.innerHTML = '';
            let vals = new Set(); processedDataSources[dsId].data.forEach(r => { if(r[col]) vals.add(String(r[col]).trim()); });
            Array.from(vals).sort().forEach(v => box.innerHTML += `<label class="flex items-center gap-2 text-[10px] hover:bg-slate-50 p-1 rounded"><input type="checkbox" checked class="ck_${fId} rounded text-indigo-600" value="${v}"><span class="truncate">${v}</span></label>`);
        }

        window.buildWidget = function(cfg=null) {
            document.getElementById('emptyLocal')?.remove();
            let config = cfg;
            if(!config) {
                const dsId = document.getElementById('dsSelector').value;
                if(!dsId) return alert("Selecciona una fuente de datos");
                let filters = []; 
                document.querySelectorAll('[id^="c_gf_"]').forEach(s => { if(s.value) { let fid = s.id.split('_')[2]; let allowed = Array.from(document.querySelectorAll(`.ck_gf_${fid}:checked`)).map(c=>c.value); filters.push({col: s.value, allowed: allowed}); } });
                let targets = Array.from(document.querySelectorAll('.target-val-chk:checked')).map(c=>c.value);
                config = { title: document.getElementById('widgetTitle').value || 'Gráfico Generado', dsId: dsId, x: document.getElementById('axisX').value, y: document.getElementById('axisY').value, agg: document.getElementById('aggType').value, targets: targets, type: document.getElementById('selectedChartType').value, filters: filters };
                savedWidgetsConfig.push(config);
            }

            const wid = 'chart_' + Date.now() + Math.random();
            const grid = document.getElementById('widgetsGrid');
            const card = document.createElement('div');
            card.className = "flip-container w-full h-[400px]"; // Altura fija
            
            card.innerHTML = `<div class="flipper" id="flip_${wid}"><div class="front p-5 flex flex-col bg-white rounded-2xl shadow-sm border border-slate-200"><div class="flex justify-between items-start mb-2"><div><h3 class="font-bold text-slate-800">${config.title}</h3><p class="text-[10px] text-slate-400 uppercase font-bold tracking-wide">${config.agg} por ${config.x}</p></div><div class="flex gap-1"><button onclick="event.stopPropagation(); document.getElementById('flip_${wid}').classList.toggle('flipped')" class="p-1.5 text-slate-400 hover:text-indigo-600 transition"><i class="fas fa-table"></i></button><button onclick="event.stopPropagation(); this.closest('.flip-container').remove()" class="p-1.5 text-slate-400 hover:text-red-500 transition"><i class="fas fa-trash"></i></button></div></div><div class="flex-1 relative w-full h-full min-h-0"><canvas id="${wid}"></canvas></div><p class="text-[10px] text-center text-slate-300 mt-2">Toca para ver datos</p></div><div class="back flex flex-col bg-white rounded-2xl shadow-sm border border-indigo-100 overflow-hidden"><div class="p-3 border-b border-indigo-50 bg-indigo-50/50 flex justify-between items-center"><h3 class="font-bold text-indigo-900 text-xs uppercase">Datos Detallados</h3><button onclick="event.stopPropagation(); document.getElementById('flip_${wid}').classList.toggle('flipped')" class="text-[10px] font-bold text-indigo-600 bg-white border border-indigo-100 px-2 py-1 rounded shadow-sm">Volver</button></div><div class="flex-1 overflow-auto custom-scroll bg-white"><table class="w-full text-xs text-left" id="table_${wid}"></table></div></div></div>`;
            grid.prepend(card);
            
            setTimeout(() => renderChart(config, wid, processedDataSources[config.dsId].data), 50);
            
            document.getElementById('canvasArea3').scrollTop = 0; // Scroll up to see new chart
        }

        function renderChart(cfg, canvasId, data) {
            let fdata = data;
            if(cfg.filters) { cfg.filters.forEach(f => { fdata = fdata.filter(r => { let v = r[f.col] ? String(r[f.col]).trim() : ""; return f.allowed.includes(v); }); }); }
            let groups = {};
            fdata.forEach(r => {
                let k = r[cfg.x] ? String(r[cfg.x]).trim() : '(General)';
                let v = parseFloat(r[cfg.y]) || 0;
                let rawVal = r[cfg.y] ? String(r[cfg.y]).trim() : "";
                if(!groups[k]) groups[k] = { sum: 0, count: 0, hits: 0, valid: 0 };
                groups[k].count++;
                if(cfg.agg === 'percent' || cfg.agg === 'count') {
                    if(cfg.targets && cfg.targets.length > 0) {
                        let match = cfg.targets.some(t => t.toLowerCase().trim() === rawVal.toLowerCase().trim());
                        if(match) { groups[k].hits++; groups[k].valid++; }
                    } else { if(cfg.agg === 'count' && r[cfg.y]) groups[k].valid++; }
                } else { groups[k].sum += v; }
            });

            let labels = Object.keys(groups);
            let vals = labels.map(l => {
                if(cfg.agg === 'percent') return groups[l].count > 0 ? (groups[l].hits / groups[l].count) * 100 : 0;
                if(cfg.agg === 'count') return groups[l].valid;
                if(cfg.agg === 'avg') return groups[l].count > 0 ? groups[l].sum / groups[l].count : 0;
                return groups[l].sum;
            });

            let th = `<thead class="bg-slate-50 text-slate-500 sticky top-0 z-10"><tr><th class="p-2 border-b text-left">Categoría</th><th class="p-2 border-b text-right">Valor</th></tr></thead><tbody>`;
            labels.forEach((l, i) => {
                let display = cfg.agg === 'percent' ? vals[i].toFixed(1) + '%' : vals[i].toLocaleString();
                th += `<tr class="border-b border-slate-50 hover:bg-slate-50"><td class="p-2 font-medium text-slate-700">${l}</td><td class="p-2 text-right font-bold text-slate-900">${display}</td></tr>`;
            });
            th += '</tbody>';
            document.getElementById('table_' + canvasId).innerHTML = th;

            const ctx = document.getElementById(canvasId).getContext('2d');
            
            // Fix: remove scales for circular charts
            let options = {
                responsive: true, maintainAspectRatio: false,
                onClick: (e) => { const card = document.getElementById('flip_' + canvasId); if(card) card.classList.toggle('flipped'); }
            };
            if(cfg.type !== 'doughnut' && cfg.type !== 'pie') {
                options.scales = { y: { beginAtZero: true, max: cfg.agg==='percent'?100:undefined } };
            }

            new Chart(ctx, {
                type: cfg.type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: cfg.agg.toUpperCase(),
                        data: vals,
                        backgroundColor: cfg.type==='line'?'transparent':['#4f46e5','#06b6d4','#f59e0b','#ec4899','#10b981'],
                        borderColor: cfg.type==='line'?'#4f46e5':'white',
                        borderWidth: 2, borderRadius: 4, maxBarThickness: 60
                    }]
                },
                options: options
            });
        }

        // 4. UNIFICAR
        window.toggleAuditMode = function() { window.buildAuditSidebar(); }
        window.buildAuditSidebar = function() {
            const agg = document.getElementById('auditAggType').value;
            const container = document.getElementById('auditMappingContainer'); container.innerHTML = '';
            Object.values(processedDataSources).forEach(ds => {
                let opts = `<option value="">-- Columna --</option>` + ds.columns.map(c => `<option value="${c}">${c}</option>`).join('');
                let extraInputs = (agg === 'percent' || agg === 'count') 
                    ? `<select id="ay_${ds.id}" class="w-full p-1.5 border border-slate-200 rounded-lg text-xs mb-1 outline-none font-medium" onchange="fillVal('${ds.id}')">${opts}</select><div id="av_c_${ds.id}" class="max-h-24 overflow-y-auto bg-slate-50 border border-slate-200 rounded-lg p-2 text-[10px]">Selecciona Valor...</div>`
                    : `<select id="ay_${ds.id}" class="w-full p-1.5 border border-slate-200 rounded-lg text-xs outline-none font-medium">${opts}</select>`;

                container.innerHTML += `<div class="bg-white border border-slate-200 rounded-xl p-3 mb-2 shadow-sm"><div class="flex justify-between font-bold text-xs mb-2 text-slate-800"><span>${ds.name}</span><input type="checkbox" id="inc_${ds.id}" checked class="accent-indigo-600"></div><div class="space-y-2"><label class="text-[10px] text-slate-400 font-bold uppercase block">Agrupar Por</label><select id="ax_${ds.id}" class="w-full p-1.5 border border-slate-200 rounded-lg text-xs outline-none font-medium text-slate-600">${opts}</select><label class="text-[10px] text-slate-400 font-bold uppercase block">Valor/Estado</label>${extraInputs}</div></div>`;
            });
        }

        window.fillVal = function(id) {
            const col = document.getElementById(`ay_${id}`).value; const container = document.getElementById(`av_c_${id}`);
            if(!col) { container.innerHTML='Seleccionar...'; return; }
            let vals = new Set(); processedDataSources[id].data.forEach(r => { if(r[col]) vals.add(String(r[col]).trim()); });
            container.innerHTML = ''; Array.from(vals).sort().forEach(v => container.innerHTML+=`<label class="flex items-center gap-2 p-1 border-b border-slate-100 last:border-0 hover:bg-white"><input type="checkbox" class="av_chk_${id} rounded text-indigo-600" value="${v}"> ${v}</label>`);
        }

        window.generateMergedAudit = function(cfg=null) {
            document.getElementById('emptyAudit')?.remove();
            let config = cfg;
            if(!config) {
                const mode = document.querySelector('input[name="auditMode"]:checked').value;
                const agg = document.getElementById('auditAggType').value;
                let mappings = [];
                Object.values(processedDataSources).forEach(ds => {
                    if(document.getElementById(`inc_${ds.id}`).checked) {
                        let targets = [];
                        if (agg === 'percent' || agg === 'count') { targets = Array.from(document.querySelectorAll(`.av_chk_${ds.id}:checked`)).map(c=>c.value); }
                        mappings.push({ dsId: ds.id, name: ds.name, x: document.getElementById(`ax_${ds.id}`).value, y: document.getElementById(`ay_${ds.id}`).value, targets: targets });
                    }
                });
                if(mappings.length === 0) return alert("Selecciona fuentes.");
                config = { title: document.getElementById('auditTitle').value || 'Unificado', mode: mode, agg: agg, type: document.getElementById('auditChartType').value, mappings: mappings };
                savedAuditWidgetsConfig.push(config);
            }
            const wid = 'aw_'+Date.now()+Math.random();
            const grid = document.getElementById('auditWidgetsGrid');
            const card = document.createElement('div');
            card.className = "flip-container h-96 w-full perspective-1000";
            card.innerHTML = `<div class="flipper" id="f_${wid}"><div class="front p-5 flex flex-col bg-white rounded-2xl shadow-sm border border-slate-200"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-sm text-slate-800">${config.title}</h3><div class="flex gap-2"><button onclick="event.stopPropagation(); document.getElementById('f_${wid}').classList.toggle('flipped')" class="w-8 h-8 rounded-full bg-slate-100 hover:text-blue-600 flex items-center justify-center"><i class="fas fa-table"></i></button><button onclick="event.stopPropagation(); this.closest('.flip-container').remove()" class="w-8 h-8 rounded-full bg-slate-100 hover:text-red-600 flex items-center justify-center"><i class="fas fa-times"></i></button></div></div><div class="flex-1 relative w-full h-full min-h-0"><canvas id="${wid}"></canvas></div></div><div class="back flex flex-col bg-white rounded-2xl shadow-sm border border-emerald-200 overflow-hidden"><div class="p-4 border-b border-emerald-100 bg-emerald-50 flex justify-between items-center"><h3 class="font-bold text-emerald-800">Datos Unificados</h3><button onclick="event.stopPropagation(); document.getElementById('f_${wid}').classList.toggle('flipped')" class="text-xs font-bold text-emerald-600 bg-white px-3 py-1 rounded-full shadow-sm">Volver</button></div><div class="flex-1 overflow-auto bg-white border rounded-lg p-2" id="tb_${wid}"></div></div></div>`;
            grid.prepend(card); 
            setTimeout(() => renderUnifiedChart(config, wid), 100);
            document.getElementById('canvasArea4').scrollTop = 0;
        }

        function renderUnifiedChart(cfg, id) {
            let globalLabels = new Set(); let tableData = {};
            
            cfg.mappings.forEach(map => {
                let data = processedDataSources[map.dsId].data;
                let local = {};
                data.forEach(r => {
                    let k = r[map.x] ? String(r[map.x]).trim() : map.name; globalLabels.add(k);
                    if(!local[k]) local[k] = {sum:0, count:0, hits:0, valid:0};
                    local[k].count++;
                    let v = parseFloat(r[map.y]) || 0; let raw = r[map.y] ? String(r[map.y]).trim() : "";
                    if(cfg.agg === 'percent' || cfg.agg === 'count') { 
                        if(map.targets && map.targets.some(t => t.toLowerCase() === raw.toLowerCase())) { local[k].hits++; local[k].valid++; }
                    } else local[k].sum += v;
                });
                Object.keys(local).forEach(k => {
                    let res = 0;
                    if(cfg.agg === 'percent') res = local[k].count > 0 ? (local[k].hits/local[k].count)*100 : 0;
                    else if(cfg.agg === 'count') res = local[k].valid;
                    else res = local[k].sum;
                    if(!tableData[k]) tableData[k] = {};
                    tableData[k][map.name] = res;
                    // Guardar crudos
                    if(cfg.agg === 'percent') {
                         if(!tableData[k].rawHits) tableData[k].rawHits = 0;
                         if(!tableData[k].rawCount) tableData[k].rawCount = 0;
                         tableData[k].rawHits += local[k].hits;
                         tableData[k].rawCount += local[k].count;
                    } else {
                         if(!tableData[k].rawSum) tableData[k].rawSum = 0;
                         tableData[k].rawSum += (cfg.agg==='count'?local[k].valid:res);
                    }
                });
            });

            let labels = Array.from(globalLabels).sort();
            let datasets = [];
            
            if(cfg.mode === 'compare') {
                cfg.mappings.forEach((map, i) => {
                    let d = labels.map(l => (tableData[l] && tableData[l][map.name]) || 0);
                    const colors = ['#4f46e5','#06b6d4','#f59e0b','#ec4899'];
                    datasets.push({ label: map.name, data: d, backgroundColor: colors[i%4], maxBarThickness: 40, borderRadius: 4 });
                });
            } else {
                let d = labels.map(l => {
                    if(cfg.agg === 'percent') {
                         let h = tableData[l]?.rawHits || 0; let c = tableData[l]?.rawCount || 0;
                         return c > 0 ? (h/c)*100 : 0;
                    } else { return tableData[l]?.rawSum || 0; }
                });
                datasets.push({ label: 'Total Unificado', data: d, backgroundColor: '#10b981', maxBarThickness: 50, borderRadius: 4 });
            }
            
            let th = `<table class="w-full text-xs text-left"><thead class="bg-slate-100 text-slate-600"><tr><th>Categoría</th>${cfg.mappings.map(m=>`<th class="text-right">${m.name.substring(0,8)}...</th>`).join('')}</tr></thead><tbody>`;
            labels.forEach(l => { th += `<tr class="border-b"><td class="p-2 font-medium">${l}</td>${cfg.mappings.map(m=>`<td class="p-2 text-right">${((tableData[l]&&tableData[l][m.name])||0).toFixed(1)}</td>`).join('')}</tr>`; });
            th += '</tbody></table>'; document.getElementById('tb_' + id).innerHTML = th;

            const ctx = document.getElementById(id).getContext('2d');
            let options = { 
                responsive: true, maintainAspectRatio: false, 
                onClick: (e) => { const card = document.getElementById('f_' + id); if(card) card.classList.toggle('flipped'); }
            };
            if(cfg.type !== 'doughnut') options.scales = { y: { beginAtZero: true, max: cfg.agg==='percent'?100:undefined } };

            new Chart(ctx, { type: cfg.type, data: { labels: labels, datasets: datasets }, options: options });
        }

        // SAVE & LOAD
        window.saveToFirebase = async function() {
            try {
                await addDoc(collection(db, "reportes_v24"), {
                    nombre: document.getElementById('projectName3').value || document.getElementById('projectName4').value || 'Reporte Final', 
                    date: serverTimestamp(),
                    sources: JSON.stringify(processedDataSources), 
                    widgetsLocal: savedWidgetsConfig, 
                    widgetsGlobal: savedAuditWidgetsConfig
                });
                alert("Guardado Exitosamente en Nube"); loadProjs();
            } catch(e) { console.error(e); alert("Guardado (Local temporal)"); }
        }

        async function loadProjs() {
            try {
                const snaps = await getDocs(query(collection(db, "reportes_v24"), orderBy("date", "desc")));
                const list = document.getElementById('cloudProjectsList'); list.innerHTML = '';
                snaps.forEach(doc => {
                    const d = doc.data();
                    const b = document.createElement('button'); b.className = "w-full text-left p-2 border border-slate-200 rounded-lg text-xs hover:bg-indigo-50 transition";
                    b.innerText = `${d.nombre} (${new Date(d.date.seconds*1000).toLocaleDateString()})`;
                    b.onclick = () => {
                        processedDataSources = JSON.parse(d.sources); savedWidgetsConfig = d.widgetsLocal||[]; savedAuditWidgetsConfig = d.widgetsGlobal||[];
                        const dsSel = document.getElementById('dsSelector'); dsSel.innerHTML = '';
                        Object.values(processedDataSources).forEach(dx => dsSel.innerHTML += `<option value="${dx.id}">${dx.name}</option>`);
                        document.getElementById('widgetsGrid').innerHTML = ''; savedWidgetsConfig.forEach(c => window.buildWidget(c));
                        document.getElementById('auditWidgetsGrid').innerHTML = ''; savedAuditWidgetsConfig.forEach(c => window.generateMergedAudit(c));
                        ['tab2','tab3','tab4'].forEach(id => { document.getElementById(id).disabled=false; document.getElementById(id).classList.remove('tab-disabled'); });
                        switchView(3);
                    };
                    list.appendChild(b);
                });
            } catch(e) { console.log("Offline mode"); }
        }
    </script>
</body>
</html>
