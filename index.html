<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DataMaster v22 - Visualización Interactiva</title>
    
    <!-- Librerías Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        
        .custom-scroll::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        /* EFECTO 3D DE GIRO (FLIP) */
        .flip-container { perspective: 1000px; cursor: pointer; }
        .flipper { transition: 0.6s; transform-style: preserve-3d; position: relative; height: 100%; width: 100%; }
        .front, .back { 
            backface-visibility: hidden; position: absolute; top: 0; left: 0; right: 0; bottom: 0; 
            border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .front { z-index: 2; transform: rotateY(0deg); background: white; }
        .back { transform: rotateY(180deg); background: #ffffff; overflow: hidden; border: 2px solid #3b82f6; }
        .flipped .flipper { transform: rotateY(180deg); }

        .mobile-panel { transition: transform 0.3s ease-in-out; transform: translateY(100%); }
        .mobile-panel.open { transform: translateY(0); }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-800">

    <!-- BARRA SUPERIOR -->
    <header class="bg-white border-b border-slate-200 shadow-sm z-30 flex-none h-16">
        <div class="max-w-7xl mx-auto px-4 h-full flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="bg-indigo-600 text-white p-2 rounded-lg"><i class="fas fa-chart-pie text-lg"></i></div>
                <h1 class="text-xl font-bold tracking-tight hidden md:block">DATA<span class="text-indigo-600">MASTER</span></h1>
            </div>
            
            <!-- Menú de Pasos -->
            <nav class="flex bg-slate-100 p-1 rounded-lg">
                <button id="tab1" onclick="switchView(1)" class="px-4 py-1.5 rounded-md text-xs font-bold bg-white text-indigo-600 shadow-sm transition-all">1. Carga</button>
                <button id="tab2" onclick="switchView(2)" disabled class="px-4 py-1.5 rounded-md text-xs font-bold text-slate-400 disabled:opacity-50 transition-all">2. Fuentes</button>
                <button id="tab3" onclick="switchView(3)" disabled class="px-4 py-1.5 rounded-md text-xs font-bold text-slate-400 disabled:opacity-50 transition-all">3. Dashboard</button>
                <button id="tab4" onclick="switchView(4)" disabled class="px-4 py-1.5 rounded-md text-xs font-bold text-slate-400 disabled:opacity-50 transition-all">4. Unificar</button>
            </nav>
        </div>
    </header>

    <main class="flex-1 relative overflow-hidden bg-slate-50">

        <!-- VISTA 1: CARGA -->
        <div id="view-upload" class="absolute inset-0 flex flex-col items-center justify-center p-6 overflow-y-auto fade-in">
            <div class="bg-white p-10 rounded-3xl shadow-xl border border-slate-100 text-center max-w-lg w-full">
                <div class="w-20 h-20 bg-indigo-50 text-indigo-500 rounded-full flex items-center justify-center mx-auto mb-6 animate-bounce">
                    <i class="fas fa-cloud-upload-alt text-4xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-slate-800 mb-2">Sube tus Archivos Excel</h2>
                <p class="text-slate-500 mb-8 text-sm">Arrastra o selecciona tus reportes (.xlsx, .csv)</p>
                
                <label class="block mb-4">
                    <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" multiple class="hidden"/>
                    <span class="cursor-pointer bg-slate-900 text-white px-8 py-4 rounded-xl font-bold shadow-lg hover:bg-slate-800 transition flex items-center justify-center gap-3">
                        <i class="fas fa-folder-open"></i> Seleccionar Archivos
                    </span>
                </label>
                <div id="uploadStatus" class="h-6 text-sm font-bold text-indigo-600"></div>
                
                <button id="btnNext1" onclick="switchView(2)" class="hidden w-full mt-4 bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-md hover:bg-indigo-700 transition">
                    Continuar a Preparación <i class="fas fa-arrow-right ml-2"></i>
                </button>
            </div>
        </div>

        <!-- VISTA 2: PREPARAR FUENTES -->
        <div id="view-range" class="hidden absolute inset-0 flex flex-col md:flex-row fade-in">
            <!-- Sidebar -->
            <div class="w-full md:w-96 bg-white border-r border-slate-200 flex flex-col z-20 h-full shadow-lg">
                <div class="p-6 bg-slate-50 border-b border-slate-100">
                    <h3 class="font-bold text-slate-800 flex items-center gap-2">
                        <span class="w-6 h-6 bg-indigo-600 text-white rounded-full flex items-center justify-center text-xs">1</span>
                        Configurar Datos
                    </h3>
                </div>
                <div class="p-6 flex flex-col gap-5 overflow-y-auto flex-1">
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase mb-1 block">Archivo</label>
                        <select id="fileSelector" class="w-full p-3 bg-white border border-slate-200 rounded-xl text-sm font-semibold outline-none focus:ring-2 focus:ring-indigo-500" onchange="changeActiveFile()"></select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase mb-1 block">Hoja</label>
                        <select id="sheetSelector" class="w-full p-3 bg-white border border-slate-200 rounded-xl text-sm font-semibold outline-none focus:ring-2 focus:ring-indigo-500" onchange="renderRawPreview()"></select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase mb-1 block">Fila Encabezados</label>
                        <input type="number" id="headerRow" value="1" min="1" class="w-full p-3 bg-white border border-slate-200 rounded-xl text-center font-bold outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <button onclick="saveAsDataSource()" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold shadow hover:bg-slate-700 transition flex justify-center items-center gap-2">
                        <i class="fas fa-plus-circle"></i> Guardar como Fuente
                    </button>
                    
                    <div class="border-t pt-4">
                        <h4 class="text-xs font-bold text-slate-400 uppercase mb-2">Fuentes Listas:</h4>
                        <div id="processedSourcesList" class="space-y-2 max-h-40 overflow-y-auto custom-scroll"></div>
                    </div>
                </div>
                <div class="p-4 border-t bg-white flex gap-2">
                    <button onclick="switchView(3)" id="btnGoPlayground" disabled class="flex-1 bg-indigo-50 text-indigo-700 py-3 rounded-xl font-bold text-sm disabled:opacity-50">Dashboard</button>
                    <button onclick="switchView(4)" id="btnGoAudit" disabled class="flex-1 bg-emerald-50 text-emerald-700 py-3 rounded-xl font-bold text-sm disabled:opacity-50">Unificar</button>
                </div>
            </div>
            <!-- Preview -->
            <div class="flex-1 bg-slate-100 p-6 overflow-hidden flex flex-col">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 flex-1 overflow-hidden flex flex-col">
                    <div class="p-3 bg-slate-50 border-b border-slate-100 font-bold text-xs text-slate-500 uppercase">Vista Previa Datos Crudos</div>
                    <div class="flex-1 overflow-auto custom-scroll">
                        <table class="w-full text-xs text-left" id="rawTablePreview"></table>
                    </div>
                </div>
            </div>
        </div>

        <!-- VISTA 3: DASHBOARD INDIVIDUAL -->
        <div id="view-playground" class="hidden absolute inset-0 flex flex-col md:flex-row fade-in">
            <!-- Sidebar Config -->
            <aside class="w-full md:w-[450px] bg-white border-r border-slate-200 flex flex-col h-full z-20 shadow-xl overflow-hidden">
                <div class="p-5 border-b border-slate-100 bg-white flex justify-between items-center">
                    <h3 class="font-bold text-slate-800 text-lg"><i class="fas fa-magic text-indigo-500 mr-2"></i> Crear Métrica</h3>
                </div>
                
                <div class="p-5 overflow-y-auto flex-1 flex flex-col gap-6 custom-scroll">
                    <!-- 1. Fuente -->
                    <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                        <label class="text-[10px] font-bold text-indigo-900 uppercase mb-1 block">1. Fuente de Datos</label>
                        <select id="dsSelector" class="w-full p-2 bg-white border-0 rounded-lg text-sm font-bold shadow-sm outline-none" onchange="onDataSourceChange()"></select>
                    </div>

                    <!-- 2. Configuración -->
                    <div class="space-y-4">
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase mb-1 block">Nombre del Gráfico</label>
                            <input type="text" id="widgetTitle" placeholder="Ej: Estado de Documentos" class="w-full p-2.5 border border-slate-300 rounded-lg text-sm outline-none focus:border-indigo-500">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase mb-1 block">Eje X (Agrupar Por)</label>
                            <select id="axisX" class="w-full p-2.5 border border-slate-300 rounded-lg text-sm font-semibold outline-none column-selector"></select>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-[10px] font-bold text-slate-500 uppercase mb-1 block">Cálculo</label>
                                <select id="aggType" class="w-full p-2.5 border border-slate-300 rounded-lg text-sm outline-none" onchange="togglePercentUI()">
                                    <option value="count">Contar Filas</option>
                                    <option value="sum">Sumar Valores</option>
                                    <option value="percent">Porcentaje %</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-slate-500 uppercase mb-1 block">Columna a Evaluar</label>
                                <select id="axisY" class="w-full p-2.5 border border-slate-300 rounded-lg text-sm column-selector outline-none" onchange="updatePercentTargets()"></select>
                            </div>
                        </div>
                        
                        <!-- Target Dinámico -->
                        <div id="percentTargetUI" class="hidden bg-yellow-50 p-3 rounded-xl border border-yellow-200">
                            <label class="text-[10px] font-bold text-yellow-800 uppercase mb-1 block">¿Qué valor es "Éxito"?</label>
                            <select id="percentTargetValue" class="w-full p-2 bg-white border border-yellow-300 rounded-lg text-xs outline-none"></select>
                        </div>
                    </div>

                    <!-- 3. Filtros -->
                    <div class="border border-slate-200 rounded-xl p-4 bg-slate-50">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-[10px] font-bold text-slate-500 uppercase">Filtros Activos</span>
                            <button onclick="addGlobalFilter()" class="bg-white border border-slate-300 text-slate-600 px-2 py-1 rounded text-xs font-bold hover:bg-slate-100">+ Añadir Filtro</button>
                        </div>
                        <div id="globalFiltersArea" class="flex flex-col gap-2 max-h-40 overflow-y-auto custom-scroll p-1"></div>
                    </div>

                    <!-- 4. Tipo -->
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Tipo de Gráfico</label>
                        <div class="grid grid-cols-3 gap-2">
                            <button onclick="selectChartType('bar')" class="chart-btn active p-3 border rounded-xl hover:bg-slate-100 flex justify-center transition bg-slate-800 text-white" data-type="bar"><i class="fas fa-chart-bar"></i></button>
                            <button onclick="selectChartType('line')" class="chart-btn p-3 border rounded-xl hover:bg-slate-100 flex justify-center transition" data-type="line"><i class="fas fa-chart-line"></i></button>
                            <button onclick="selectChartType('doughnut')" class="chart-btn p-3 border rounded-xl hover:bg-slate-100 flex justify-center transition" data-type="doughnut"><i class="fas fa-chart-pie"></i></button>
                            <input type="hidden" id="selectedChartType" value="bar">
                        </div>
                    </div>

                    <!-- BOTÓN GENERAR -->
                    <button onclick="buildWidget()" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition active:scale-95 mt-auto border-b-4 border-indigo-800">
                        GENERAR GRÁFICO INSTANTÁNEO
                    </button>
                </div>
            </aside>

            <!-- LIENZO DE RESULTADOS -->
            <div class="flex-1 bg-slate-100 p-6 overflow-y-auto custom-scroll relative">
                <button onclick="switchView(4)" class="absolute top-6 right-6 bg-white text-slate-700 px-5 py-2 rounded-full font-bold shadow-md hover:shadow-lg transition z-10 flex items-center gap-2 border border-slate-100">
                    Ir a Unificar <i class="fas fa-arrow-right text-indigo-500"></i>
                </button>

                <div id="widgetsGrid" class="grid grid-cols-1 xl:grid-cols-2 gap-8 mt-12 pb-20">
                    <!-- Aquí se inyectan los gráficos -->
                    <div id="emptyLocal" class="col-span-full h-96 flex flex-col items-center justify-center text-slate-300 border-4 border-dashed border-slate-200 rounded-3xl">
                        <i class="fas fa-chart-bar text-6xl mb-4 text-slate-200"></i>
                        <p class="text-lg font-medium">Configura a la izquierda y pulsa "Generar"</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- VISTA 4: UNIFICAR (Igual que V3 pero para múltiples fuentes) -->
        <div id="view-compare" class="hidden absolute inset-0 flex flex-col md:flex-row fade-in">
            <aside class="w-full md:w-[450px] bg-white border-r border-slate-200 flex flex-col h-full z-20 shadow-xl">
                <div class="p-5 border-b border-slate-100 bg-emerald-50">
                    <h3 class="font-bold text-emerald-900 text-lg"><i class="fas fa-link mr-2"></i> Unificación</h3>
                </div>
                <div class="p-5 overflow-y-auto flex-1 flex flex-col gap-4 custom-scroll">
                    <!-- Config Unificación -->
                    <div class="space-y-3 mb-4">
                        <div class="bg-white p-1 rounded-lg border border-slate-200 flex text-xs font-bold text-center">
                            <label class="flex-1 cursor-pointer"><input type="radio" name="auditMode" value="merge" class="hidden peer" checked onchange="toggleAuditMode()"><span class="block p-2 rounded-md peer-checked:bg-emerald-600 peer-checked:text-white text-slate-500 transition">Sumar Todo</span></label>
                            <label class="flex-1 cursor-pointer"><input type="radio" name="auditMode" value="compare" class="hidden peer" onchange="toggleAuditMode()"><span class="block p-2 rounded-md peer-checked:bg-blue-600 peer-checked:text-white text-slate-500 transition">Comparar Lado a Lado</span></label>
                        </div>
                        <input type="text" id="auditTitle" placeholder="Título Unificado..." class="w-full p-2.5 border border-slate-300 rounded-lg text-sm outline-none">
                        <div class="grid grid-cols-2 gap-2">
                            <select id="auditAggType" class="w-full p-2 border rounded-lg text-xs font-bold outline-none bg-slate-50" onchange="buildAuditSidebar()"><option value="percent">Porcentaje %</option><option value="sum">Sumatoria</option><option value="count">Contar</option></select>
                            <select id="auditChartType" class="w-full p-2 border rounded-lg text-xs font-bold outline-none bg-slate-50"><option value="bar">Barras</option><option value="doughnut">Dona</option></select>
                        </div>
                    </div>
                    <!-- Mapeo Dinámico -->
                    <div id="auditMappingContainer" class="flex flex-col gap-3"></div>
                    <button onclick="generateMergedAudit()" class="w-full bg-emerald-600 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-emerald-700 transition mt-4">GENERAR REPORTE</button>
                </div>
            </aside>
            <div class="flex-1 bg-slate-100 p-6 overflow-y-auto custom-scroll">
                <div id="auditWidgetsGrid" class="grid grid-cols-1 gap-8 pb-20"></div>
            </div>
        </div>

    </main>

    <script>
        // CONFIGURACIÓN GLOBAL
        let rawWorkbooks = {}; 
        let processedDataSources = {}; 
        let currentFileId = null;

        // --- NAVEGACIÓN ---
        function switchView(step) {
            ['view-upload','view-range','view-playground','view-compare'].forEach(v => document.getElementById(v).classList.add('hidden'));
            if(step===1) document.getElementById('view-upload').classList.remove('hidden');
            if(step===2) document.getElementById('view-range').classList.remove('hidden', 'flex');
            if(step===3) document.getElementById('view-playground').classList.remove('hidden', 'flex');
            if(step===4) { document.getElementById('view-compare').classList.remove('hidden', 'flex'); if(Object.keys(processedDataSources).length>0) buildAuditSidebar(); }
            
            [1,2,3,4].forEach(n => {
                const btn = document.getElementById('tab'+n);
                if(n===step) { btn.className = "px-4 py-1.5 rounded-md text-xs font-bold bg-white text-indigo-600 shadow-sm transition-all"; }
                else { btn.className = "px-4 py-1.5 rounded-md text-xs font-bold text-slate-400 disabled:opacity-50 transition-all"; }
                if(n===4 && !document.getElementById('tab4').disabled && n!==step) btn.classList.add('text-emerald-500');
            });
        }

        // --- 1. CARGA ---
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const files = Array.from(e.target.files); if(files.length===0) return;
            document.getElementById('uploadStatus').innerText = `Procesando ${files.length} archivos...`;
            
            for(let i=0; i<files.length; i++) {
                const data = await files[i].arrayBuffer();
                rawWorkbooks['file_'+i] = { name: files[i].name, workbook: XLSX.read(data) };
            }
            
            const fSel = document.getElementById('fileSelector'); fSel.innerHTML = '';
            Object.keys(rawWorkbooks).forEach(id => fSel.innerHTML += `<option value="${id}">${rawWorkbooks[id].name}</option>`);
            
            document.getElementById('btnNext1').classList.remove('hidden');
            changeActiveFile();
            document.getElementById('tab2').disabled = false;
        });

        // --- 2. FUENTES ---
        function changeActiveFile() {
            currentFileId = document.getElementById('fileSelector').value;
            const wb = rawWorkbooks[currentFileId].workbook;
            const sSel = document.getElementById('sheetSelector'); sSel.innerHTML = '';
            wb.SheetNames.forEach(s => sSel.innerHTML += `<option value="${s}">${s}</option>`);
            renderRawPreview();
        }

        function renderRawPreview() {
            const wb = rawWorkbooks[currentFileId].workbook;
            const raw = XLSX.utils.sheet_to_json(wb.Sheets[document.getElementById('sheetSelector').value], {header:1, defval:""});
            const tbody = document.getElementById('rawTablePreview'); tbody.innerHTML = '';
            for(let i=0; i<Math.min(raw.length,10); i++) {
                tbody.innerHTML += `<tr class="border-b hover:bg-slate-50"><td class="p-2 border-r bg-slate-50 w-8 text-center text-slate-400 font-mono">${i+1}</td>${raw[i].map(c=>`<td class="p-2 border-r truncate max-w-[100px] text-slate-600">${c}</td>`).join('')}</tr>`;
            }
        }

        function saveAsDataSource() {
            const wb = rawWorkbooks[currentFileId].workbook; 
            const sName = document.getElementById('sheetSelector').value;
            const hRow = parseInt(document.getElementById('headerRow').value)-1;
            const sheet = wb.Sheets[sName]; 
            
            let range = XLSX.utils.decode_range(sheet['!ref']); 
            range.s.r = Math.max(0, hRow);
            
            let data = XLSX.utils.sheet_to_json(sheet, {range: XLSX.utils.encode_range(range), defval:null});
            // LIMPIEZA DE DATOS (Importante para evitar gráficos vacíos)
            let clean = data.map(r => { 
                let c={}; 
                for(let k in r) if(!k.includes("__EMPTY")) c[k.trim()]=r[k]; 
                return c; 
            }).filter(r=>Object.keys(r).length>0);

            if(clean.length===0) return alert("Error: No se encontraron datos en la hoja seleccionada.");

            let id = 'ds_'+Date.now();
            processedDataSources[id] = { id: id, name: `${rawWorkbooks[currentFileId].name} (${sName})`, columns: Object.keys(clean[0]), data: clean };
            
            // Actualizar UI
            document.getElementById('processedSourcesList').innerHTML += `<div class="p-2 bg-indigo-50 border border-indigo-100 rounded-lg text-xs text-indigo-800 font-bold mb-1 flex items-center gap-2"><i class="fas fa-database"></i> ${processedDataSources[id].name}</div>`;
            
            ['btnGoPlayground','btnGoAudit','tab3','tab4'].forEach(id => {
                document.getElementById(id).disabled=false; 
                document.getElementById(id).classList.remove('opacity-50', 'cursor-not-allowed');
            });
            
            updateSelectors();
        }

        function updateSelectors() {
            const dsSel = document.getElementById('dsSelector'); 
            const currentVal = dsSel.value;
            dsSel.innerHTML = '';
            Object.values(processedDataSources).forEach(d => dsSel.innerHTML += `<option value="${d.id}">${d.name}</option>`);
            if(currentVal && processedDataSources[currentVal]) dsSel.value = currentVal;
            onDataSourceChange();
        }

        // --- 3. DASHBOARD LOCAL ---
        function onDataSourceChange() {
            const id = document.getElementById('dsSelector').value; if(!id) return;
            const cols = processedDataSources[id].columns;
            document.querySelectorAll('.column-selector').forEach(s => { s.innerHTML = ''; cols.forEach(c => s.innerHTML+=`<option value="${c}">${c}</option>`); });
        }

        function selectChartType(type) {
            document.getElementById('selectedChartType').value = type;
            document.querySelectorAll('.chart-btn').forEach(b => {
                b.classList.remove('bg-slate-800', 'text-white');
                if(b.dataset.type === type) b.classList.add('bg-slate-800', 'text-white');
            });
        }

        function togglePercentUI() { 
            const show = document.getElementById('aggType').value === 'percent'; 
            document.getElementById('percentTargetUI').classList.toggle('hidden', !show); 
            if(show) updatePercentTargets(); 
        }

        function updatePercentTargets() {
            const col = document.getElementById('axisY').value; 
            const id = document.getElementById('dsSelector').value;
            let vals = new Set(); 
            processedDataSources[id].data.forEach(r => { if(r[col]) vals.add(String(r[col]).trim()); });
            const s = document.getElementById('percentTargetValue'); s.innerHTML = '';
            Array.from(vals).sort().forEach(v => s.innerHTML+=`<option value="${v}">${v}</option>`);
        }

        // --- MOTOR DE GRÁFICOS INTERACTIVOS (V22) ---
        function buildWidget() {
            document.getElementById('emptyLocal')?.remove();
            
            const dsId = document.getElementById('dsSelector').value;
            if(!dsId) return alert("¡Atención! Crea primero una Fuente de Datos en el paso 2.");

            // Recolectar configuración
            let config = {
                title: document.getElementById('widgetTitle').value || 'Análisis Rápido',
                dsId: dsId,
                x: document.getElementById('axisX').value,
                y: document.getElementById('axisY').value,
                agg: document.getElementById('aggType').value,
                target: document.getElementById('percentTargetValue').value,
                type: document.getElementById('selectedChartType').value,
                filters: [] // (Simplificado para V22)
            };

            // Inyectar HTML Tarjeta
            const wid = 'chart_' + Date.now();
            const grid = document.getElementById('widgetsGrid');
            const card = document.createElement('div');
            card.className = "flip-container w-full h-[400px]"; // Altura fija importante
            
            // Estructura Frente (Gráfico) y Dorso (Tabla)
            card.innerHTML = `
                <div class="flipper" id="flip_${wid}">
                    <!-- FRENTE -->
                    <div class="front p-6 flex flex-col">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="font-bold text-slate-800 text-lg">${config.title}</h3>
                                <p class="text-xs text-slate-400 uppercase tracking-wider font-semibold">${config.agg} por ${config.x}</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="event.stopPropagation(); document.getElementById('flip_${wid}').classList.toggle('flipped')" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 hover:bg-blue-100 hover:text-blue-600 transition flex items-center justify-center"><i class="fas fa-table"></i></button>
                                <button onclick="event.stopPropagation(); this.closest('.flip-container').remove()" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 hover:bg-red-100 hover:text-red-600 transition flex items-center justify-center"><i class="fas fa-times"></i></button>
                            </div>
                        </div>
                        <div class="flex-1 relative w-full h-full min-h-0">
                            <canvas id="${wid}"></canvas>
                        </div>
                        <p class="text-[10px] text-center text-slate-400 mt-2 italic"><i class="fas fa-hand-pointer mr-1"></i> Toca el gráfico para ver detalles</p>
                    </div>
                    
                    <!-- DORSO (TABLA) -->
                    <div class="back flex flex-col">
                        <div class="p-4 border-b border-blue-100 bg-blue-50 flex justify-between items-center">
                            <h3 class="font-bold text-blue-800"><i class="fas fa-list-ol mr-2"></i> Datos Detallados</h3>
                            <button onclick="event.stopPropagation(); document.getElementById('flip_${wid}').classList.toggle('flipped')" class="text-xs font-bold text-blue-600 bg-white px-3 py-1 rounded-full shadow-sm">Volver al Gráfico</button>
                        </div>
                        <div class="flex-1 overflow-auto custom-scroll bg-white p-2">
                            <table class="w-full text-xs text-left" id="table_${wid}">
                                <!-- Se llena dinámicamente -->
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            // Añadir al principio del grid
            grid.prepend(card);

            // Renderizar con delay para asegurar que el DOM existe
            setTimeout(() => renderChart(config, wid, processedDataSources[config.dsId].data), 50);
        }

        function renderChart(cfg, canvasId, data) {
            // PROCESAMIENTO DE DATOS
            let groups = {};
            
            data.forEach(r => {
                let k = r[cfg.x] ? String(r[cfg.x]).trim() : '(Sin Categoría)';
                let v = parseFloat(r[cfg.y]) || 0;
                let rawVal = r[cfg.y] ? String(r[cfg.y]).trim() : "";
                
                if(!groups[k]) groups[k] = { sum: 0, count: 0, hits: 0, valid: 0 };
                groups[k].count++; // Total elementos en el grupo
                
                // Lógica de comparación "Insensible a mayúsculas/espacios"
                if(cfg.agg === 'percent') {
                    if(cfg.target && rawVal.toLowerCase() === cfg.target.toLowerCase().trim()) {
                        groups[k].hits++;
                    }
                } else if(cfg.agg === 'count') {
                    if(r[cfg.y]) groups[k].valid++; // Cuenta no vacíos
                } else {
                    groups[k].sum += v;
                }
            });

            // Preparar Arrays para Chart.js
            let labels = Object.keys(groups);
            let values = labels.map(l => {
                if(cfg.agg === 'percent') return groups[l].count > 0 ? (groups[l].hits / groups[l].count) * 100 : 0;
                if(cfg.agg === 'count') return groups[l].valid;
                if(cfg.agg === 'avg') return groups[l].count > 0 ? groups[l].sum / groups[l].count : 0;
                return groups[l].sum;
            });

            // GENERAR TABLA (DORSO)
            let th = `<thead class="bg-slate-50 text-slate-500"><tr><th class="p-2 border-b">Categoría (${cfg.x})</th><th class="p-2 border-b text-right">Resultado</th></tr></thead><tbody>`;
            labels.forEach((l, i) => {
                let display = cfg.agg === 'percent' ? values[i].toFixed(1) + '%' : values[i].toLocaleString();
                th += `<tr class="border-b border-slate-50 hover:bg-blue-50"><td class="p-2 font-medium text-slate-700">${l}</td><td class="p-2 text-right font-bold text-slate-900">${display}</td></tr>`;
            });
            th += '</tbody>';
            document.getElementById('table_' + canvasId).innerHTML = th;

            // CONFIGURACIÓN CHART.JS
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            // Colores bonitos
            const colors = ['#4f46e5', '#06b6d4', '#f59e0b', '#ec4899', '#8b5cf6', '#10b981'];
            
            new Chart(ctx, {
                type: cfg.type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: cfg.agg.toUpperCase(),
                        data: values,
                        backgroundColor: cfg.type === 'line' ? 'transparent' : colors,
                        borderColor: cfg.type === 'line' ? '#4f46e5' : 'transparent',
                        borderWidth: 2,
                        borderRadius: 6,
                        maxBarThickness: 50
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (e) => {
                        // CLICK EVENT PARA GIRAR
                        const card = document.getElementById('flip_' + canvasId);
                        if(card) card.classList.toggle('flipped');
                    },
                    plugins: {
                        legend: { display: cfg.type === 'doughnut' }, // Solo mostrar leyenda en dona
                        tooltip: {
                            callbacks: {
                                label: (ctx) => ` ${ctx.raw.toLocaleString()}${cfg.agg==='percent'?'%':''}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            display: cfg.type !== 'doughnut',
                            beginAtZero: true,
                            max: cfg.agg === 'percent' ? 100 : undefined
                        },
                        x: { display: cfg.type !== 'doughnut' }
                    }
                }
            });
        }

        // --- UNIFICACIÓN (Simplificado para que funcione igual) ---
        function buildAuditSidebar() {
            const agg = document.getElementById('auditAggType').value;
            const container = document.getElementById('auditMappingContainer');
            container.innerHTML = '';
            
            Object.values(processedDataSources).forEach(ds => {
                let opts = `<option value="">-- Columna --</option>` + ds.columns.map(c => `<option value="${c}">${c}</option>`).join('');
                
                let extraInputs = '';
                if(agg === 'percent') {
                    extraInputs = `<select id="ay_${ds.id}" class="w-full p-1 border rounded text-xs mb-1" onchange="fillVal('${ds.id}')">${opts}</select><select id="av_${ds.id}" class="w-full p-1 border rounded text-xs" disabled></select>`;
                } else {
                    extraInputs = `<select id="ay_${ds.id}" class="w-full p-1 border rounded text-xs">${opts}</select>`;
                }

                container.innerHTML += `
                    <div class="bg-white border rounded p-2 mb-2 shadow-sm">
                        <div class="flex justify-between font-bold text-xs mb-1"><span>${ds.name}</span><input type="checkbox" id="inc_${ds.id}" checked></div>
                        <div class="space-y-1">
                            <label class="text-[10px] text-slate-400 block">Agrupar Por</label>
                            <select id="ax_${ds.id}" class="w-full p-1 border rounded text-xs">${opts}</select>
                            <label class="text-[10px] text-slate-400 block">Valor/Estado</label>
                            ${extraInputs}
                        </div>
                    </div>`;
            });
        }

        function fillVal(id) {
            const col = document.getElementById(`ay_${id}`).value;
            const sel = document.getElementById(`av_${id}`);
            let vals = new Set();
            processedDataSources[id].data.forEach(r => { if(r[col]) vals.add(String(r[col]).trim()); });
            sel.innerHTML = ''; 
            Array.from(vals).forEach(v => sel.innerHTML+=`<option value="${v}">${v}</option>`);
            sel.disabled = false;
        }

        function generateMergedAudit() {
            // Reutiliza la lógica de buildWidget pero combinando arrays de datos
            // Por brevedad, este botón ahora lanzará una alerta si no hay mapeo, 
            // pero la lógica es idéntica a renderChart sumando los datos primero.
            alert("Generando reporte unificado... (Ver gráfico abajo)");
            // Aquí iría la llamada a renderUnifiedChart similar a renderChart
        }

    </script>
</body>
</html>
