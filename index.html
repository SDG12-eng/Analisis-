<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Data Workspace v12 - Cross Audit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .tab-active { border-bottom: 3px solid #3b82f6; color: #1d4ed8; font-weight: bold; background-color: white;}
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .flip-container { perspective: 1000px; }
        .flipper { transition: 0.6s; transform-style: preserve-3d; position: relative; height: 100%; width: 100%; }
        .front, .back { backface-visibility: hidden; position: absolute; top: 0; left: 0; right: 0; bottom: 0; }
        .front { z-index: 2; transform: rotateY(0deg); }
        .back { transform: rotateY(180deg); background: white; overflow: auto; }
        .flipped .flipper { transform: rotateY(180deg); }
    </style>
</head>
<body class="bg-slate-100 font-sans h-screen flex flex-col overflow-hidden">

    <header class="bg-gray-900 text-white p-4 shadow-lg flex justify-between items-center z-20">
        <h1 class="text-xl font-bold tracking-wider"><i class="fas fa-database text-blue-400 mr-2"></i> MULTI<span class="font-light">WORKSPACE</span></h1>
        <div class="flex gap-2 text-sm">
            <button id="tab1" class="px-4 py-2 rounded-t-lg tab-active transition" onclick="switchView(1)">1. Subir</button>
            <button id="tab2" class="px-4 py-2 rounded-t-lg text-slate-400 hover:text-white transition" onclick="switchView(2)" disabled>2. Fuentes</button>
            <button id="tab3" class="px-4 py-2 rounded-t-lg text-slate-400 hover:text-white transition" onclick="switchView(3)" disabled>3. Dashboard KPI</button>
            <button id="tab4" class="px-4 py-2 rounded-t-lg text-emerald-400 font-bold hover:text-emerald-300 transition" onclick="switchView(4)" disabled><i class="fas fa-balance-scale mr-1"></i> 4. Auditor칤a Cruzada</button>
        </div>
    </header>

    <main class="flex-1 relative overflow-hidden">

        <div id="view-upload" class="absolute inset-0 flex flex-col items-center p-10 bg-slate-50 overflow-y-auto">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full max-w-5xl">
                <div class="bg-white p-10 rounded-2xl shadow border border-slate-200 text-center flex flex-col justify-center">
                    <i class="fas fa-file-excel text-6xl text-blue-500 mb-6"></i>
                    <h2 class="text-2xl font-bold text-slate-800 mb-2">Subir Excels</h2>
                    <p class="text-xs text-slate-500 mb-4">Sube uno o varios archivos para analizarlos o compararlos.</p>
                    <label class="cursor-pointer bg-blue-50 border-2 border-dashed border-blue-300 rounded-xl p-8 block hover:bg-blue-100 transition">
                        <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" multiple class="hidden"/>
                        <span class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold shadow-md hover:bg-blue-700 transition"><i class="fas fa-upload mr-2"></i> Seleccionar Archivo(s)</span>
                    </label>
                    <div id="uploadStatus" class="mt-4 text-sm font-bold text-blue-600"></div>
                </div>
                <div class="bg-white p-8 rounded-2xl shadow border border-slate-200 flex flex-col">
                    <h2 class="text-xl font-bold text-slate-800 mb-2"><i class="fas fa-cloud-download-alt text-blue-500 mr-2"></i> Nube Firebase</h2>
                    <div id="cloudProjectsList" class="flex-1 overflow-y-auto space-y-3 bg-slate-50 p-4 rounded border mt-2 custom-scroll">
                        <div class="text-center text-slate-400 mt-10"><i class="fas fa-spinner fa-spin text-2xl mb-2"></i><br>Cargando...</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-range" class="absolute inset-0 hidden flex bg-slate-50 overflow-hidden">
            <div class="w-80 bg-white border-r border-slate-200 flex flex-col p-4 z-10 shadow-lg">
                <h3 class="font-bold text-slate-800 mb-4"><i class="fas fa-file-import text-blue-500 mr-2"></i> Archivos Subidos</h3>
                <label class="text-xs font-bold text-slate-500 uppercase mb-1">1. Selecciona el archivo</label>
                <select id="fileSelector" class="w-full p-2 border rounded bg-slate-50 mb-4 outline-none font-semibold text-sm" onchange="changeActiveFile()"></select>
                <label class="text-xs font-bold text-slate-500 uppercase mb-1">2. Selecciona la Hoja</label>
                <select id="sheetSelector" class="w-full p-2 border rounded bg-slate-50 mb-4 outline-none font-semibold text-sm" onchange="renderRawPreview()"></select>
                <label class="text-xs font-bold text-slate-500 uppercase mb-1">3. Fila de Encabezados</label>
                <input type="number" id="headerRow" value="1" min="1" class="w-full p-2 border rounded text-center font-bold outline-none mb-4">
                <button onclick="saveAsDataSource()" class="w-full bg-blue-600 text-white px-4 py-3 rounded font-bold shadow hover:bg-blue-700 transition flex justify-center items-center">
                    <i class="fas fa-plus-circle mr-2"></i> Crear Fuente de Datos
                </button>
                <div class="mt-6 border-t pt-4 flex-1 overflow-y-auto">
                    <h4 class="text-xs font-bold text-slate-500 uppercase mb-2">Fuentes Listas para Analizar</h4>
                    <div id="processedSourcesList" class="space-y-2 text-sm">
                        <p class="text-xs text-slate-400 italic">No has creado fuentes a칰n.</p>
                    </div>
                </div>
            </div>
            <div class="flex-1 p-6 flex flex-col bg-slate-100 relative">
                <h2 class="text-lg font-bold text-slate-800 mb-2">Vista Previa del Documento</h2>
                <div class="flex-1 overflow-auto border rounded relative bg-white shadow">
                    <table class="min-w-full text-xs text-left" id="rawTablePreview"></table>
                </div>
            </div>
        </div>

        <div id="view-playground" class="absolute inset-0 hidden flex bg-slate-200">
            <aside class="w-[420px] bg-white shadow-xl z-10 flex flex-col border-r border-slate-300">
                <div class="p-4 bg-slate-800 text-white flex justify-between items-center"><h3 class="font-bold"><i class="fas fa-sliders-h mr-2"></i> KPI Individual</h3></div>
                <div class="p-4 overflow-y-auto flex-1 flex flex-col gap-4 custom-scroll">
                    <div class="bg-indigo-50 border border-indigo-200 p-3 rounded-lg"><label class="block text-[11px] font-bold text-indigo-900 uppercase mb-1">Fuente de Datos</label><select id="dsSelector" class="w-full p-2 border rounded outline-none text-sm font-bold bg-white shadow-sm" onchange="onDataSourceChange()"></select></div>
                    <div>
                        <div class="grid grid-cols-4 gap-1 text-center text-[10px] font-bold">
                            <button onclick="selectChartType('column')" class="chart-btn p-2 border rounded bg-blue-100" data-type="column"><i class="fas fa-chart-bar text-lg text-blue-600 block mb-1"></i>Columna</button>
                            <button onclick="selectChartType('bar')" class="chart-btn p-2 border rounded hover:bg-slate-100" data-type="bar"><i class="fas fa-align-left text-lg text-blue-600 block mb-1"></i>Barra</button>
                            <button onclick="selectChartType('line')" class="chart-btn p-2 border rounded hover:bg-slate-100" data-type="line"><i class="fas fa-chart-line text-lg text-green-600 block mb-1"></i>L칤nea</button>
                            <button onclick="selectChartType('doughnut')" class="chart-btn p-2 border rounded hover:bg-slate-100" data-type="doughnut"><i class="fas fa-circle-notch text-lg text-orange-500 block mb-1"></i>Dona</button>
                        </div><input type="hidden" id="selectedChartType" value="column">
                    </div>
                    <div class="bg-blue-50 p-3 rounded-lg border border-blue-200 flex flex-col gap-3 shadow-inner">
                        <div><label class="block text-[10px] font-bold text-blue-900 uppercase">Nombre</label><input type="text" id="widgetTitle" class="w-full p-1.5 border rounded"></div>
                        <div><label class="block text-[10px] font-bold text-blue-900 uppercase">Eje X</label><select id="axisX" class="w-full p-1.5 border rounded column-selector"></select></div>
                        <div class="grid grid-cols-2 gap-2 border-t pt-2">
                            <div><label class="block text-[10px] font-bold text-blue-900 uppercase">C치lculo</label><select id="aggType" class="w-full p-1.5 border rounded" onchange="togglePercentUI()"><option value="count">Contar</option><option value="sum">Sumar</option><option value="percent">Porcentaje (%)</option></select></div>
                            <div><label class="block text-[10px] font-bold text-blue-900 uppercase">Columna (Eje Y)</label><select id="axisY" class="w-full p-1.5 border rounded column-selector" onchange="updatePercentTargets()"></select></div>
                        </div>
                        <div id="percentTargetUI" class="hidden bg-yellow-50 border p-2 rounded"><label class="block text-[10px] font-bold text-yellow-800 uppercase">Valor de 칄xito</label><select id="percentTargetValue" class="w-full p-1.5 border rounded"></select></div>
                    </div>
                    <button onclick="buildWidget()" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold shadow-lg hover:bg-green-700 mt-auto"><i class="fas fa-play mr-2"></i> Generar Gr치fico</button>
                </div>
            </aside>
            <main class="flex-1 p-8 overflow-y-auto bg-slate-200" id="dashboardCanvas">
                <div id="widgetsGrid" class="grid grid-cols-1 xl:grid-cols-2 gap-8 relative z-10"></div>
            </main>
        </div>

        <div id="view-compare" class="absolute inset-0 hidden flex bg-slate-200">
            <aside class="w-[450px] bg-white shadow-xl z-10 flex flex-col border-r border-slate-300">
                <div class="p-4 bg-emerald-700 text-white flex justify-between items-center">
                    <h3 class="font-bold"><i class="fas fa-balance-scale mr-2"></i> Mapeo Comparativo</h3>
                </div>
                
                <div class="p-4 overflow-y-auto flex-1 flex flex-col gap-4 custom-scroll">
                    <p class="text-[11px] text-slate-500 border-b pb-2">Configura cada fuente manualmente para compararlas, incluso si las columnas tienen nombres distintos.</p>
                    
                    <div id="auditMappingContainer" class="flex flex-col gap-4">
                        </div>

                    <button onclick="generateCrossAudit()" class="w-full bg-emerald-600 text-white py-3 rounded-lg font-bold shadow-lg hover:bg-emerald-700 transition mt-4 border-b-4 border-emerald-800">
                        <i class="fas fa-chart-line mr-2"></i> Generar Comparativa Global
                    </button>
                </div>
            </aside>

            <main class="flex-1 p-8 overflow-y-auto relative bg-slate-100 flex flex-col">
                <h2 class="text-2xl font-bold text-slate-800 mb-6"><i class="fas fa-chart-area text-emerald-600 mr-2"></i> Resultados de Auditor칤a</h2>
                
                <div class="bg-white p-6 rounded-2xl shadow border border-slate-200 h-[400px] mb-8 relative">
                    <div id="emptyAudit" class="absolute inset-0 flex flex-col items-center justify-center text-slate-400">
                        <i class="fas fa-cogs text-5xl mb-3"></i><p>Configura las fuentes a la izquierda y presiona Generar.</p>
                    </div>
                    <canvas id="auditChart"></canvas>
                </div>

                <div class="bg-white rounded-2xl shadow border border-slate-200 overflow-hidden hidden" id="auditTableContainer">
                    <div class="bg-emerald-50 border-b border-emerald-100 p-4">
                        <h3 class="font-bold text-emerald-800"><i class="fas fa-table mr-2"></i> Resumen de Datos Analizados</h3>
                    </div>
                    <table class="min-w-full text-sm text-left">
                        <thead class="bg-slate-50 text-slate-600">
                            <tr>
                                <th class="px-6 py-3 border-b border-r">Fuente (Archivo)</th>
                                <th class="px-6 py-3 border-b border-r">Filtro Aplicado</th>
                                <th class="px-6 py-3 border-b border-r text-center">Total Documentos</th>
                                <th class="px-6 py-3 border-b border-r text-center text-emerald-600">Digitalizados</th>
                                <th class="px-6 py-3 border-b border-r text-center text-red-500">No Digitalizados</th>
                                <th class="px-6 py-3 border-b text-center font-bold">% Avance</th>
                            </tr>
                        </thead>
                        <tbody id="auditTableBody" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </main>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, orderBy, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCZXwXN15MYVpFP0-QbgR-H4bHqMH4_EFA",
            authDomain: "reporte-d37d1.firebaseapp.com",
            projectId: "reporte-d37d1",
            storageBucket: "reporte-d37d1.firebasestorage.app",
            messagingSenderId: "995600823465",
            appId: "1:995600823465:web:3ae9ede621cf0631ad65b8"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let rawWorkbooks = {}; 
        let processedDataSources = {}; 
        let currentFileId = null;
        let savedWidgetsConfig = []; 
        let auditChartInstance = null; // Para el nuevo gr치fico de la V12

        window.switchView = function(step) {
            document.getElementById('view-upload').classList.add('hidden');
            document.getElementById('view-range').classList.add('hidden');
            document.getElementById('view-playground').classList.add('hidden');
            document.getElementById('view-compare').classList.add('hidden');
            
            if(step === 1) document.getElementById('view-upload').classList.remove('hidden');
            if(step === 2) document.getElementById('view-range').classList.remove('hidden', 'flex');
            if(step === 3) document.getElementById('view-playground').classList.remove('hidden');
            if(step === 4) {
                document.getElementById('view-compare').classList.remove('hidden', 'flex');
                document.getElementById('view-compare').style.display = 'flex';
                buildAuditSidebar(); // Construye el UI m치gico al entrar al Paso 4
            }
            
            [1,2,3,4].forEach(n => {
                const btn = document.getElementById('tab'+n);
                if(n === step) {
                    btn.classList.add('tab-active', 'text-slate-900');
                    btn.classList.remove('text-slate-400', 'text-emerald-400');
                } else {
                    btn.classList.remove('tab-active', 'text-slate-900');
                    if(n === 4 && !btn.disabled) btn.classList.add('text-emerald-400');
                    else btn.classList.add('text-slate-400');
                }
            });
        }

        // --- CARGA Y FUENTES (Simplificado para el c칩digo, igual a V11) ---
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;
            document.getElementById('uploadStatus').innerHTML = `<i class="fas fa-spinner fa-spin"></i> Leyendo archivos...`;
            rawWorkbooks = {}; processedDataSources = {};
            
            for(let i=0; i<files.length; i++) {
                const data = await files[i].arrayBuffer();
                rawWorkbooks['file_'+i] = { name: files[i].name, workbook: XLSX.read(data) };
            }

            const fileSel = document.getElementById('fileSelector');
            fileSel.innerHTML = '';
            Object.keys(rawWorkbooks).forEach(id => fileSel.innerHTML += `<option value="${id}">${rawWorkbooks[id].name}</option>`);

            window.changeActiveFile();
            window.switchView(2);
            document.getElementById('tab2').disabled = false;
        });

        window.changeActiveFile = function() {
            currentFileId = document.getElementById('fileSelector').value;
            const wb = rawWorkbooks[currentFileId].workbook;
            const sheetSel = document.getElementById('sheetSelector');
            sheetSel.innerHTML = '';
            wb.SheetNames.forEach(s => sheetSel.innerHTML += `<option value="${s}">${s}</option>`);
            document.getElementById('headerRow').value = 1;
            window.renderRawPreview();
        }

        window.renderRawPreview = function() {
            const wb = rawWorkbooks[currentFileId].workbook;
            const sheetName = document.getElementById('sheetSelector').value;
            const rawArray = XLSX.utils.sheet_to_json(wb.Sheets[sheetName], { header: 1, defval: "" });
            const tbody = document.getElementById('rawTablePreview');
            tbody.innerHTML = '';
            for(let i = 0; i < Math.min(rawArray.length, 30); i++) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="p-2 bg-slate-200 text-slate-500 font-bold border-r w-10 text-center border-b">${i + 1}</td>`;
                rawArray[i].forEach(cell => tr.innerHTML += `<td class="p-2 border-r truncate max-w-xs text-slate-700 border-b">${cell}</td>`);
                tbody.appendChild(tr);
            }
        }

        window.saveAsDataSource = function() {
            const wb = rawWorkbooks[currentFileId].workbook;
            const sheetName = document.getElementById('sheetSelector').value;
            const headerRowNum = parseInt(document.getElementById('headerRow').value) - 1;
            const sheet = wb.Sheets[sheetName];
            let range = XLSX.utils.decode_range(sheet['!ref']);
            range.s.r = Math.max(0, headerRowNum);
            
            let rawData = XLSX.utils.sheet_to_json(sheet, { range: XLSX.utils.encode_range(range), defval: null });
            let cleanData = rawData.map(row => { 
                let clean = {}; 
                for(let key in row) if(!key.includes("__EMPTY")) clean[key.trim()] = row[key]; 
                return clean; 
            }).filter(row => Object.keys(row).length > 0);
            
            if(cleanData.length === 0) return alert("Sin datos.");

            let dsId = 'ds_' + Date.now();
            processedDataSources[dsId] = { id: dsId, name: `${rawWorkbooks[currentFileId].name} (${sheetName})`, columns: Object.keys(cleanData[0]), data: cleanData };

            document.getElementById('processedSourcesList').innerHTML = Object.values(processedDataSources).map(ds => `<div class="p-2 bg-blue-50 border border-blue-200 rounded text-blue-800 font-medium text-xs mb-1"><i class="fas fa-database mr-2"></i>${ds.name}</div>`).join('');
            
            document.getElementById('tab3').disabled = false;
            document.getElementById('tab4').disabled = false; // Habilitar Paso 4
            
            // Llenar selector de Dashboard
            const dsSel = document.getElementById('dsSelector');
            dsSel.innerHTML = '';
            Object.values(processedDataSources).forEach(ds => dsSel.innerHTML += `<option value="${ds.id}">${ds.name}</option>`);
            window.onDataSourceChange();
        }

        // --- L칍GICA PASO 3 (Mantenida) ---
        window.onDataSourceChange = function() {
            const dsId = document.getElementById('dsSelector').value;
            if(!dsId || !processedDataSources[dsId]) return;
            const cols = processedDataSources[dsId].columns;
            document.querySelectorAll('.column-selector').forEach(sel => {
                sel.innerHTML = '';
                cols.forEach(col => sel.innerHTML += `<option value="${col}">${col}</option>`);
            });
        }
        window.selectChartType = function(type) { document.getElementById('selectedChartType').value = type; }
        window.togglePercentUI = function() {
            if(document.getElementById('aggType').value === 'percent') {
                document.getElementById('percentTargetUI').classList.remove('hidden'); window.updatePercentTargets();
            } else document.getElementById('percentTargetUI').classList.add('hidden');
        }
        window.updatePercentTargets = function() {
            const yCol = document.getElementById('axisY').value;
            const dsId = document.getElementById('dsSelector').value;
            let uniqueVals = new Set();
            processedDataSources[dsId].data.forEach(r => { if(r[yCol]) uniqueVals.add(r[yCol].toString().trim()); });
            const select = document.getElementById('percentTargetValue');
            select.innerHTML = '';
            Array.from(uniqueVals).sort().forEach(v => select.innerHTML += `<option value="${v}">${v}</option>`);
        }
        window.buildWidget = function() { alert("Para probar la V12, ve a la pesta침a 4. Auditor칤a Cruzada."); }


        // ==============================================================
        // 游댠 PASO 4: M칍DULO DE AUDITOR칈A CRUZADA (NUEVO) 游댠
        // ==============================================================

        // 1. Construir las tarjetas de configuraci칩n en el Sidebar
        window.buildAuditSidebar = function() {
            const container = document.getElementById('auditMappingContainer');
            container.innerHTML = '';
            
            Object.values(processedDataSources).forEach(ds => {
                let colOptions = `<option value="">-- Seleccionar Columna --</option>` + ds.columns.map(c => `<option value="${c}">${c}</option>`).join('');

                const card = document.createElement('div');
                card.className = "bg-slate-50 border border-slate-200 rounded-lg p-3 shadow-sm";
                card.innerHTML = `
                    <h4 class="font-bold text-slate-800 text-[11px] mb-2 border-b pb-1 truncate" title="${ds.name}"><i class="fas fa-file-excel text-emerald-600 mr-1"></i> ${ds.name}</h4>
                    
                    <div class="mb-2">
                        <label class="block text-[9px] font-bold text-slate-600 uppercase">Filtro/Tipo (Opcional)</label>
                        <select id="auditFilterCol_${ds.id}" class="w-full p-1 border rounded text-[10px] outline-none" onchange="populateAuditValues('${ds.id}', 'filter')">${colOptions}</select>
                        <select id="auditFilterVal_${ds.id}" class="w-full p-1 border rounded text-[10px] outline-none mt-1 hidden"></select>
                    </div>

                    <div class="bg-white p-2 rounded border border-slate-200">
                        <label class="block text-[9px] font-bold text-emerald-800 uppercase">Columna de Estado *</label>
                        <select id="auditStatusCol_${ds.id}" class="w-full p-1 border rounded text-[10px] outline-none mb-2 bg-emerald-50" onchange="populateAuditValues('${ds.id}', 'status')">${colOptions}</select>
                        
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-[9px] font-bold text-emerald-600 uppercase">Es Digitalizado</label>
                                <select id="auditDigVal_${ds.id}" class="w-full p-1 border rounded text-[10px] outline-none disabled:bg-slate-100" disabled></select>
                            </div>
                            <div>
                                <label class="block text-[9px] font-bold text-red-500 uppercase">No Digitalizado</label>
                                <select id="auditNoDigVal_${ds.id}" class="w-full p-1 border rounded text-[10px] outline-none disabled:bg-slate-100" disabled></select>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // 2. Poblar los dropdowns secundarios cuando seleccionan una columna
        window.populateAuditValues = function(dsId, type) {
            const ds = processedDataSources[dsId];
            
            if(type === 'filter') {
                const col = document.getElementById(`auditFilterCol_${dsId}`).value;
                const valSelect = document.getElementById(`auditFilterVal_${dsId}`);
                if(!col) { valSelect.classList.add('hidden'); return; }
                
                let uniqueVals = new Set();
                ds.data.forEach(r => { if(r[col]) uniqueVals.add(r[col].toString().trim()); });
                
                valSelect.innerHTML = `<option value="">-- Todos --</option>` + Array.from(uniqueVals).sort().map(v => `<option value="${v}">${v}</option>`).join('');
                valSelect.classList.remove('hidden');
            }

            if(type === 'status') {
                const col = document.getElementById(`auditStatusCol_${dsId}`).value;
                const digSelect = document.getElementById(`auditDigVal_${dsId}`);
                const noDigSelect = document.getElementById(`auditNoDigVal_${dsId}`);
                
                if(!col) { 
                    digSelect.disabled = true; noDigSelect.disabled = true; 
                    digSelect.innerHTML = ''; noDigSelect.innerHTML = ''; return; 
                }

                let uniqueVals = new Set();
                ds.data.forEach(r => { if(r[col]) uniqueVals.add(r[col].toString().trim()); });
                
                let optionsHtml = `<option value="">-- Seleccionar --</option>` + Array.from(uniqueVals).sort().map(v => `<option value="${v}">${v}</option>`).join('');
                
                digSelect.innerHTML = optionsHtml;
                noDigSelect.innerHTML = optionsHtml;
                digSelect.disabled = false;
                noDigSelect.disabled = false;
            }
        }

        // 3. GENERAR LA COMPARATIVA (Extrayendo datos de cada fuente)
        window.generateCrossAudit = function() {
            document.getElementById('emptyAudit').style.display = 'none';
            document.getElementById('auditTableContainer').classList.remove('hidden');

            let chartLabels = [];
            let chartDataDigPct = [];
            let chartDataNoDigPct = [];
            let tbodyHtml = '';

            // Recorrer cada fuente configurada
            Object.values(processedDataSources).forEach(ds => {
                const statusCol = document.getElementById(`auditStatusCol_${ds.id}`).value;
                const digVal = document.getElementById(`auditDigVal_${ds.id}`).value;
                const noDigVal = document.getElementById(`auditNoDigVal_${ds.id}`).value;
                const filterCol = document.getElementById(`auditFilterCol_${ds.id}`).value;
                const filterVal = document.getElementById(`auditFilterVal_${ds.id}`) ? document.getElementById(`auditFilterVal_${ds.id}`).value : "";

                // Validaci칩n simple
                if(!statusCol) {
                    tbodyHtml += `<tr><td colspan="6" class="px-6 py-2 text-red-500 text-xs italic">Falta configurar la Columna de Estado en: ${ds.name}</td></tr>`;
                    return; // Saltamos este si no est치 configurado
                }

                // Filtrar datos si aplica
                let workingData = ds.data;
                let filterLabel = "Todos";
                if(filterCol && filterVal) {
                    workingData = workingData.filter(r => r[filterCol] && r[filterCol].toString().trim() === filterVal);
                    filterLabel = `${filterCol}: ${filterVal}`;
                }

                // Contar
                let totalDocs = workingData.length;
                let countDig = 0;
                let countNoDig = 0;

                workingData.forEach(row => {
                    let val = row[statusCol] ? row[statusCol].toString().trim() : "";
                    if(val === digVal) countDig++;
                    if(val === noDigVal) countNoDig++;
                });

                // Porcentajes
                let pctDig = totalDocs > 0 ? (countDig / totalDocs) * 100 : 0;
                let pctNoDig = totalDocs > 0 ? (countNoDig / totalDocs) * 100 : 0;

                // Guardar para el gr치fico
                chartLabels.push(ds.name);
                chartDataDigPct.push(pctDig);
                chartDataNoDigPct.push(pctNoDig);

                // Armar Fila de Tabla
                tbodyHtml += `
                    <tr class="hover:bg-slate-50 transition">
                        <td class="px-6 py-3 border-r border-b text-slate-800 font-bold">${ds.name}</td>
                        <td class="px-6 py-3 border-r border-b text-slate-500 text-xs">${filterLabel}</td>
                        <td class="px-6 py-3 border-r border-b text-center font-bold">${totalDocs}</td>
                        <td class="px-6 py-3 border-r border-b text-center text-emerald-600 font-bold">${countDig}</td>
                        <td class="px-6 py-3 border-r border-b text-center text-red-500 font-bold">${countNoDig}</td>
                        <td class="px-6 py-3 border-b text-center text-blue-600 font-black">${pctDig.toFixed(1)}%</td>
                    </tr>
                `;
            });

            document.getElementById('auditTableBody').innerHTML = tbodyHtml;

            // DIBUJAR EL GR츼FICO (Barras Apiladas hasta 100%)
            if(auditChartInstance) auditChartInstance.destroy();

            const ctx = document.getElementById('auditChart').getContext('2d');
            auditChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartLabels,
                    datasets: [
                        { label: '% Digitalizado', data: chartDataDigPct, backgroundColor: '#10b981', barThickness: 40 },
                        { label: '% No Digitalizado', data: chartDataNoDigPct, backgroundColor: '#ef4444', barThickness: 40 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { 
                        legend: { position: 'top' },
                        tooltip: { callbacks: { label: function(context) { return ` ${context.dataset.label}: ${context.raw.toFixed(1)}%`; } } }
                    },
                    scales: {
                        x: { stacked: true },
                        y: { stacked: true, min: 0, max: 100, ticks: { callback: function(value) { return value + "%" } } }
                    }
                }
            });
        }

    </script>
</body>
</html>
