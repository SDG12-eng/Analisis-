<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DataMaster SaaS - Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        
        /* Scrollbars finos */
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Tarjetas 3D (M√©tricas) */
        .flip-container { perspective: 1000px; cursor: pointer; }
        .flipper { transition: 0.6s; transform-style: preserve-3d; position: relative; height: 100%; width: 100%; }
        .front, .back { 
            backface-visibility: hidden; position: absolute; top: 0; left: 0; right: 0; bottom: 0; 
            border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); background: white;
            display: flex; flex-direction: column;
        }
        .front { z-index: 2; transform: rotateY(0deg); }
        .back { transform: rotateY(180deg); overflow: hidden; border: 1px solid #e2e8f0; }
        .flipped .flipper { transform: rotateY(180deg); }

        /* Estilos de Tablas (Globales) */
        .excel-table { border-collapse: separate; border-spacing: 0; width: 100%; font-size: 0.75rem; }
        .excel-table th { 
            background-color: #f1f5f9; color: #475569; font-weight: 600; 
            padding: 8px 12px; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0;
            position: sticky; top: 0; z-index: 10; text-transform: uppercase; letter-spacing: 0.05em;
        }
        .excel-table td { 
            padding: 6px 12px; border-bottom: 1px solid #f1f5f9; border-right: 1px solid #f1f5f9; 
            color: #334155; white-space: nowrap; max-width: 200px; overflow: hidden; text-overflow: ellipsis;
        }
        .excel-table tr:hover td { background-color: #f8fafc; }

        /* Componentes UI */
        .step-btn { @apply px-4 py-2 rounded-lg text-xs font-bold transition-all border border-transparent whitespace-nowrap; }
        .step-active { @apply bg-indigo-600 text-white shadow-md border-indigo-700; }
        .step-inactive { @apply text-slate-500 hover:bg-white hover:text-slate-700; }
        .step-disabled { @apply opacity-40 cursor-not-allowed; }

        .nav-item { @apply flex items-center gap-3 w-full px-4 py-3 rounded-xl transition-all font-medium text-sm; }
        .nav-active { @apply bg-indigo-600 text-white shadow-md shadow-indigo-500/30; }
        .nav-inactive { @apply text-slate-400 hover:bg-slate-800 hover:text-white; }

        /* Fade Animation */
        .fade-enter { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="h-screen flex overflow-hidden text-slate-800 bg-slate-100">

    <aside class="w-20 lg:w-64 bg-slate-900 flex flex-col transition-all duration-300 z-50 flex-none shadow-xl">
        <div class="h-16 flex items-center justify-center lg:justify-start lg:px-6 border-b border-slate-800 shrink-0">
            <div class="bg-gradient-to-br from-indigo-500 to-blue-500 text-white p-1.5 rounded-lg shadow-sm">
                <i class="fas fa-database text-lg"></i>
            </div>
            <h1 class="text-sm font-black tracking-wide text-white ml-3 hidden lg:block">DATA<span class="text-indigo-400">MASTER</span></h1>
        </div>
        
        <nav class="flex-1 p-3 space-y-2 mt-4">
            <button onclick="switchSection('metrics')" id="nav-metrics" class="nav-item nav-active">
                <i class="fas fa-chart-pie text-lg w-5 text-center"></i>
                <span class="hidden lg:block">Dashboard Analytics</span>
            </button>
            <button onclick="switchSection('validations')" id="nav-validations" class="nav-item nav-inactive">
                <i class="fas fa-check-double text-lg w-5 text-center"></i>
                <span class="hidden lg:block">Validador de Datos</span>
            </button>
        </nav>

        <div class="p-4 border-t border-slate-800 text-center lg:text-left">
            <div class="w-8 h-8 rounded-full bg-slate-700 mx-auto lg:mx-0 flex items-center justify-center text-xs text-white font-bold">EM</div>
        </div>
    </aside>

    <div class="flex-1 flex flex-col h-screen min-w-0">
        
        <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6 shrink-0 z-30 shadow-sm">
            <h2 id="global-header-title" class="font-bold text-slate-800 text-lg">Dashboard Analytics</h2>
            
            <nav id="metrics-tabs" class="flex bg-slate-100/80 p-1 rounded-xl gap-1 overflow-x-auto hide-scroll flex-1 sm:flex-none ml-4 max-w-full">
                <button id="step1" onclick="switchView(1)" class="step-btn step-active">1. Carga</button>
                <button id="step2" onclick="switchView(2)" disabled class="step-btn step-inactive step-disabled">2. Fuentes</button>
                <button id="step3" onclick="switchView(3)" disabled class="step-btn step-inactive step-disabled">3. Dashboard</button>
                <button id="step4" onclick="switchView(4)" disabled class="step-btn step-inactive step-disabled">4. Unificar</button>
            </nav>
        </header>

        <main class="flex-1 relative overflow-hidden flex bg-slate-50">

            <div id="section-metrics" class="flex-1 flex flex-col w-full h-full fade-enter relative">
                
                <div id="view-1" class="flex flex-col flex-1 items-center justify-center p-4 lg:p-6 overflow-y-auto">
                    <div class="bg-white p-6 lg:p-10 rounded-2xl shadow-xl border border-slate-200 text-center max-w-lg w-full mt-auto mb-auto">
                        <div class="w-16 h-16 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-inner">
                            <i class="fas fa-folder-open text-3xl"></i>
                        </div>
                        <h2 class="text-xl font-bold text-slate-800 mb-2">Comienza tu An√°lisis</h2>
                        <p class="text-slate-500 text-sm mb-8">Sube tus archivos Excel (.xlsx, .csv) para generar dashboards.</p>
                        
                        <label class="block mb-4 group cursor-pointer">
                            <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" multiple class="hidden"/>
                            <div class="bg-slate-900 text-white px-6 py-4 rounded-xl font-bold shadow-lg shadow-indigo-500/20 group-hover:bg-slate-800 transition flex items-center justify-center gap-3">
                                <i class="fas fa-cloud-upload-alt text-lg"></i><span>Seleccionar Archivos</span>
                            </div>
                        </label>
                        <div id="uploadStatus" class="h-5 text-xs font-bold text-indigo-600"></div>
                        <button id="btnNext1" onclick="switchView(2)" class="hidden w-full mt-6 bg-white border-2 border-indigo-600 text-indigo-600 py-3 rounded-xl font-bold hover:bg-indigo-50 transition">Siguiente Paso <i class="fas fa-arrow-right ml-1"></i></button>
                    </div>
                    <div class="mt-8 mb-auto text-center">
                        <button onclick="loadProjs()" class="text-xs text-slate-400 hover:text-indigo-600 font-medium inline-flex items-center gap-2"><i class="fas fa-sync-alt"></i> Cargar proyectos guardados</button>
                        <div id="cloudProjectsList" class="mt-4 hidden space-y-2"></div> 
                    </div>
                </div>

                <div id="view-2" class="hidden flex-col lg:flex-row flex-1 h-full overflow-hidden">
                    <div class="w-full lg:w-80 bg-white border-r border-slate-200 flex flex-col flex-none">
                        <div class="p-4 border-b border-slate-100"><h3 class="font-bold text-sm">Configuraci√≥n Base</h3></div>
                        <div class="p-4 flex-1 overflow-y-auto custom-scroll space-y-4">
                            <div><label class="text-[10px] font-bold text-slate-500 uppercase block mb-1">Archivo</label><select id="fileSelector" class="w-full p-2 bg-slate-50 border border-slate-200 rounded text-xs outline-none" onchange="changeActiveFile()"></select></div>
                            <div><label class="text-[10px] font-bold text-slate-500 uppercase block mb-1">Hoja</label><select id="sheetSelector" class="w-full p-2 bg-slate-50 border border-slate-200 rounded text-xs outline-none" onchange="renderRawPreview()"></select></div>
                            <div><label class="text-[10px] font-bold text-slate-500 uppercase block mb-1">Fila Encabezados</label><input type="number" id="headerRow" value="1" min="1" class="w-full p-2 bg-slate-50 border border-slate-200 rounded text-center text-xs"></div>
                            <button onclick="saveAsDataSource()" class="w-full bg-indigo-600 text-white py-2.5 rounded font-bold shadow-md hover:bg-indigo-700 text-xs">Guardar Fuente</button>
                            <div class="pt-4 border-t border-slate-100"><h4 class="text-[10px] font-bold text-slate-400 uppercase mb-2">Activas</h4><div id="processedSourcesList" class="space-y-2 text-xs"></div></div>
                        </div>
                    </div>
                    <div class="flex-1 flex flex-col min-w-0 bg-white">
                        <div class="h-10 bg-slate-50 border-b flex items-center px-4 justify-between shrink-0"><span class="text-[10px] font-bold text-slate-500 uppercase">Previsualizaci√≥n</span></div>
                        <div class="flex-1 overflow-auto custom-scroll"><table class="excel-table" id="rawTablePreview"></table></div>
                    </div>
                </div>

                <div id="view-3" class="hidden flex-col lg:flex-row flex-1 h-full overflow-hidden">
                    <div class="w-full lg:w-80 bg-white border-r border-slate-200 flex flex-col flex-none">
                        <div class="p-4 border-b border-slate-100"><h3 class="font-bold text-sm">Constructor Gr√°fico</h3></div>
                        <div class="p-4 flex-1 overflow-y-auto custom-scroll space-y-4">
                            <div class="bg-slate-50 border rounded-lg p-2"><label class="text-[10px] text-slate-400 font-bold uppercase block mb-1">Fuente</label><select id="dsSelector" class="w-full p-1.5 text-xs border rounded bg-white outline-none" onchange="onDataSourceChange()"></select></div>
                            <input type="text" id="widgetTitle" placeholder="T√≠tulo Gr√°fico..." class="w-full p-2 border-b text-sm font-semibold outline-none bg-transparent">
                            <div><label class="text-[10px] text-slate-400 font-bold uppercase block mb-1">Eje X</label><select id="axisX" class="w-full p-2 text-xs border rounded outline-none column-selector"></select></div>
                            <div class="grid grid-cols-2 gap-2">
                                <div><label class="text-[10px] text-slate-400 font-bold uppercase block mb-1">Op</label><select id="aggType" class="w-full p-2 text-xs border rounded outline-none" onchange="togglePercentUI()"><option value="count">Contar</option><option value="sum">Sumar</option><option value="percent">%</option></select></div>
                                <div><label class="text-[10px] text-slate-400 font-bold uppercase block mb-1">Eje Y</label><select id="axisY" class="w-full p-2 text-xs border rounded outline-none column-selector" onchange="updatePercentTargets()"></select></div>
                            </div>
                            <div id="percentTargetUI" class="hidden bg-yellow-50 p-2 rounded border border-yellow-100"><label class="text-[10px] text-yellow-700 font-bold uppercase block mb-1">Valor √âxito</label><div id="percentTargetValue" class="max-h-24 overflow-y-auto custom-scroll bg-white rounded p-1 space-y-1 text-xs"></div></div>
                            <div class="grid grid-cols-3 gap-2"><button onclick="selectChartType('bar')" class="chart-btn active p-1 border rounded bg-slate-800 text-white" data-type="bar"><i class="fas fa-chart-bar"></i></button><button onclick="selectChartType('line')" class="chart-btn p-1 border rounded" data-type="line"><i class="fas fa-chart-line"></i></button><button onclick="selectChartType('doughnut')" class="chart-btn p-1 border rounded" data-type="doughnut"><i class="fas fa-chart-pie"></i></button><input type="hidden" id="selectedChartType" value="bar"></div>
                            <button onclick="buildWidget()" class="w-full bg-indigo-600 text-white py-2.5 rounded font-bold hover:bg-indigo-700 text-xs mt-2">Generar</button>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto custom-scroll p-4 lg:p-6 bg-slate-50" id="canvasArea3">
                        <div id="widgetsGrid" class="grid grid-cols-1 md:grid-cols-2 2xl:grid-cols-3 gap-6 pb-20">
                            <div id="emptyLocal" class="col-span-full h-64 border-2 border-dashed border-slate-300 rounded-xl flex items-center justify-center text-slate-400"><p class="text-sm">Configura los par√°metros a la izquierda</p></div>
                        </div>
                    </div>
                </div>

                <div id="view-4" class="hidden flex-col lg:flex-row flex-1 h-full overflow-hidden">
                    <div class="w-full lg:w-96 bg-white border-r border-slate-200 flex flex-col flex-none">
                        <div class="p-4 border-b border-emerald-100 bg-emerald-50"><h3 class="font-bold text-sm text-emerald-900">Cruzador de Fuentes</h3></div>
                        <div class="p-4 flex-1 overflow-y-auto custom-scroll space-y-4">
                            <div class="flex bg-slate-100 p-1 rounded-lg">
                                <label class="flex-1 text-center cursor-pointer"><input type="radio" name="auditMode" value="compare" class="hidden peer" checked onchange="toggleAuditMode()"><span class="block py-2 text-[10px] font-bold rounded peer-checked:bg-white peer-checked:text-blue-600 peer-checked:shadow-sm uppercase">Comparar Grupos</span></label>
                                <label class="flex-1 text-center cursor-pointer"><input type="radio" name="auditMode" value="merge" class="hidden peer" onchange="toggleAuditMode()"><span class="block py-2 text-[10px] font-bold rounded peer-checked:bg-white peer-checked:text-emerald-600 peer-checked:shadow-sm uppercase">Suma Total</span></label>
                            </div>
                            <input type="text" id="auditTitle" placeholder="T√≠tulo..." class="w-full p-2 border rounded text-sm font-semibold outline-none">
                            <div class="grid grid-cols-2 gap-2">
                                <select id="auditAggType" class="w-full p-2 border rounded text-xs font-bold outline-none" onchange="buildAuditSidebar()"><option value="percent">Porcentaje (%)</option><option value="count">Contar</option><option value="sum">Sumar</option></select>
                                <select id="auditChartType" class="w-full p-2 border rounded text-xs font-bold outline-none"><option value="bar">Barras</option><option value="line">L√≠nea</option></select>
                            </div>
                            <div id="auditMappingContainer" class="space-y-3 pt-2"></div>
                            <button onclick="generateMergedAudit()" class="w-full bg-emerald-600 text-white py-3 rounded font-bold shadow hover:bg-emerald-700 text-xs">GENERAR REPORTE</button>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto custom-scroll p-4 lg:p-6 bg-slate-50" id="canvasArea4">
                        <div id="auditWidgetsGrid" class="grid grid-cols-1 xl:grid-cols-2 gap-6 pb-20">
                             <div id="emptyAudit" class="col-span-full h-64 border-2 border-dashed border-slate-300 rounded-xl flex items-center justify-center text-slate-400"><p class="text-sm">Configura la comparativa a la izquierda</p></div>
                        </div>
                    </div>
                </div>

            </div>


            <div id="section-validations" class="hidden flex-1 flex flex-col w-full h-full fade-enter">
                <div class="flex-1 flex flex-col lg:flex-row overflow-hidden">
                    
                    <div class="w-full lg:w-[400px] bg-white border-r border-slate-200 flex flex-col flex-none z-10 shadow-[4px_0_24px_rgba(0,0,0,0.02)]">
                        <div class="p-5 border-b border-slate-100 bg-slate-50">
                            <h3 class="font-bold text-slate-800"><i class="fas fa-check-double text-indigo-600 mr-2"></i>Motor de Validaci√≥n</h3>
                            <p class="text-xs text-slate-400 mt-1">Compara un archivo principal contra una base de referencia para generar status de auditor√≠a.</p>
                        </div>
                        
                        <div class="p-5 flex-1 overflow-y-auto custom-scroll space-y-6">
                            
                            <div class="border-l-4 border-blue-500 bg-white shadow-sm border-t border-r border-b border-slate-100 rounded-r-lg p-4">
                                <h4 class="font-bold text-sm text-slate-700 mb-3"><i class="fas fa-file-excel text-blue-500 mr-1"></i> 1. Archivo a Validar (Principal)</h4>
                                <div class="space-y-3">
                                    <input type="file" id="archivo1" accept=".xlsx, .xls" class="w-full text-xs text-slate-500 file:mr-3 file:py-1.5 file:px-3 file:rounded file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer">
                                    <div>
                                        <label class="text-[10px] font-bold text-slate-500 uppercase block mb-1">Hoja</label>
                                        <select id="hoja1" class="w-full p-2 bg-slate-50 border border-slate-200 rounded text-xs outline-none"><option value="">Sube archivo...</option></select>
                                    </div>
                                    <div>
                                        <label class="text-[10px] font-bold text-slate-500 uppercase block mb-1">Columna a Evaluar</label>
                                        <select id="col1" class="w-full p-2 bg-slate-50 border border-slate-200 rounded text-xs outline-none focus:border-blue-500"><option value="">Selecciona hoja...</option></select>
                                    </div>
                                </div>
                            </div>

                            <div class="border-l-4 border-amber-500 bg-white shadow-sm border-t border-r border-b border-slate-100 rounded-r-lg p-4">
                                <h4 class="font-bold text-sm text-slate-700 mb-3"><i class="fas fa-database text-amber-500 mr-1"></i> 2. Archivo Base (Referencia)</h4>
                                <div class="space-y-3">
                                    <input type="file" id="archivo2" accept=".xlsx, .xls" class="w-full text-xs text-slate-500 file:mr-3 file:py-1.5 file:px-3 file:rounded file:border-0 file:text-xs file:font-semibold file:bg-amber-50 file:text-amber-700 hover:file:bg-amber-100 cursor-pointer">
                                    <div>
                                        <label class="text-[10px] font-bold text-slate-500 uppercase block mb-1">Hoja</label>
                                        <select id="hoja2" class="w-full p-2 bg-slate-50 border border-slate-200 rounded text-xs outline-none"><option value="">Sube archivo...</option></select>
                                    </div>
                                    <div>
                                        <label class="text-[10px] font-bold text-slate-500 uppercase block mb-1">Columna Clave (B√∫squeda Exacta)</label>
                                        <select id="col2" class="w-full p-2 bg-slate-50 border border-slate-200 rounded text-xs outline-none focus:border-amber-500"><option value="">Selecciona hoja...</option></select>
                                    </div>
                                </div>
                            </div>
                            
                            <button id="btnValidar" class="w-full bg-slate-800 text-white py-3.5 rounded-lg font-bold shadow-lg hover:bg-slate-700 active:scale-95 transition text-sm flex justify-center items-center gap-2">
                                <i class="fas fa-magic"></i> Ejecutar Validaci√≥n y Descargar
                            </button>
                        </div>
                    </div>

                    <div class="flex-1 flex flex-col min-w-0 bg-slate-50 p-4 lg:p-6 gap-6 overflow-hidden">
                        
                        <div class="flex-1 bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col overflow-hidden min-h-[250px]">
                            <div class="p-3 border-b border-slate-100 flex justify-between items-center bg-blue-50/30">
                                <h3 class="font-bold text-sm text-blue-900">Vista Previa: Principal</h3>
                                <span id="info1" class="text-[10px] font-semibold text-blue-600 bg-white px-2 py-1 rounded border border-blue-100 shadow-sm">Esperando datos...</span>
                            </div>
                            <div class="flex-1 overflow-auto custom-scroll relative">
                                <table class="excel-table" id="tabla1"><thead id="head1"></thead><tbody id="body1"></tbody></table>
                            </div>
                        </div>

                        <div class="flex-1 bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col overflow-hidden min-h-[250px]">
                            <div class="p-3 border-b border-slate-100 flex justify-between items-center bg-amber-50/30">
                                <h3 class="font-bold text-sm text-amber-900">Vista Previa: Referencia</h3>
                                <span id="info2" class="text-[10px] font-semibold text-amber-600 bg-white px-2 py-1 rounded border border-amber-100 shadow-sm">Esperando datos...</span>
                            </div>
                            <div class="flex-1 overflow-auto custom-scroll relative">
                                <table class="excel-table" id="tabla2"><thead id="head2"></thead><tbody id="body2"></tbody></table>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, orderBy, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCZXwXN15MYVpFP0-QbgR-H4bHqMH4_EFA", authDomain: "reporte-d37d1.firebaseapp.com", projectId: "reporte-d37d1" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        signInAnonymously(auth).then(() => { window.loadProjs && window.loadProjs(); }).catch(() => console.log("Local mode."));

        // ==========================================
        // üîÑ GLOBAL ROUTER (Navegaci√≥n SaaS)
        // ==========================================
        window.switchSection = function(section) {
            // Esconder todas las secciones maestras
            document.getElementById('section-metrics').classList.add('hidden');
            document.getElementById('section-validations').classList.add('hidden');
            
            // Restablecer estilos en sidebar
            document.getElementById('nav-metrics').className = 'nav-item nav-inactive';
            document.getElementById('nav-validations').className = 'nav-item nav-inactive';
            
            // L√≥gica seg√∫n secci√≥n activa
            if(section === 'metrics') {
                document.getElementById('section-metrics').classList.remove('hidden');
                document.getElementById('nav-metrics').className = 'nav-item nav-active';
                document.getElementById('global-header-title').innerText = "Dashboard Analytics";
                document.getElementById('metrics-tabs').classList.remove('hidden'); // Mostrar tabs 1-4
                window.dispatchEvent(new Event('resize')); // Fix para Chart.js
            } 
            else if(section === 'validations') {
                document.getElementById('section-validations').classList.remove('hidden');
                document.getElementById('nav-validations').className = 'nav-item nav-active';
                document.getElementById('global-header-title').innerText = "Validador de Datos Excel";
                document.getElementById('metrics-tabs').classList.add('hidden'); // Ocultar tabs de m√©tricas
            }
        }

        // ==========================================
        // üß† JS: SISTEMA DE M√âTRICAS (Views 1-4)
        // ==========================================
        let rawWorkbooks = {}; let processedDataSources = {}; let currentFileId = null;
        let savedWidgetsConfig = []; let savedAuditWidgetsConfig = [];

        window.switchView = function(step) {
            ['view-1','view-2','view-3','view-4'].forEach(v => { const el = document.getElementById(v); if(el) { el.classList.add('hidden'); el.classList.remove('flex'); }});
            const target = document.getElementById('view-' + step);
            if(target) { target.classList.remove('hidden'); target.classList.add('flex'); }
            if(step === 4 && Object.keys(processedDataSources).length > 0) buildAuditSidebar();
            setTimeout(() => window.dispatchEvent(new Event('resize')), 100);

            [1,2,3,4].forEach(n => {
                const btn = document.getElementById('step'+n);
                if(btn) {
                    if(n === step) { btn.classList.add('step-active'); btn.classList.remove('step-inactive', 'step-disabled'); } 
                    else { btn.classList.remove('step-active'); if(btn.disabled) btn.classList.add('step-disabled'); else btn.classList.add('step-inactive'); }
                }
            });
        }

        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const files = Array.from(e.target.files); if(files.length===0) return;
            document.getElementById('uploadStatus').innerText = `Procesando ${files.length} archivos...`;
            for(let i=0; i<files.length; i++) {
                const data = await files[i].arrayBuffer();
                rawWorkbooks['file_'+i] = { name: files[i].name, workbook: XLSX.read(data) };
            }
            const fSel = document.getElementById('fileSelector'); fSel.innerHTML = '';
            Object.keys(rawWorkbooks).forEach(id => fSel.innerHTML += `<option value="${id}">${rawWorkbooks[id].name}</option>`);
            document.getElementById('btnNext1').classList.remove('hidden');
            window.changeActiveFile();
            document.getElementById('step2').disabled = false; document.getElementById('step2').classList.remove('step-disabled');
        });

        window.changeActiveFile = function() {
            currentFileId = document.getElementById('fileSelector').value;
            const wb = rawWorkbooks[currentFileId].workbook;
            const sSel = document.getElementById('sheetSelector'); sSel.innerHTML = '';
            wb.SheetNames.forEach(s => sSel.innerHTML += `<option value="${s}">${s}</option>`);
            window.renderRawPreview();
        }

        window.renderRawPreview = function() {
            const wb = rawWorkbooks[currentFileId].workbook;
            const raw = XLSX.utils.sheet_to_json(wb.Sheets[document.getElementById('sheetSelector').value], {header:1, defval:""});
            const tbody = document.getElementById('rawTablePreview'); 
            let th = '<thead><tr><th>#</th>';
            if(raw.length > 0) raw[0].forEach(h => th += `<th>${h}</th>`);
            th += '</tr></thead><tbody>';
            for(let i=1; i<Math.min(raw.length,20); i++) { th += `<tr><td class="font-bold bg-slate-50 border-r text-center">${i}</td>${raw[i].map(c=>`<td>${c}</td>`).join('')}</tr>`; }
            tbody.innerHTML = th + '</tbody>';
        }

        window.saveAsDataSource = function() {
            const wb = rawWorkbooks[currentFileId].workbook; const sName = document.getElementById('sheetSelector').value;
            const hRow = parseInt(document.getElementById('headerRow').value)-1;
            const sheet = wb.Sheets[sName]; let range = XLSX.utils.decode_range(sheet['!ref']); range.s.r = Math.max(0, hRow);
            let clean = XLSX.utils.sheet_to_json(sheet, {range: XLSX.utils.encode_range(range), defval:null}).map(r => { let c={}; for(let k in r) if(!k.includes("__EMPTY")) c[k.trim()]=r[k]; return c; }).filter(r=>Object.keys(r).length>0);
            if(clean.length===0) return alert("Hoja vac√≠a.");
            
            let id = 'ds_'+Date.now(); processedDataSources[id] = { id: id, name: `${rawWorkbooks[currentFileId].name} (${sName})`, columns: Object.keys(clean[0]), data: clean };
            
            const list = document.getElementById('processedSourcesList'); if(list.children[0]?.tagName === 'P') list.innerHTML = '';
            list.innerHTML += `<div class="p-2 border rounded-lg bg-green-50/50 border-green-100 flex items-center gap-2"><div class="w-1.5 h-1.5 rounded-full bg-green-500"></div>${processedDataSources[id].name}</div>`;
            ['step3','step4','btnGoPlayground'].forEach(id => { const el = document.getElementById(id); if(el) { el.disabled=false; el.classList.remove('step-disabled', 'opacity-50'); }});
            updateSelectors();
        }

        function updateSelectors() {
            const dsSel = document.getElementById('dsSelector'); const currentVal = dsSel.value; dsSel.innerHTML = '';
            Object.values(processedDataSources).forEach(d => dsSel.innerHTML += `<option value="${d.id}">${d.name}</option>`);
            if(currentVal && processedDataSources[currentVal]) dsSel.value = currentVal;
            window.onDataSourceChange();
        }

        // ... (El resto del c√≥digo de gr√°ficos / dashboard se mantiene exactamente igual, solo acort√© las funciones repetitivas visuales en este snippet para foco, todo tu c√≥digo previo va aqu√≠)
        // Por brevedad del ejemplo incluyo las funciones requeridas para Chart.js pero omito el contenido completo del renderChart que ya validamos, asumiendo lo tienes.
        window.onDataSourceChange = function() {
            const id = document.getElementById('dsSelector').value; if(!id) return;
            const cols = processedDataSources[id].columns;
            document.querySelectorAll('.column-selector').forEach(s => { s.innerHTML = ''; cols.forEach(c => s.innerHTML+=`<option value="${c}">${c}</option>`); });
        }
        window.selectChartType = function(t) { document.getElementById('selectedChartType').value=t; document.querySelectorAll('.chart-btn').forEach(b => { b.classList.remove('bg-slate-800','text-white'); if(b.dataset.type===t) b.classList.add('bg-slate-800','text-white'); }); }
        window.togglePercentUI = function() { const s=document.getElementById('aggType').value==='percent'||document.getElementById('aggType').value==='count'; document.getElementById('percentTargetUI').classList.toggle('hidden',!s); if(s) window.updatePercentTargets(); }
        window.updatePercentTargets = function() {
            const col=document.getElementById('axisY').value; const id=document.getElementById('dsSelector').value; if(!col||!id)return;
            let vals=new Set(); processedDataSources[id].data.forEach(r=>{if(r[col])vals.add(String(r[col]).trim())});
            const c=document.getElementById('percentTargetValue'); c.innerHTML='';
            Array.from(vals).sort().forEach(v=>c.innerHTML+=`<label class="flex items-center gap-2 border-b p-1 hover:bg-slate-50"><input type="checkbox" class="target-val-chk" value="${v}"><span class="truncate">${v}</span></label>`);
        }

        // ==========================================
        // ‚úÖ JS: SISTEMA DE VALIDACIONES (Adaptado)
        // ==========================================
        let valWb1 = null; let valWb2 = null; // Aislados del dashboard

        function initValidacionFile(fileInputId, wbVarName, hojaId, colId, headId, bodyId, infoId) {
            document.getElementById(fileInputId).addEventListener('change', function(e) {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = function(evt) {
                    const data = new Uint8Array(evt.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    if (wbVarName === 'wb1') valWb1 = workbook; else valWb2 = workbook;
                    const sel = document.getElementById(hojaId); sel.innerHTML = ''; 
                    workbook.SheetNames.forEach(n => sel.appendChild(new Option(n, n)));
                    actualizarPreviewValidacion(workbook, workbook.SheetNames[0], colId, headId, bodyId, infoId);
                };
                reader.readAsArrayBuffer(file);
            });
        }

        function actualizarPreviewValidacion(workbook, hojaName, colId, headId, bodyId, infoId) {
            const sheet = workbook.Sheets[hojaName];
            const json = XLSX.utils.sheet_to_json(sheet, { defval: "" });
            const selCol = document.getElementById(colId); selCol.innerHTML = '';
            const thd = document.getElementById(headId); const tbd = document.getElementById(bodyId);
            thd.innerHTML = ''; tbd.innerHTML = '';

            if (json.length === 0) { document.getElementById(infoId).innerText = "Vac√≠o"; return; }
            
            const cols = Object.keys(json[0]);
            cols.forEach(c => selCol.appendChild(new Option(c, c)));
            
            const limit = Math.min(json.length, 25); // Limitado para UI r√°pida
            document.getElementById(infoId).innerText = `Mostrando ${limit} de ${json.length}`;

            let trH = '<tr><th>#</th>'; cols.forEach(c => trH += `<th>${c}</th>`); trH+='</tr>'; thd.innerHTML = trH;
            let trB = '';
            for (let i=0; i<limit; i++) {
                trB += `<tr><td class="font-bold bg-slate-50">${i+1}</td>`;
                cols.forEach(c => trB += `<td>${json[i][c]}</td>`);
                trB += '</tr>';
            }
            tbd.innerHTML = trB;
        }

        // Listeners Validaciones
        initValidacionFile('archivo1', 'wb1', 'hoja1', 'col1', 'head1', 'body1', 'info1');
        document.getElementById('hoja1').addEventListener('change', e => actualizarPreviewValidacion(valWb1, e.target.value, 'col1', 'head1', 'body1', 'info1'));
        initValidacionFile('archivo2', 'wb2', 'hoja2', 'col2', 'head2', 'body2', 'info2');
        document.getElementById('hoja2').addEventListener('change', e => actualizarPreviewValidacion(valWb2, e.target.value, 'col2', 'head2', 'body2', 'info2'));

        document.getElementById('btnValidar').addEventListener('click', function() {
            if (!valWb1 || !valWb2) return alert("Sube AMBOS archivos Excel.");
            const h1 = document.getElementById('hoja1').value; const c1 = document.getElementById('col1').value;
            const h2 = document.getElementById('hoja2').value; const c2 = document.getElementById('col2').value;
            if (!c1 || !c2) return alert("Selecciona las columnas a comparar.");

            // Motor de b√∫squeda Exacta
            const dataRef = XLSX.utils.sheet_to_json(valWb2.Sheets[h2], { defval: "" });
            const setRef = new Set(dataRef.map(r => String(r[c2]).trim()).filter(d => d !== ""));

            let dataMain = XLSX.utils.sheet_to_json(valWb1.Sheets[h1], { defval: "" });
            dataMain = dataMain.map(r => {
                const val = r[c1] !== undefined ? String(r[c1]).trim() : "";
                r['ESTADOS'] = setRef.has(val) ? 'DIGITALIZADO' : 'NO DIGITALIZADO';
                return r;
            });

            // Descargar
            const newSheet = XLSX.utils.json_to_sheet(dataMain);
            const newWb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(newWb, newSheet, "Auditor√≠a");
            XLSX.writeFile(newWb, "Reporte_Auditoria_DataMaster.xlsx");
        });

    </script>
</body>
</html>
