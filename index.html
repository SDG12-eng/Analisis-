<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Data Workspace v8 - Excel Style</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .tab-active { border-bottom: 3px solid #3b82f6; color: #1d4ed8; font-weight: bold; }
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        /* Efecto de giro para ver la tabla */
        .flip-container { perspective: 1000px; }
        .flipper { transition: 0.6s; transform-style: preserve-3d; position: relative; height: 100%; width: 100%; }
        .front, .back { backface-visibility: hidden; position: absolute; top: 0; left: 0; right: 0; bottom: 0; }
        .front { z-index: 2; transform: rotateY(0deg); }
        .back { transform: rotateY(180deg); background: white; overflow: auto; }
        .flipped .flipper { transform: rotateY(180deg); }
    </style>
</head>
<body class="bg-slate-100 font-sans h-screen flex flex-col overflow-hidden">

    <header class="bg-gray-900 text-white p-4 shadow-lg flex justify-between items-center z-20">
        <h1 class="text-xl font-bold tracking-wider"><i class="fas fa-chart-line text-green-400 mr-2"></i> EXCEL<span class="font-light">WORKSPACE</span></h1>
        <div class="flex gap-4">
            <button id="tab1" class="px-4 py-2 tab-active transition" onclick="switchView(1)">1. Inicio</button>
            <button id="tab2" class="px-4 py-2 text-slate-500 cursor-not-allowed transition" disabled>2. Preparar Datos</button>
            <button id="tab3" class="px-4 py-2 text-slate-500 cursor-not-allowed transition" disabled>3. Dashboard Dinámico</button>
        </div>
    </header>

    <main class="flex-1 relative overflow-hidden">

        <div id="view-upload" class="absolute inset-0 flex flex-col items-center p-10 bg-slate-50 overflow-y-auto">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full max-w-5xl">
                <div class="bg-white p-10 rounded-2xl shadow border border-slate-200 text-center flex flex-col justify-center">
                    <i class="fas fa-file-excel text-6xl text-green-500 mb-6"></i>
                    <h2 class="text-2xl font-bold text-slate-800 mb-2">Nuevo Proyecto</h2>
                    <label class="cursor-pointer bg-blue-50 border-2 border-dashed border-blue-300 rounded-xl p-8 block hover:bg-blue-100 transition mt-4">
                        <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" class="hidden"/>
                        <span class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold shadow-md hover:bg-blue-700 transition"><i class="fas fa-upload mr-2"></i> Subir Archivo</span>
                    </label>
                </div>
                <div class="bg-white p-8 rounded-2xl shadow border border-slate-200 flex flex-col">
                    <h2 class="text-xl font-bold text-slate-800 mb-2"><i class="fas fa-cloud-download-alt text-blue-500 mr-2"></i> Nube Firebase</h2>
                    <div id="cloudProjectsList" class="flex-1 overflow-y-auto space-y-3 bg-slate-50 p-4 rounded border mt-2">
                        <div class="text-center text-slate-400 mt-10"><i class="fas fa-spinner fa-spin text-2xl mb-2"></i><br>Cargando...</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-range" class="absolute inset-0 hidden flex-col bg-slate-50 p-6 overflow-hidden">
            <div class="bg-white rounded-xl shadow-md p-6 flex flex-col h-full border border-slate-200">
                <div class="mb-4 flex flex-wrap justify-between items-end pb-4 border-b gap-4">
                    <div>
                        <h2 class="text-xl font-bold text-slate-800">Preparar Datos</h2>
                    </div>
                    <div class="flex gap-4 items-end flex-wrap">
                        <div>
                            <label class="block text-xs font-bold text-slate-600 uppercase mb-1">Hoja del Excel</label>
                            <select id="sheetSelector" class="w-48 p-2 border rounded bg-blue-50 text-blue-800 font-bold outline-none" onchange="changeSheet()"></select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-600 uppercase mb-1">Fila Encabezados</label>
                            <input type="number" id="headerRow" value="1" min="1" class="w-24 p-2 border rounded text-center font-bold outline-none">
                        </div>
                        <button onclick="extractData()" class="bg-green-600 text-white px-6 py-2 rounded font-bold shadow hover:bg-green-700">Confirmar Datos <i class="fas fa-arrow-right ml-1"></i></button>
                    </div>
                </div>
                <div class="flex-1 overflow-auto border rounded relative">
                    <table class="min-w-full text-xs text-left bg-white" id="rawTablePreview"></table>
                </div>
            </div>
        </div>

        <div id="view-playground" class="absolute inset-0 hidden flex bg-slate-200">
            <aside class="w-96 bg-white shadow-xl z-10 flex flex-col border-r border-slate-300">
                <div class="p-4 bg-slate-800 text-white flex justify-between items-center">
                    <h3 class="font-bold"><i class="fas fa-sliders-h mr-2"></i> Opciones de Gráfico</h3>
                </div>
                
                <div class="p-5 overflow-y-auto flex-1 flex flex-col gap-5 custom-scroll">
                    
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Gráficos Disponibles</label>
                        <div class="grid grid-cols-4 gap-2 text-center text-xs">
                            <button onclick="selectChartType('column')" class="chart-btn p-2 border rounded hover:bg-blue-50 bg-blue-100 border-blue-400" data-type="column"><i class="fas fa-chart-bar text-xl text-blue-600 block mb-1"></i>Columna</button>
                            <button onclick="selectChartType('bar')" class="chart-btn p-2 border rounded hover:bg-blue-50" data-type="bar"><i class="fas fa-align-left text-xl text-blue-600 block mb-1"></i>Barra</button>
                            <button onclick="selectChartType('line')" class="chart-btn p-2 border rounded hover:bg-blue-50" data-type="line"><i class="fas fa-chart-line text-xl text-green-600 block mb-1"></i>Línea</button>
                            <button onclick="selectChartType('area')" class="chart-btn p-2 border rounded hover:bg-blue-50" data-type="area"><i class="fas fa-chart-area text-xl text-green-600 block mb-1"></i>Área</button>
                            <button onclick="selectChartType('pie')" class="chart-btn p-2 border rounded hover:bg-blue-50" data-type="pie"><i class="fas fa-chart-pie text-xl text-orange-500 block mb-1"></i>Circular</button>
                            <button onclick="selectChartType('doughnut')" class="chart-btn p-2 border rounded hover:bg-blue-50" data-type="doughnut"><i class="fas fa-circle-notch text-xl text-orange-500 block mb-1"></i>Dona</button>
                            <button onclick="selectChartType('scatter')" class="chart-btn p-2 border rounded hover:bg-blue-50" data-type="scatter"><i class="fas fa-braille text-xl text-purple-500 block mb-1"></i>Disperso</button>
                        </div>
                        <input type="hidden" id="selectedChartType" value="column">
                    </div>

                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200 flex flex-col gap-3 shadow-inner">
                        <div>
                            <label class="block text-xs font-bold text-blue-900 uppercase mb-1">Nombre de la Métrica</label>
                            <input type="text" id="widgetTitle" placeholder="Ej: Total Documentos por Mes..." class="w-full p-2 border rounded border-blue-300 text-sm outline-none focus:ring-2 focus:ring-blue-400">
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-blue-900 uppercase mb-1">Eje X (Filas / Categorías)</label>
                            <select id="axisX" class="w-full p-2 border rounded border-blue-300 column-selector outline-none text-sm font-semibold" onchange="generateFilters()"></select>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-2 border-t border-blue-200 pt-3">
                            <div class="col-span-1">
                                <label class="block text-xs font-bold text-blue-900 uppercase mb-1">Cálculo</label>
                                <select id="aggType" class="w-full p-2 border rounded border-blue-300 outline-none text-sm font-semibold text-green-700">
                                    <option value="count">Contar</option>
                                    <option value="sum">Sumar</option>
                                    <option value="avg">Promedio</option>
                                </select>
                            </div>
                            <div class="col-span-2">
                                <label class="block text-xs font-bold text-blue-900 uppercase mb-1">Eje Y (Valores)</label>
                                <select id="axisY" class="w-full p-2 border rounded border-blue-300 column-selector outline-none text-sm font-semibold"></select>
                            </div>
                        </div>
                        <p class="text-[10px] text-blue-600 mt-1 leading-tight"><i class="fas fa-info-circle"></i> Tienes control total. Si eliges "Contar", contará cuántas filas válidas existen en la columna del Eje Y.</p>
                    </div>

                    <div class="border border-slate-300 rounded-lg bg-white">
                        <div class="bg-slate-100 p-2 border-b border-slate-300 rounded-t-lg flex justify-between items-center">
                            <h4 class="text-xs font-bold text-slate-700 uppercase"><i class="fas fa-filter mr-1"></i> Filtros de Datos</h4>
                        </div>
                        <div id="filterContainer" class="p-3 max-h-40 overflow-y-auto custom-scroll text-sm space-y-1">
                            <p class="text-xs text-slate-400 italic">Selecciona un Eje X arriba para cargar los filtros.</p>
                        </div>
                    </div>

                    <button onclick="buildWidget()" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold shadow-lg hover:bg-green-700 transition mt-auto transform active:scale-95 border-b-4 border-green-800">
                        <i class="fas fa-play mr-2"></i> Generar Medición
                    </button>

                </div>

                <div class="p-4 bg-slate-800 border-t border-slate-900">
                    <input type="text" id="projectName" placeholder="Nombre de este Dashboard..." class="w-full p-2 text-sm border-none rounded mb-2 bg-slate-700 text-white placeholder-slate-400 focus:ring-2 focus:ring-blue-500 outline-none">
                    <button onclick="saveToFirebase()" id="btnSave" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-2 rounded font-bold shadow transition flex justify-center items-center">
                        <i class="fas fa-cloud-upload-alt mr-2"></i> Guardar en Firebase
                    </button>
                </div>
            </aside>

            <main class="flex-1 p-8 overflow-y-auto relative bg-slate-200" id="dashboardCanvas">
                <div id="widgetsGrid" class="grid grid-cols-1 xl:grid-cols-2 gap-8 relative z-10"></div>
            </main>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, orderBy, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCZXwXN15MYVpFP0-QbgR-H4bHqMH4_EFA",
            authDomain: "reporte-d37d1.firebaseapp.com",
            projectId: "reporte-d37d1",
            storageBucket: "reporte-d37d1.firebasestorage.app",
            messagingSenderId: "995600823465",
            appId: "1:995600823465:web:3ae9ede621cf0631ad65b8"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let rawWorkbook = null;
        let activeSheetName = "";
        let finalData = [];
        let columns = [];
        let savedWidgetsConfig = []; 
        let uniqueValuesForX = []; 

        // --- NAVEGACIÓN ---
        window.switchView = function(step) {
            document.getElementById('view-upload').classList.add('hidden');
            document.getElementById('view-range').classList.add('hidden');
            document.getElementById('view-playground').classList.add('hidden');
            if(step === 1) document.getElementById('view-upload').classList.remove('hidden');
            if(step === 2) document.getElementById('view-range').classList.remove('hidden', 'flex');
            if(step === 3) document.getElementById('view-playground').classList.remove('hidden');
            
            document.getElementById('tab1').className = step === 1 ? "px-4 py-2 tab-active" : "px-4 py-2 text-slate-400 hover:text-white";
            document.getElementById('tab2').className = step === 2 ? "px-4 py-2 tab-active" : (step>2?"px-4 py-2 text-slate-400 hover:text-white":"px-4 py-2 text-slate-600 cursor-not-allowed");
            document.getElementById('tab3').className = step === 3 ? "px-4 py-2 tab-active" : "px-4 py-2 text-slate-600 cursor-not-allowed";
        }

        // --- MANEJO DE ARCHIVOS ---
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const data = await file.arrayBuffer();
            rawWorkbook = XLSX.read(data);
            const sheetSelect = document.getElementById('sheetSelector');
            sheetSelect.innerHTML = '';
            rawWorkbook.SheetNames.forEach(s => sheetSelect.innerHTML += `<option value="${s}">${s}</option>`);
            activeSheetName = rawWorkbook.SheetNames[0];
            document.getElementById('headerRow').value = 1;
            window.renderRawPreview();
            window.switchView(2);
        });

        window.changeSheet = function() { activeSheetName = document.getElementById('sheetSelector').value; window.renderRawPreview(); }

        window.renderRawPreview = function() {
            const rawArray = XLSX.utils.sheet_to_json(rawWorkbook.Sheets[activeSheetName], { header: 1, defval: "" });
            const tbody = document.getElementById('rawTablePreview');
            tbody.innerHTML = '';
            for(let i = 0; i < Math.min(rawArray.length, 30); i++) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="p-2 bg-slate-200 text-slate-500 font-bold border-r w-10 text-center border-b">${i + 1}</td>`;
                rawArray[i].forEach(cell => tr.innerHTML += `<td class="p-2 border-r truncate max-w-xs text-slate-700 border-b">${cell}</td>`);
                tbody.appendChild(tr);
            }
        }

        window.extractData = function() {
            const headerRowNum = parseInt(document.getElementById('headerRow').value);
            const sheet = rawWorkbook.Sheets[activeSheetName];
            let range = XLSX.utils.decode_range(sheet['!ref']);
            range.s.r = Math.max(0, headerRowNum - 1);
            
            finalData = XLSX.utils.sheet_to_json(sheet, { range: XLSX.utils.encode_range(range), defval: null });
            finalData = finalData.map(row => { let clean = {}; for(let key in row) if(!key.includes("__EMPTY")) clean[key.trim()] = row[key]; return clean; });
            
            if(finalData.length === 0) return alert("No se encontraron datos.");

            columns = Object.keys(finalData[0]);
            document.querySelectorAll('.column-selector').forEach(sel => {
                sel.innerHTML = '';
                columns.forEach(col => sel.innerHTML += `<option value="${col}">${col}</option>`);
            });
            
            document.getElementById('widgetsGrid').innerHTML = '';
            savedWidgetsConfig = [];
            window.generateFilters(); 
            window.switchView(3);
        }

        // --- CONSTRUCTOR MANUAL ---
        
        window.selectChartType = function(type) {
            document.getElementById('selectedChartType').value = type;
            document.querySelectorAll('.chart-btn').forEach(b => {
                b.classList.remove('bg-blue-100', 'border-blue-400');
                if(b.dataset.type === type) b.classList.add('bg-blue-100', 'border-blue-400');
            });
        }

        window.generateFilters = function() {
            const xCol = document.getElementById('axisX').value;
            if(!xCol) return;
            let uniqueSet = new Set();
            finalData.forEach(row => {
                let val = row[xCol];
                if (val !== null && val !== undefined && val !== '') uniqueSet.add(val.toString().trim());
            });
            uniqueValuesForX = Array.from(uniqueSet).sort();
            
            const container = document.getElementById('filterContainer');
            container.innerHTML = '';
            uniqueValuesForX.forEach(val => {
                container.innerHTML += `
                    <label class="flex items-center gap-2 cursor-pointer hover:bg-slate-200 p-1.5 rounded transition">
                        <input type="checkbox" value="${val}" checked class="filter-checkbox w-4 h-4 text-blue-600 rounded">
                        <span class="truncate font-medium text-slate-700" title="${val}">${val}</span>
                    </label>
                `;
            });
        }

        window.buildWidget = function(existingConfig = null) {
            let config = existingConfig;

            if (!config) {
                let checkedFilters = Array.from(document.querySelectorAll('.filter-checkbox:checked')).map(cb => cb.value);
                let axisX = document.getElementById('axisX').value;
                let axisY = document.getElementById('axisY').value;
                let agg = document.getElementById('aggType').value;
                let userTitle = document.getElementById('widgetTitle').value || `Medición: ${agg.toUpperCase()} de ${axisY} por ${axisX}`;

                config = {
                    title: userTitle,
                    type: document.getElementById('selectedChartType').value,
                    axisX: axisX,
                    axisY: axisY,
                    agg: agg,
                    allowedFilters: checkedFilters
                };
                savedWidgetsConfig.push(config);
            }

            const widgetId = 'w_' + Date.now() + Math.random().toString(36).substr(2, 5);
            const grid = document.getElementById('widgetsGrid');
            const card = document.createElement('div');
            
            // Estructura con Volteo (Flip) para ver la Tabla
            card.className = "flip-container h-[450px] w-full bg-transparent perspective-1000";
            card.innerHTML = `
                <div class="flipper rounded-2xl shadow-lg border border-slate-200 bg-white" id="flipper_${widgetId}">
                    
                    <div class="front p-6 flex flex-col bg-white rounded-2xl">
                        <div class="flex justify-between items-start mb-4 border-b border-slate-100 pb-2">
                            <div class="flex-1 pr-4">
                                <h3 class="font-bold text-slate-800 text-lg truncate" title="${config.title}">${config.title}</h3>
                                <p class="text-xs text-slate-400 uppercase tracking-wide">
                                    <span class="font-bold text-blue-500">${config.agg}</span>(${config.axisY}) agrupar por <span class="font-bold text-blue-500">${config.axisX}</span>
                                </p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="document.getElementById('flipper_${widgetId}').parentNode.classList.toggle('flipped')" class="text-slate-400 hover:text-blue-600 transition p-2 bg-slate-50 rounded" title="Ver Datos como Tabla Dinámica"><i class="fas fa-table"></i></button>
                                <button onclick="this.closest('.flip-container').remove()" class="text-slate-400 hover:text-red-500 transition p-2 bg-slate-50 rounded" title="Eliminar"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        <div class="flex-1 relative w-full h-full min-h-0"><canvas id="${widgetId}"></canvas></div>
                    </div>

                    <div class="back p-6 flex flex-col bg-slate-50 rounded-2xl border-2 border-blue-400">
                        <div class="flex justify-between items-center mb-4 border-b border-slate-300 pb-2">
                            <h3 class="font-bold text-blue-800 text-lg"><i class="fas fa-table mr-2"></i>Datos: ${config.title}</h3>
                            <button onclick="document.getElementById('flipper_${widgetId}').parentNode.classList.toggle('flipped')" class="text-white bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded shadow text-sm font-bold transition"><i class="fas fa-chart-bar mr-1"></i> Volver al Gráfico</button>
                        </div>
                        <div class="flex-1 overflow-auto custom-scroll border border-slate-200 rounded bg-white">
                            <table class="min-w-full text-sm text-left" id="table_${widgetId}">
                                <thead class="bg-blue-100 text-blue-900 sticky top-0 z-10">
                                    <tr>
                                        <th class="px-4 py-2 border-b border-r">${config.axisX} (Filas)</th>
                                        <th class="px-4 py-2 border-b">${config.agg.toUpperCase()} de ${config.axisY} (Valores)</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100" id="tbody_${widgetId}"></tbody>
                            </table>
                        </div>
                    </div>

                </div>
            `;
            grid.appendChild(card);

            setTimeout(() => renderAdvancedChart(config, widgetId), 50);
            document.getElementById('widgetTitle').value = ''; // Limpiar
        }

        function renderAdvancedChart(config, canvasId) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            // 1. FILTRAR
            let filteredData = finalData.filter(row => {
                let xVal = row[config.axisX] !== null && row[config.axisX] !== undefined ? row[config.axisX].toString().trim() : "";
                return config.allowedFilters.includes(xVal);
            });

            // 2. LÓGICA MANUAL (AGRUPAR Y CALCULAR)
            let grouped = {};
            
            filteredData.forEach(row => {
                let key = row[config.axisX] || '(Vacío)';
                let rawY = row[config.axisY];
                let yVal = parseFloat(rawY) || 0;

                if (!grouped[key]) grouped[key] = { sum: 0, count: 0, validElements: 0 };

                if (config.agg === 'count') {
                    // Contar si el Eje Y tiene algún valor válido (no vacío/null)
                    if (rawY !== null && rawY !== undefined && rawY !== '') {
                        grouped[key].validElements += 1;
                    }
                } else {
                    grouped[key].sum += yVal;
                    grouped[key].count += 1; // Para el promedio
                }
            });

            // Preparar arrays para Chart.js y la Tabla
            let finalLabels = [];
            let finalValues = [];
            let tbodyHtml = '';
            let totalGeneral = 0;

            let sortedKeys = Object.keys(grouped).sort((a, b) => {
                let valA = config.agg === 'count' ? grouped[a].validElements : grouped[a].sum;
                let valB = config.agg === 'count' ? grouped[b].validElements : grouped[b].sum;
                return valB - valA; // Mayor a menor
            });

            sortedKeys.forEach(k => {
                let val = 0;
                if(config.agg === 'count') val = grouped[k].validElements;
                else if(config.agg === 'sum') val = grouped[k].sum;
                else if(config.agg === 'avg') val = grouped[k].sum / grouped[k].count;

                // Redondear a 2 decimales si tiene decimales
                val = Math.round(val * 100) / 100;

                finalLabels.push(k);
                finalValues.push(val);
                totalGeneral += val;

                // Construir fila de la Tabla de Datos
                tbodyHtml += `
                    <tr class="hover:bg-slate-50 transition">
                        <td class="px-4 py-2 border-r text-slate-700 font-medium">${k}</td>
                        <td class="px-4 py-2 font-bold text-slate-900">${val.toLocaleString('en-US')}</td>
                    </tr>
                `;
            });

            // Añadir Total General a la tabla
            tbodyHtml += `
                <tr class="bg-slate-100 font-black text-slate-900">
                    <td class="px-4 py-3 border-r text-right">TOTAL GENERAL:</td>
                    <td class="px-4 py-3">${(Math.round(totalGeneral * 100) / 100).toLocaleString('en-US')}</td>
                </tr>
            `;
            document.getElementById(`tbody_${canvasId}`).innerHTML = tbodyHtml;

            // 3. MAPEAR A CHART.JS
            let cType = 'bar'; 
            let cOptions = { 
                responsive: true, maintainAspectRatio: false, 
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        callbacks: { label: function(context) { return ` ${config.axisY}: ${context.raw.toLocaleString()}`; } }
                    }
                } 
            };
            let cDataset = { label: config.axisY, data: finalValues, backgroundColor: getColors(finalLabels.length) };

            switch(config.type) {
                case 'column': cType = 'bar'; break;
                case 'bar': cType = 'bar'; cOptions.indexAxis = 'y'; break;
                case 'line': cType = 'line'; cDataset.borderColor = '#2563eb'; cDataset.tension = 0.3; cDataset.fill = false; break;
                case 'area': cType = 'line'; cDataset.borderColor = '#16a34a'; cDataset.backgroundColor = 'rgba(22, 163, 74, 0.2)'; cDataset.fill = true; cDataset.tension = 0.3; break;
                case 'pie': cType = 'pie'; cOptions.plugins.legend = { display: true, position: 'right' }; break;
                case 'doughnut': cType = 'doughnut'; cOptions.plugins.legend = { display: true, position: 'right' }; break;
                case 'scatter':
                    cType = 'scatter';
                    cOptions.plugins.legend = { display: true };
                    let scatterData = filteredData.map(r => ({ x: parseFloat(r[config.axisX])||0, y: parseFloat(r[config.axisY])||0 }));
                    cDataset = { label: 'Dispersión', data: scatterData, backgroundColor: '#ef4444' };
                    finalLabels = [];
                    break;
            }

            new Chart(ctx, { type: cType, data: { labels: finalLabels, datasets: [cDataset] }, options: cOptions });
        }

        function getColors(count) {
            const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#64748b', '#84cc16'];
            return Array(count).fill().map((_, i) => colors[i % colors.length]);
        }

        // --- FIREBASE NUBE ---
        window.saveToFirebase = async function() {
            const name = document.getElementById('projectName').value || "Dashboard Dinámico";
            const btn = document.getElementById('btnSave');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Guardando...';
            btn.disabled = true;

            try {
                await addDoc(collection(db, "reportes"), {
                    nombre: name,
                    fecha: serverTimestamp(),
                    hoja: activeSheetName,
                    columnas: columns,
                    datosJSON: JSON.stringify(finalData),
                    configuracionGraficos: savedWidgetsConfig
                });
                alert("¡Dashboard guardado con éxito!");
                loadCloudProjects();
            } catch (error) {
                alert("Error al guardar.");
            } finally {
                btn.innerHTML = '<i class="fas fa-cloud-upload-alt mr-2"></i> Guardar en Firebase';
                btn.disabled = false;
            }
        }

        async function loadCloudProjects() {
            const listDiv = document.getElementById('cloudProjectsList');
            try {
                const q = query(collection(db, "reportes"), orderBy("fecha", "desc"));
                const querySnapshot = await getDocs(q);
                listDiv.innerHTML = '';
                if(querySnapshot.empty) { listDiv.innerHTML = '<p class="text-slate-500 text-center text-sm">No hay reportes.</p>'; return; }
                querySnapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const btn = document.createElement('button');
                    btn.className = "w-full text-left p-3 bg-white border rounded hover:border-blue-500 hover:shadow transition group text-sm";
                    btn.innerHTML = `<p class="font-bold text-slate-700 group-hover:text-blue-600">${data.nombre}</p><p class="text-xs text-slate-400">${data.hoja || 'Hoja'} - ${data.configuracionGraficos?.length || 0} Gráficos</p>`;
                    btn.onclick = () => openCloudProject(data);
                    listDiv.appendChild(btn);
                });
            } catch (error) {}
        }

        window.openCloudProject = function(firebaseData) {
            columns = firebaseData.columnas;
            finalData = JSON.parse(firebaseData.datosJSON);
            savedWidgetsConfig = firebaseData.configuracionGraficos || [];
            
            document.querySelectorAll('.column-selector').forEach(sel => {
                sel.innerHTML = '';
                columns.forEach(col => sel.innerHTML += `<option value="${col}">${col}</option>`);
            });
            window.generateFilters();

            document.getElementById('projectName').value = firebaseData.nombre;
            document.getElementById('widgetsGrid').innerHTML = ''; 
            savedWidgetsConfig.forEach(cfg => window.buildWidget(cfg));
            window.switchView(3);
        }

        loadCloudProjects();
    </script>
</body>
</html>
