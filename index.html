<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Workspace - Analizador Avanzado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .tab-active { border-bottom: 3px solid #3b82f6; color: #1d4ed8; font-weight: bold; }
    </style>
</head>
<body class="bg-slate-100 font-sans h-screen flex flex-col overflow-hidden">

    <header class="bg-gray-900 text-white p-4 shadow-lg flex justify-between items-center z-20">
        <h1 class="text-xl font-bold tracking-wider"><i class="fas fa-database text-blue-400 mr-2"></i> DATA<span class="font-light">WORKSPACE</span></h1>
        <div class="flex gap-4">
            <button id="tab1" class="px-4 py-2 tab-active transition">1. Cargar Archivo</button>
            <button id="tab2" class="px-4 py-2 text-gray-400 cursor-not-allowed transition" disabled>2. Rango de Datos</button>
            <button id="tab3" class="px-4 py-2 text-gray-400 cursor-not-allowed transition" disabled>3. Analizar (Playground)</button>
        </div>
    </header>

    <main class="flex-1 relative overflow-hidden">

        <div id="view-upload" class="absolute inset-0 flex flex-col items-center justify-center p-6 bg-slate-50 transition-opacity">
            <div class="bg-white p-10 rounded-2xl shadow-xl w-full max-w-2xl text-center border border-slate-200">
                <i class="fas fa-file-excel text-6xl text-green-500 mb-6"></i>
                <h2 class="text-2xl font-bold text-slate-800 mb-2">Importar Datos</h2>
                <p class="text-slate-500 mb-8">Sube tu archivo para comenzar a jugar con las métricas.</p>
                
                <label class="cursor-pointer bg-blue-50 border-2 border-dashed border-blue-300 rounded-xl p-8 block hover:bg-blue-100 transition">
                    <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" class="hidden"/>
                    <span class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold shadow-md hover:bg-blue-700 transition"><i class="fas fa-upload mr-2"></i> Explorar Archivo</span>
                </label>
            </div>
        </div>

        <div id="view-range" class="absolute inset-0 hidden flex-col bg-slate-50 p-6 overflow-hidden">
            <div class="bg-white rounded-xl shadow-md p-6 flex flex-col h-full border border-slate-200">
                <div class="mb-4 flex justify-between items-end pb-4 border-b">
                    <div>
                        <h2 class="text-xl font-bold text-slate-800">Definir Rango de Datos</h2>
                        <p class="text-sm text-slate-500">Indica dónde empiezan los encabezados y hasta qué fila leer.</p>
                    </div>
                    <div class="flex gap-4 items-end">
                        <div>
                            <label class="block text-xs font-bold text-slate-600 uppercase mb-1">Fila de Encabezados</label>
                            <input type="number" id="headerRow" value="1" min="1" class="w-24 p-2 border rounded bg-slate-50 text-center font-bold">
                        </div>
                        <button onclick="extractData()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded font-bold shadow transition">
                            Confirmar Rango <i class="fas fa-check ml-2"></i>
                        </button>
                    </div>
                </div>

                <div class="flex-1 overflow-auto border rounded bg-slate-100 relative">
                    <table class="min-w-full text-xs text-left bg-white" id="rawTablePreview">
                        </table>
                </div>
            </div>
        </div>

        <div id="view-playground" class="absolute inset-0 hidden flex bg-slate-100">
            <aside class="w-80 bg-white shadow-lg z-10 flex flex-col border-r border-slate-200">
                <div class="p-4 bg-slate-800 text-white">
                    <h3 class="font-bold"><i class="fas fa-toolbox mr-2"></i> Creador de Análisis</h3>
                </div>
                
                <div class="p-4 overflow-y-auto flex-1 flex flex-col gap-6">
                    
                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                        <h4 class="font-bold text-blue-800 mb-2 text-sm"><i class="fas fa-chart-pie mr-1"></i> Contar Categorías</h4>
                        <p class="text-xs text-blue-600 mb-3">Ideal para: Estados, Tipos, Sí/No.</p>
                        <select id="countCol" class="w-full p-2 text-sm border rounded mb-2 bg-white column-selector"></select>
                        <button onclick="createWidget('count')" class="w-full bg-blue-600 text-white py-2 rounded text-sm font-bold shadow hover:bg-blue-700">Crear Gráfico</button>
                    </div>

                    <div class="bg-green-50 p-4 rounded-xl border border-green-100">
                        <h4 class="font-bold text-green-800 mb-2 text-sm"><i class="fas fa-calculator mr-1"></i> Operaciones Matemáticas</h4>
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <select id="mathOp" class="p-2 text-sm border rounded bg-white">
                                <option value="sum">Sumar</option>
                                <option value="avg">Promediar</option>
                            </select>
                            <select id="mathValCol" class="p-2 text-sm border rounded bg-white column-selector" title="Columna a sumar"></select>
                        </div>
                        <label class="text-xs text-green-700 font-bold">Agrupar por (Opcional):</label>
                        <select id="mathGroupCol" class="w-full p-2 text-sm border rounded mb-2 bg-white column-selector">
                            <option value="">-- Sin agrupar (Total General) --</option>
                        </select>
                        <button onclick="createWidget('math')" class="w-full bg-green-600 text-white py-2 rounded text-sm font-bold shadow hover:bg-green-700">Calcular</button>
                    </div>

                    <div class="bg-purple-50 p-4 rounded-xl border border-purple-100">
                        <h4 class="font-bold text-purple-800 mb-2 text-sm"><i class="fas fa-code-branch mr-1"></i> Cruzar Columnas</h4>
                        <p class="text-xs text-purple-600 mb-2">Eje X vs Eje Y (Cantidades)</p>
                        <select id="crossX" class="w-full p-2 text-sm border rounded mb-2 bg-white column-selector" title="Eje X"></select>
                        <select id="crossY" class="w-full p-2 text-sm border rounded mb-2 bg-white column-selector" title="Eje Y"></select>
                        <button onclick="createWidget('cross')" class="w-full bg-purple-600 text-white py-2 rounded text-sm font-bold shadow hover:bg-purple-700">Generar Comparación</button>
                    </div>

                </div>
            </aside>

            <main class="flex-1 p-6 overflow-y-auto relative" id="dashboardCanvas">
                <div id="emptyWorkspace" class="absolute inset-0 flex flex-col items-center justify-center text-slate-400">
                    <i class="fas fa-shapes text-6xl mb-4 opacity-50"></i>
                    <h2 class="text-2xl font-bold mb-2">Lienzo Vacío</h2>
                    <p>Usa el panel izquierdo para crear gráficos y métricas a tu gusto.</p>
                </div>
                <div id="widgetsGrid" class="grid grid-cols-1 xl:grid-cols-2 gap-6 relative z-10"></div>
            </main>
        </div>

    </main>

    <script>
        let rawWorkbook = null;
        let activeSheetName = "";
        let finalData = [];
        let columns = [];
        let chartIdCounter = 0;

        // --- NAVEGACIÓN DE VISTAS ---
        function switchView(step) {
            document.getElementById('view-upload').classList.add('hidden');
            document.getElementById('view-range').classList.add('hidden');
            document.getElementById('view-playground').classList.add('hidden');
            
            if(step === 1) document.getElementById('view-upload').classList.remove('hidden');
            if(step === 2) document.getElementById('view-range').classList.remove('hidden', 'flex');
            if(step === 3) document.getElementById('view-playground').classList.remove('hidden');

            document.getElementById('tab1').className = step === 1 ? "px-4 py-2 tab-active transition" : "px-4 py-2 text-slate-300 transition";
            document.getElementById('tab2').className = step === 2 ? "px-4 py-2 tab-active transition" : (step > 2 ? "px-4 py-2 text-slate-300 transition" : "px-4 py-2 text-gray-500 cursor-not-allowed transition");
            document.getElementById('tab3').className = step === 3 ? "px-4 py-2 tab-active transition" : "px-4 py-2 text-gray-500 cursor-not-allowed transition";
        }

        // --- PASO 1: CARGAR ARCHIVO ---
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const data = await file.arrayBuffer();
            rawWorkbook = XLSX.read(data);
            activeSheetName = rawWorkbook.SheetNames[0]; // Toma la primera hoja
            
            renderRawPreview();
            switchView(2);
        });

        // --- PASO 2: SELECCIONAR RANGO ---
        function renderRawPreview() {
            const sheet = rawWorkbook.Sheets[activeSheetName];
            // Leer como array 2D crudo (sin importar encabezados aún)
            const rawArray = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });
            
            const tbody = document.getElementById('rawTablePreview');
            tbody.innerHTML = '';

            // Renderizar las primeras 30 filas para que el usuario ubique sus encabezados
            const limit = Math.min(rawArray.length, 30);
            for(let i = 0; i < limit; i++) {
                const tr = document.createElement('tr');
                tr.className = "border-b hover:bg-slate-100";
                
                // Columna de número de fila
                const tdNum = document.createElement('td');
                tdNum.className = "p-2 bg-slate-200 text-slate-500 font-bold border-r w-10 text-center";
                tdNum.innerText = i + 1;
                tr.appendChild(tdNum);

                rawArray[i].forEach(cell => {
                    const td = document.createElement('td');
                    td.className = "p-2 border-r truncate max-w-[150px]";
                    td.innerText = cell;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            }
        }

        function extractData() {
            const headerRowNum = parseInt(document.getElementById('headerRow').value);
            const sheet = rawWorkbook.Sheets[activeSheetName];
            
            // Extraer datos usando la fila especificada como encabezado (0-indexado en JS)
            // SheetJS usa range: N para saltar N filas. Si el encabezado es fila 3, saltamos 2.
            const skipRows = headerRowNum > 0 ? headerRowNum - 1 : 0;
            
            // Configurar el rango dinámicamente
            let range = XLSX.utils.decode_range(sheet['!ref']);
            range.s.r = skipRows; // Setear inicio de fila
            let newRange = XLSX.utils.encode_range(range);

            finalData = XLSX.utils.sheet_to_json(sheet, { range: newRange, defval: null });
            
            if(finalData.length === 0) {
                alert("No se encontraron datos a partir de esa fila.");
                return;
            }

            // Limpiar claves vacías generadas por SheetJS (__EMPTY)
            finalData = finalData.map(row => {
                let cleanRow = {};
                for(let key in row) {
                    if(!key.includes("__EMPTY")) cleanRow[key.trim()] = row[key];
                }
                return cleanRow;
            });

            columns = Object.keys(finalData[0]);
            populateSelectors();
            switchView(3);
        }

        // --- PASO 3: PLAYGROUND / MOTORES DE ANÁLISIS ---
        function populateSelectors() {
            const selectors = document.querySelectorAll('.column-selector');
            selectors.forEach(sel => {
                // Guardar la opción por defecto si existe (ej. "-- Sin agrupar --")
                const defaultOption = sel.querySelector('option[value=""]');
                sel.innerHTML = '';
                if(defaultOption) sel.appendChild(defaultOption);

                columns.forEach(col => {
                    sel.innerHTML += `<option value="${col}">${col}</option>`;
                });
            });
        }

        function createWidget(type) {
            document.getElementById('emptyWorkspace').style.display = 'none';
            const grid = document.getElementById('widgetsGrid');
            const widgetId = 'chart_' + chartIdCounter++;
            
            // Contenedor del Widget
            const card = document.createElement('div');
            card.className = "bg-white p-5 rounded-2xl shadow-sm border border-slate-200 relative group flex flex-col";
            card.innerHTML = `
                <button onclick="this.parentElement.remove()" class="absolute top-3 right-3 text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><i class="fas fa-trash"></i></button>
                <h3 class="font-bold text-slate-700 mb-4 text-sm" id="title_${widgetId}">Analizando...</h3>
                <div class="flex-1 relative min-h-[250px]"><canvas id="${widgetId}"></canvas></div>
                <div id="data_${widgetId}" class="mt-4 pt-4 border-t border-slate-100 text-xs text-slate-500"></div>
            `;
            grid.appendChild(card);

            const ctx = document.getElementById(widgetId).getContext('2d');
            let chartConfig = null;

            // --- MOTOR DE CONTEOS (Frecuencias) ---
            if(type === 'count') {
                const col = document.getElementById('countCol').value;
                document.getElementById(`title_${widgetId}`).innerHTML = `<i class="fas fa-chart-pie text-blue-500 mr-2"></i> Conteo de: ${col}`;
                
                let counts = {};
                let totalItems = 0;
                finalData.forEach(row => {
                    let val = row[col] || '(Vacío)';
                    counts[val] = (counts[val] || 0) + 1;
                    totalItems++;
                });

                // Ordenar de mayor a menor
                let sortedCounts = Object.entries(counts).sort((a,b) => b[1] - a[1]);
                let labels = sortedCounts.map(item => item[0]);
                let data = sortedCounts.map(item => item[1]);

                document.getElementById(`data_${widgetId}`).innerHTML = `Total registros procesados: <b>${totalItems}</b> | Categorías únicas: <b>${labels.length}</b>`;

                chartConfig = {
                    type: 'doughnut',
                    data: { labels: labels, datasets: [{ data: data, backgroundColor: getColors(labels.length) }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
                };
            }

            // --- MOTOR MATEMÁTICO (Sumas/Promedios) ---
            if(type === 'math') {
                const op = document.getElementById('mathOp').value;
                const valCol = document.getElementById('mathValCol').value;
                const groupCol = document.getElementById('mathGroupCol').value;
                
                let titlePrefix = op === 'sum' ? 'Suma' : 'Promedio';
                let title = groupCol ? `${titlePrefix} de ${valCol} por ${groupCol}` : `${titlePrefix} Total de ${valCol}`;
                document.getElementById(`title_${widgetId}`).innerHTML = `<i class="fas fa-calculator text-green-500 mr-2"></i> ${title}`;

                if(!groupCol) {
                    // KPI Simple (Sin gráfico)
                    let sum = finalData.reduce((acc, row) => acc + (parseFloat(row[valCol]) || 0), 0);
                    let result = op === 'sum' ? sum : (sum / finalData.length);
                    document.getElementById(widgetId).style.display = 'none'; // ocultar canvas
                    card.querySelector('.flex-1').innerHTML = `
                        <div class="flex items-center justify-center h-full">
                            <span class="text-5xl font-black text-green-600">${result.toLocaleString(undefined, {maximumFractionDigits:2})}</span>
                        </div>
                    `;
                    return;
                } else {
                    // Agrupado
                    let grouped = {};
                    let counts = {};
                    finalData.forEach(row => {
                        let gVal = row[groupCol] || '(Vacío)';
                        let num = parseFloat(row[valCol]) || 0;
                        grouped[gVal] = (grouped[gVal] || 0) + num;
                        counts[gVal] = (counts[gVal] || 0) + 1;
                    });

                    let labels = Object.keys(grouped);
                    let data = labels.map(l => op === 'sum' ? grouped[l] : (grouped[l] / counts[l]));

                    document.getElementById(`data_${widgetId}`).innerHTML = `Grupos analizados: <b>${labels.length}</b>`;

                    chartConfig = {
                        type: 'bar',
                        data: { labels: labels, datasets: [{ label: title, data: data, backgroundColor: 'rgba(34, 197, 94, 0.6)', borderColor: 'rgb(21, 128, 61)', borderWidth: 1 }] },
                        options: { responsive: true, maintainAspectRatio: false }
                    };
                }
            }

            // --- MOTOR DE CRUCE (X vs Y) ---
            if(type === 'cross') {
                const colX = document.getElementById('crossX').value;
                const colY = document.getElementById('crossY').value;
                document.getElementById(`title_${widgetId}`).innerHTML = `<i class="fas fa-code-branch text-purple-500 mr-2"></i> Relación: ${colY} según ${colX}`;
                
                let grouped = {};
                finalData.forEach(row => {
                    let xVal = row[colX] || '(Vacío)';
                    let numY = parseFloat(row[colY]) || 0;
                    grouped[xVal] = (grouped[xVal] || 0) + numY;
                });

                let labels = Object.keys(grouped);
                let data = Object.values(grouped);

                chartConfig = {
                    type: 'line',
                    data: { labels: labels, datasets: [{ label: colY, data: data, borderColor: 'rgb(168, 85, 247)', backgroundColor: 'rgba(168, 85, 247, 0.2)', fill: true, tension: 0.3 }] },
                    options: { responsive: true, maintainAspectRatio: false }
                };
            }

            // Renderizar Gráfico si aplica
            if(chartConfig) new Chart(ctx, chartConfig);
        }

        // Utilidades
        function getColors(count) {
            const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'];
            return Array(count).fill().map((_, i) => colors[i % colors.length]);
        }
    </script>
</body>
</html>
