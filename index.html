<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Analytics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 font-sans">

    <div class="flex h-screen">
        <aside class="w-64 bg-white shadow-md flex flex-col p-4">
            <h1 class="text-2xl font-bold text-blue-600 mb-6">DataMaster</h1>
            
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">1. Subir Excel (.xlsx, .csv)</label>
                <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
            </div>

            <div id="controls" class="hidden space-y-4">
                <h3 class="text-sm font-semibold text-gray-500 uppercase">2. Parámetros</h3>
                
                <div>
                    <label class="block text-xs text-gray-600">Eje X (Categoría/Fecha)</label>
                    <select id="xAxisSelect" class="w-full border rounded p-2 mt-1 bg-gray-50"></select>
                </div>

                <div>
                    <label class="block text-xs text-gray-600">Eje Y (Valores/Datos)</label>
                    <select id="yAxisSelect" class="w-full border rounded p-2 mt-1 bg-gray-50"></select>
                </div>

                <div>
                    <label class="block text-xs text-gray-600">Tipo de Gráfico</label>
                    <select id="chartType" class="w-full border rounded p-2 mt-1 bg-gray-50">
                        <option value="bar">Barras</option>
                        <option value="line">Línea (Tendencia)</option>
                        <option value="pie">Pastel (Porcentajes)</option>
                        <option value="doughnut">Dona</option>
                    </select>
                </div>

                <button onclick="generateDashboard()" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition">Generar Dashboard</button>
            </div>
        </aside>

        <main class="flex-1 p-8 overflow-y-auto">
            <div id="metricsPanel" class="grid grid-cols-4 gap-4 mb-8 hidden">
                <div class="bg-white p-4 rounded shadow border-l-4 border-blue-500">
                    <p class="text-gray-500 text-sm">Total Registros</p>
                    <p class="text-2xl font-bold" id="metricCount">0</p>
                </div>
                <div class="bg-white p-4 rounded shadow border-l-4 border-green-500">
                    <p class="text-gray-500 text-sm">Suma Total</p>
                    <p class="text-2xl font-bold" id="metricSum">0</p>
                </div>
                <div class="bg-white p-4 rounded shadow border-l-4 border-yellow-500">
                    <p class="text-gray-500 text-sm">Promedio</p>
                    <p class="text-2xl font-bold" id="metricAvg">0</p>
                </div>
                <div class="bg-white p-4 rounded shadow border-l-4 border-purple-500">
                    <p class="text-gray-500 text-sm">Máximo Valor</p>
                    <p class="text-2xl font-bold" id="metricMax">0</p>
                </div>
            </div>

            <div id="dashboardArea" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                </div>
            
            <div class="mt-8 bg-white rounded shadow hidden" id="tablePreview">
                <div class="p-4 border-b">
                    <h3 class="font-bold">Vista Previa de Datos</h3>
                </div>
                <div class="overflow-x-auto p-4">
                    <table class="min-w-full text-sm text-left text-gray-500" id="dataTable">
                        </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        let globalData = [];
        let chartInstances = [];

        // 1. Escuchar la carga del archivo
        document.getElementById('fileInput').addEventListener('change', handleFile);

        function handleFile(e) {
            const file = e.target.files[0];
            const reader = new FileReader();

            reader.onload = function(event) {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                
                // Tomamos la primera hoja del Excel
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // Convertimos a JSON
                globalData = XLSX.utils.sheet_to_json(worksheet);

                if (globalData.length > 0) {
                    populateControls();
                    renderTablePreview(globalData.slice(0, 5)); // Mostrar solo 5 primeras filas
                    document.getElementById('controls').classList.remove('hidden');
                    document.getElementById('tablePreview').classList.remove('hidden');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // 2. Llenar los selectores con las columnas del Excel
        function populateControls() {
            const keys = Object.keys(globalData[0]);
            const xSelect = document.getElementById('xAxisSelect');
            const ySelect = document.getElementById('yAxisSelect');
            
            xSelect.innerHTML = '';
            ySelect.innerHTML = '';

            keys.forEach(key => {
                xSelect.innerHTML += `<option value="${key}">${key}</option>`;
                ySelect.innerHTML += `<option value="${key}">${key}</option>`;
            });
        }

        // 3. Generar Dashboard y Métricas
        function generateDashboard() {
            const xKey = document.getElementById('xAxisSelect').value;
            const yKey = document.getElementById('yAxisSelect').value;
            const type = document.getElementById('chartType').value;

            // Preparar datos para el gráfico
            const labels = globalData.map(item => item[xKey]);
            const dataValues = globalData.map(item => parseFloat(item[yKey]) || 0);

            // Calcular métricas
            calculateMetrics(dataValues);

            // Crear contenedor para el nuevo gráfico
            const dashboardArea = document.getElementById('dashboardArea');
            const canvasContainer = document.createElement('div');
            canvasContainer.className = "bg-white p-4 rounded shadow h-80 relative";
            
            // Botón para borrar gráfico
            const closeBtn = document.createElement('button');
            closeBtn.innerText = "X";
            closeBtn.className = "absolute top-2 right-2 text-red-500 font-bold hover:text-red-700";
            closeBtn.onclick = () => canvasContainer.remove();
            
            const canvas = document.createElement('canvas');
            canvasContainer.appendChild(closeBtn);
            canvasContainer.appendChild(canvas);
            dashboardArea.prepend(canvasContainer);

            // Renderizar Gráfico
            new Chart(canvas, {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: `${yKey} por ${xKey}`,
                        data: dataValues,
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.6)',
                            'rgba(16, 185, 129, 0.6)',
                            'rgba(245, 158, 11, 0.6)',
                            'rgba(239, 68, 68, 0.6)',
                            'rgba(139, 92, 246, 0.6)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // 4. Calcular estadísticas básicas
        function calculateMetrics(values) {
            document.getElementById('metricsPanel').classList.remove('hidden');
            
            const count = values.length;
            const sum = values.reduce((a, b) => a + b, 0);
            const avg = sum / count;
            const max = Math.max(...values);

            document.getElementById('metricCount').innerText = count;
            document.getElementById('metricSum').innerText = sum.toLocaleString(); // Formato número
            document.getElementById('metricAvg').innerText = avg.toFixed(2);
            document.getElementById('metricMax').innerText = max.toLocaleString();
        }

        // 5. Tabla visual simple
        function renderTablePreview(data) {
            const table = document.getElementById('dataTable');
            table.innerHTML = '';
            
            // Headers
            const thead = table.createTHead();
            const row = thead.insertRow();
            Object.keys(data[0]).forEach(key => {
                const th = document.createElement("th");
                th.innerText = key;
                th.className = "px-4 py-2 bg-gray-50 border";
                row.appendChild(th);
            });

            // Body
            const tbody = table.createTBody();
            data.forEach(item => {
                const tr = tbody.insertRow();
                Object.values(item).forEach(val => {
                    const td = tr.insertCell();
                    td.innerText = val;
                    td.className = "px-4 py-2 border";
                });
            });
        }
    </script>
</body>
</html>
