<template id="metrics-tabs-template">
    <nav class="flex bg-slate-100/80 p-1 rounded-xl gap-1 overflow-x-auto hide-scroll flex-1 sm:flex-none">
        <button id="step1" class="step-btn step-active">1. Carga</button>
        <button id="step2" disabled class="step-btn step-inactive step-disabled">2. Fuentes</button>
        <button id="step3" disabled class="step-btn step-inactive step-disabled">3. Dashboard</button>
        <button id="step4" disabled class="step-btn step-inactive step-disabled">4. Unificar</button>
    </nav>
</template>

<div id="view-1" class="flex flex-col flex-1 items-center justify-center p-4 lg:p-6 overflow-y-auto">
    <div class="bg-white p-6 lg:p-10 rounded-2xl shadow-xl border border-slate-200 text-center max-w-lg w-full mt-auto mb-auto">
        <div class="w-16 h-16 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-inner">
            <i class="fas fa-folder-open text-3xl"></i>
        </div>
        <h2 class="text-xl font-bold text-slate-800 mb-2">Comienza tu Análisis</h2>
        <p class="text-slate-500 text-sm mb-8">Sube tus archivos Excel (.xlsx, .csv) para procesar datos.</p>
        
        <label class="block mb-4 group cursor-pointer">
            <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" multiple class="hidden"/>
            <div class="bg-slate-900 text-white px-6 py-4 rounded-xl font-bold shadow-lg shadow-indigo-500/20 group-hover:bg-slate-800 transition flex items-center justify-center gap-3">
                <i class="fas fa-cloud-upload-alt text-lg"></i><span>Seleccionar Archivos</span>
            </div>
        </label>
        <div id="uploadStatus" class="h-5 text-xs font-bold text-indigo-600"></div>
        <button id="btnNext1" class="hidden w-full mt-6 bg-white border-2 border-indigo-600 text-indigo-600 py-3 rounded-xl font-bold hover:bg-indigo-50 transition">Siguiente Paso <i class="fas fa-arrow-right ml-1"></i></button>
    </div>
    <div class="mt-8 mb-auto w-full max-w-lg text-center">
        <button id="btnLoadCloud" class="text-xs text-slate-400 hover:text-indigo-600 font-medium inline-flex items-center gap-2"><i class="fas fa-sync-alt"></i> Cargar proyectos guardados</button>
        <div id="cloudProjectsList" class="mt-4 hidden space-y-2"></div> 
    </div>
</div>

<div id="view-2" class="hidden flex-col lg:flex-row flex-1 h-full overflow-hidden">
    <div class="panel-sidebar">
        <div class="p-4 lg:p-5 border-b border-slate-100"><h3 class="font-bold text-sm text-slate-800">Configuración de Fuente</h3></div>
        <div class="p-4 lg:p-5 flex-none lg:flex-1 lg:overflow-y-auto custom-scroll space-y-4">
            <div><label class="text-[11px] font-bold text-slate-500 uppercase block mb-1">Archivo</label><select id="fileSelector" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded text-sm outline-none"></select></div>
            <div><label class="text-[11px] font-bold text-slate-500 uppercase block mb-1">Hoja</label><select id="sheetSelector" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded text-sm outline-none"></select></div>
            <div><label class="text-[11px] font-bold text-slate-500 uppercase block mb-1">Fila Encabezados</label><input type="number" id="headerRow" value="1" min="1" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded text-center text-sm font-bold"></div>
            <button id="btnSaveSource" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold shadow-md hover:bg-indigo-700 text-sm"><i class="fas fa-check-circle mr-2"></i> Guardar Fuente</button>
            <div class="pt-4 border-t border-slate-100"><h4 class="text-[10px] font-bold text-slate-400 uppercase mb-2">Fuentes Activas</h4><div id="processedSourcesList" class="space-y-2"><p class="text-xs text-slate-300 italic text-center py-2">Ninguna fuente guardada</p></div></div>
        </div>
        <div class="p-4 bg-slate-50 border-t border-slate-200 mt-auto"><button id="btnGoPlayground" disabled class="w-full bg-slate-800 text-white py-3 rounded-lg font-bold text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-slate-700 transition">Ir al Dashboard <i class="fas fa-chevron-right ml-1"></i></button></div>
    </div>
    <div class="panel-content">
        <div class="h-10 bg-white border-b flex items-center px-4 justify-between flex-none"><span class="text-xs font-bold text-slate-500 uppercase"><i class="fas fa-table mr-2"></i> Previsualización</span></div>
        <div class="flex-1 overflow-auto custom-scroll relative bg-white"><table class="excel-table" id="rawTablePreview"></table></div>
    </div>
</div>

<div id="view-3" class="hidden flex-col lg:flex-row flex-1 h-full overflow-hidden">
    <div class="panel-sidebar">
        <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0 z-10"><h3 class="font-bold text-slate-800">Constructor</h3><button id="btnGoAudit" class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded hover:bg-emerald-100 font-bold transition">Comparar <i class="fas fa-arrow-right"></i></button></div>
        <div class="p-4 lg:p-5 flex-none lg:flex-1 lg:overflow-y-auto custom-scroll space-y-4 bg-white">
            <div class="bg-white border rounded-xl p-3 shadow-sm"><label class="text-[10px] text-slate-400 font-bold uppercase mb-1 block">Fuente de Datos</label><select id="dsSelector" class="w-full p-2 text-xs font-bold border rounded outline-none bg-slate-50"></select></div>
            <div class="space-y-3">
                <input type="text" id="widgetTitle" placeholder="Título del Gráfico..." class="w-full p-2 border-b text-sm font-semibold outline-none bg-transparent">
                <div><label class="text-[10px] text-slate-400 font-bold uppercase block mb-1">Agrupar por (Eje X)</label><select id="axisX" class="w-full p-2 text-xs border rounded outline-none column-selector"></select></div>
                <div class="grid grid-cols-2 gap-2">
                    <div><label class="text-[10px] text-slate-400 font-bold uppercase block mb-1">Operación</label><select id="aggType" class="w-full p-2 text-xs border rounded font-medium outline-none"><option value="count">Contar</option><option value="sum">Sumar</option><option value="percent">Porcentaje %</option></select></div>
                    <div><label class="text-[10px] text-slate-400 font-bold uppercase block mb-1">Columna Valor</label><select id="axisY" class="w-full p-2 text-xs border rounded outline-none column-selector"></select></div>
                </div>
                <div id="percentTargetUI" class="hidden bg-yellow-50 p-3 rounded-lg border border-yellow-100"><label class="text-[10px] text-yellow-700 font-bold uppercase block mb-1">Valor "Éxito"</label><div id="percentTargetValue" class="max-h-32 overflow-y-auto custom-scroll bg-white rounded p-1 space-y-1"></div></div>
            </div>
            <div class="border-t border-slate-100 pt-3"><div class="flex justify-between items-center mb-2"><label class="text-[10px] text-slate-400 font-bold uppercase">Filtros Globales</label><button id="btnAddFilter" class="text-[10px] bg-slate-100 px-2 py-0.5 rounded hover:bg-slate-200">+ Añadir</button></div><div id="globalFiltersArea" class="space-y-2"></div></div>
            <div class="grid grid-cols-3 gap-2">
                <button class="chart-btn active p-2 border rounded bg-slate-800 text-white" data-type="bar"><i class="fas fa-chart-bar"></i></button>
                <button class="chart-btn p-2 border rounded hover:bg-slate-50 text-slate-600" data-type="line"><i class="fas fa-chart-line"></i></button>
                <button class="chart-btn p-2 border rounded hover:bg-slate-50 text-slate-600" data-type="doughnut"><i class="fas fa-chart-pie"></i></button>
                <input type="hidden" id="selectedChartType" value="bar">
            </div>
            <button id="btnBuildWidget" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold shadow-lg hover:bg-indigo-700 active:scale-95 transition mt-4 mb-2">Generar Gráfico</button>
        </div>
        <div class="p-3 bg-slate-900 border-t border-slate-800 mt-auto flex-none"><div class="flex gap-2"><input type="text" id="projectName3" placeholder="Nombre Proyecto..." class="flex-1 bg-slate-800 border-none rounded text-xs text-white p-2 outline-none"><button class="btnSaveCloud text-xs bg-indigo-500 text-white px-3 rounded font-bold hover:bg-indigo-400">Guardar</button></div></div>
    </div>
    <div class="panel-content p-4 lg:p-6 lg:overflow-y-auto custom-scroll bg-slate-50" id="canvasArea3">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-2"><h2 class="text-xl font-bold text-slate-800">Tablero de Resultados</h2><span class="text-xs text-slate-400 bg-slate-100 px-2 py-1 rounded"><i class="fas fa-info-circle"></i> Toca un gráfico para ver los datos</span></div>
        <div id="widgetsGrid" class="grid grid-cols-1 md:grid-cols-2 2xl:grid-cols-3 gap-6 pb-20"><div id="emptyLocal" class="col-span-full h-[400px] border-2 border-dashed border-slate-300 rounded-2xl flex flex-col items-center justify-center text-slate-400 bg-slate-50/50"><i class="fas fa-chart-column text-4xl mb-3 opacity-50"></i><p class="text-sm font-medium">Configura los parámetros a la izquierda</p></div></div>
    </div>
</div>

<div id="view-4" class="hidden flex-col lg:flex-row flex-1 h-full overflow-hidden">
    <div class="panel-sidebar">
        <div class="p-4 border-b border-slate-100 bg-emerald-50/50 sticky top-0 z-10"><h3 class="font-bold text-emerald-900">Unificar y Comparar</h3></div>
        <div class="p-4 lg:p-5 flex-none lg:flex-1 lg:overflow-y-auto custom-scroll space-y-4 bg-white">
            <div class="flex bg-slate-100 p-1 rounded-lg">
                <label class="flex-1 text-center cursor-pointer"><input type="radio" name="auditMode" value="merge" class="hidden peer" checked><span class="block py-2 text-[10px] font-bold text-slate-500 rounded peer-checked:bg-white peer-checked:text-emerald-600 shadow-sm uppercase">Suma Total</span></label>
                <label class="flex-1 text-center cursor-pointer"><input type="radio" name="auditMode" value="compare" class="hidden peer"><span class="block py-2 text-[10px] font-bold text-slate-500 rounded peer-checked:bg-white peer-checked:text-blue-600 shadow-sm uppercase">Comparar Grupos</span></label>
            </div>
            <input type="text" id="auditTitle" placeholder="Título del Reporte..." class="w-full p-2.5 border rounded-lg text-sm font-semibold outline-none">
            <div class="grid grid-cols-2 gap-2">
                <div><label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Métrica</label><select id="auditAggType" class="w-full p-2 border rounded-lg text-xs font-bold outline-none"><option value="percent">Porcentaje (%)</option><option value="sum">Sumatoria</option><option value="count">Contar</option></select></div>
                <div><label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Visual</label><select id="auditChartType" class="w-full p-2 border rounded-lg text-xs font-bold outline-none"><option value="bar">Barras</option><option value="line">Línea</option></select></div>
            </div>
            <div id="auditMappingContainer" class="space-y-4 pt-2"></div>
            <button id="btnGenerateAudit" class="w-full bg-emerald-600 text-white py-3 rounded-lg font-bold shadow-lg hover:bg-emerald-700 active:scale-95 transition mt-4 mb-2">GENERAR REPORTE</button>
        </div>
        <div class="p-3 bg-slate-900 border-t border-slate-800 mt-auto flex-none"><div class="flex gap-2"><input type="text" id="projectName4" placeholder="Nombre Proyecto..." class="flex-1 bg-slate-800 border-none rounded text-xs text-white p-2 outline-none"><button class="btnSaveCloud text-xs bg-indigo-500 text-white px-3 rounded font-bold hover:bg-indigo-400 transition">Guardar</button></div></div>
    </div>
    <div class="panel-content p-4 lg:p-6 lg:overflow-y-auto custom-scroll" id="canvasArea4">
        <h2 class="text-xl font-bold text-slate-800 mb-6">Reportes Unificados / Comparativas</h2>
        <div id="auditWidgetsGrid" class="grid grid-cols-1 xl:grid-cols-2 gap-6 pb-20"><div id="emptyAudit" class="col-span-full h-[400px] border-2 border-dashed border-slate-300 rounded-2xl flex flex-col items-center justify-center text-slate-400 bg-slate-50/50"><i class="fas fa-network-wired text-4xl mb-3 opacity-50"></i><p class="text-sm font-medium text-center px-4">Configura el cruce de datos a la izquierda.</p></div></div>
    </div>
</div>
